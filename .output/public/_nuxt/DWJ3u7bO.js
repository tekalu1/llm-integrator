import{_ as J}from"./BcW51KGl.js";import{d as j,r,a4 as Q,v as n,x as a,y as t,A as O,B as $,L as i,z as u,S as N,T as R,U as q,M as G,O as m,P as v,Q as W,C as P}from"./JqZd4KxG.js";import{C as H}from"./UP5ODb_V.js";import{u as X}from"./C-5zPJiT.js";import{u as Y}from"./D-sMymdb.js";import"./DvF23Exx.js";import"./BcTueDZh.js";import"./IShi1APO.js";const Z={class:"m-2 p-1"},ee={class:"relative h-[40vh]"},te={class:"flex flex-wrap"},oe=["onClick"],se={class:"flex items-center justify-center"},re={class:"flex-grow"},ne={class:"flex-grow overflow-hidden text-ellipsis"},ae={class:"bg-purple-500 text-white px-1 rounded-md"},le={class:"m-2 p-1"},ie={class:"relative h-[20vh] mb-2"},ue={class:"bg-purple-500 text-white px-1 rounded-md"},ce={key:0},de={class:"border border-black m-2 p-1"},me={key:0},ke=j({__name:"index",async setup(pe){let k,b;const l=X(),p=r(""),w=r(""),S=Y(),V=(e,o)=>{p.value=e,w.value=o},C=r(),F=async()=>{if(await l.fetchUser(),!l.user)throw new Error("no userId");const e=await $fetch("/api/rag/get-document-list",{method:"POST",body:{userId:l.user.id}});if(e.error)throw new Error(e.error.message);C.value=JSON.parse(JSON.stringify(e))},y=r([]),I=async()=>{try{await F(),y.value=[];for(const e of C.value){console.log("document : "+JSON.stringify(e));const o=await $fetch("/api/rag/get-document-meta-data",{method:"POST",body:{userId:l.user.id,documentId:e.documentId,version:e.version}});if(e.error)throw new Error(e.error.message);y.value.push({documentId:e.documentId,version:e.version,name:o.documentName,metaData:o.metaData})}}catch(e){console.error(e.message)}};[k,b]=Q(()=>I()),await k,b();const U=new H({chunkSize:100,chunkOverlap:0}),x=r([]),f=r(null),D=r(""),z=r(null),B=async()=>{x.value=await U.splitText(D.value)},L=async e=>{if(e?.preventDefault(),console.log("Form submitted"),!f.value||!f.value.files.length){alert("Please select a file.");return}const o=f.value.files[0],c=new FormData;c.append("file",o);try{const s=await $fetch("/api/convert-to-markdown-v2",{method:"POST",body:c});s.error?console.error(s.error):(D.value=s.markdown,await B())}catch(s){console.error("Error:",s)}};r("");const _=r(null);async function K(){try{if(await l.fetchUser(),!l.user)throw new Error("Error upserting chunks: no userId");const e=x.value,o=await $fetch("/api/rag/upsert-chunks",{method:"POST",body:{apiKey:S.masterFlow.variables.openAiApiKey,chunks:e,userId:l.user.id}});_.value=o.upserted,await I()}catch(e){throw new Error("Error upserting chunks:"+e.message)}}const h=r(""),g=r(""),E=r([]);async function M(){try{if(await l.fetchUser(),!l.user)throw new Error("no userId");if(p.value==="")throw new Error("no selectedDocumentId");if(w.value==="")throw new Error("no selectedVersion");const e=await $fetch("/api/rag/execute",{method:"POST",body:{apiKey:S.masterFlow.variables.openAiApiKey,query:h.value,userId:l.user.id,documentId:p.value,version:w.value}});g.value=e.answer,E.value=e.context}catch(e){console.error(e)}}return(e,o)=>{const c=J;return n(),a(m,null,[t("div",Z,[o[1]||(o[1]=t("h1",{class:"text-sm"}," 登録済みのノウハウ ",-1)),t("div",ee,[O(c,{class:"h-full flex flex-col"},{default:$(()=>[t("div",te,[(n(!0),a(m,null,v(i(y),(s,d)=>(n(),a("div",{key:s.documentId,class:W(["lg:w-1/6 w-1/3 h-64 bg-white border-gray-300 m-2 p-2 rounded-md flex flex-col items-start justify-center transition-all duration-150",i(p)===s.documentId?"outline outline-blue-500":"outline-none"]),onClick:T=>V(s.documentId,s.version)},[t("div",se,[t("h1",re,u(s.name),1)]),t("div",ne,[(n(!0),a(m,null,v(s.metaData,(T,A)=>(n(),a("div",{key:A,class:"mb-2 p-1 rounded-md bg-gray-200"},[t("span",ae,u(`#chank-${A+1}`),1),P(" "+u(T),1)]))),128))])],10,oe))),128))])]),_:1})])]),t("div",le,[o[2]||(o[2]=t("h1",{class:"text-sm"},"登録",-1)),t("form",{ref_key:"formElement",ref:z,class:"flex flex-col"},[t("input",{type:"file",ref_key:"fileInput",ref:f,accept:".pdf,.txt,.docx",class:"mb-2"},null,512),t("div",{class:"mb-2"},[t("button",{class:"bg-blue-500 rounded-md px-2 py-1 relative z-0 overflow-hidden text-white",onClick:L}," チャンクに変換 ")])],512),t("div",ie,[O(c,{class:"h-full flex flex-col p-2"},{default:$(()=>[(n(!0),a(m,null,v(i(x),(s,d)=>(n(),a("div",{key:d,class:"mb-2 p-1 rounded-md bg-gray-200"},[t("span",ue,u(`#chank-${d+1}`),1),P(" "+u(s),1)]))),128))]),_:1})]),t("div",null,[t("button",{onClick:K,class:"bg-blue-500 transit duration-200 rounded-md px-2 py-1 relative z-0 overflow-hidden text-white"}," 登録 "),i(_)!==null?(n(),a("p",ce," 結果：Upserted "+u(i(_))+" chunks! ",1)):N("",!0)])]),t("div",de,[o[5]||(o[5]=t("h1",null,"RAG Demo",-1)),R(t("input",{"onUpdate:modelValue":o[0]||(o[0]=s=>G(h)?h.value=s:null),placeholder:"質問を入力"},null,512),[[q,i(h)]]),t("button",{onClick:M},"Ask"),i(g)?(n(),a("div",me,[o[3]||(o[3]=t("h2",null,"回答",-1)),t("p",null,u(i(g)),1),o[4]||(o[4]=t("h3",null,"参照コンテキスト",-1)),t("ul",null,[(n(!0),a(m,null,v(i(E),(s,d)=>(n(),a("li",{key:d},u(s),1))),128))])])):N("",!0)])],64)}}});export{ke as default};
