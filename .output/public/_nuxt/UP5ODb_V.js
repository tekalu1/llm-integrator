import{v as ue}from"./DvF23Exx.js";const Is=/^(?:[0-9a-f]{8}-[0-9a-f]{4}-[1-8][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}|00000000-0000-0000-0000-000000000000|ffffffff-ffff-ffff-ffff-ffffffffffff)$/i;function St(n){return typeof n=="string"&&Is.test(n)}class $s{constructor(e){Object.defineProperty(this,"pageContent",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"metadata",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"id",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.pageContent=e.pageContent!==void 0?e.pageContent.toString():"",this.metadata=e.metadata??{},this.id=e.id}}var B;(function(n){n.assertEqual=a=>a;function e(a){}n.assertIs=e;function t(a){throw new Error}n.assertNever=t,n.arrayToEnum=a=>{const s={};for(const i of a)s[i]=i;return s},n.getValidEnumValues=a=>{const s=n.objectKeys(a).filter(o=>typeof a[a[o]]!="number"),i={};for(const o of s)i[o]=a[o];return n.objectValues(i)},n.objectValues=a=>n.objectKeys(a).map(function(s){return a[s]}),n.objectKeys=typeof Object.keys=="function"?a=>Object.keys(a):a=>{const s=[];for(const i in a)Object.prototype.hasOwnProperty.call(a,i)&&s.push(i);return s},n.find=(a,s)=>{for(const i of a)if(s(i))return i},n.isInteger=typeof Number.isInteger=="function"?a=>Number.isInteger(a):a=>typeof a=="number"&&isFinite(a)&&Math.floor(a)===a;function r(a,s=" | "){return a.map(i=>typeof i=="string"?`'${i}'`:i).join(s)}n.joinValues=r,n.jsonStringifyReplacer=(a,s)=>typeof s=="bigint"?s.toString():s})(B||(B={}));var tn;(function(n){n.mergeShapes=(e,t)=>({...e,...t})})(tn||(tn={}));const E=B.arrayToEnum(["string","nan","number","integer","float","boolean","date","bigint","symbol","function","undefined","null","array","object","unknown","promise","void","never","map","set"]),Ne=n=>{switch(typeof n){case"undefined":return E.undefined;case"string":return E.string;case"number":return isNaN(n)?E.nan:E.number;case"boolean":return E.boolean;case"function":return E.function;case"bigint":return E.bigint;case"symbol":return E.symbol;case"object":return Array.isArray(n)?E.array:n===null?E.null:n.then&&typeof n.then=="function"&&n.catch&&typeof n.catch=="function"?E.promise:typeof Map<"u"&&n instanceof Map?E.map:typeof Set<"u"&&n instanceof Set?E.set:typeof Date<"u"&&n instanceof Date?E.date:E.object;default:return E.unknown}},g=B.arrayToEnum(["invalid_type","invalid_literal","custom","invalid_union","invalid_union_discriminator","invalid_enum_value","unrecognized_keys","invalid_arguments","invalid_return_type","invalid_date","invalid_string","too_small","too_big","invalid_intersection_types","not_multiple_of","not_finite"]),As=n=>JSON.stringify(n,null,2).replace(/"([^"]+)":/g,"$1:");class he extends Error{get errors(){return this.issues}constructor(e){super(),this.issues=[],this.addIssue=r=>{this.issues=[...this.issues,r]},this.addIssues=(r=[])=>{this.issues=[...this.issues,...r]};const t=new.target.prototype;Object.setPrototypeOf?Object.setPrototypeOf(this,t):this.__proto__=t,this.name="ZodError",this.issues=e}format(e){const t=e||function(s){return s.message},r={_errors:[]},a=s=>{for(const i of s.issues)if(i.code==="invalid_union")i.unionErrors.map(a);else if(i.code==="invalid_return_type")a(i.returnTypeError);else if(i.code==="invalid_arguments")a(i.argumentsError);else if(i.path.length===0)r._errors.push(t(i));else{let o=r,u=0;for(;u<i.path.length;){const c=i.path[u];u===i.path.length-1?(o[c]=o[c]||{_errors:[]},o[c]._errors.push(t(i))):o[c]=o[c]||{_errors:[]},o=o[c],u++}}};return a(this),r}static assert(e){if(!(e instanceof he))throw new Error(`Not a ZodError: ${e}`)}toString(){return this.message}get message(){return JSON.stringify(this.issues,B.jsonStringifyReplacer,2)}get isEmpty(){return this.issues.length===0}flatten(e=t=>t.message){const t={},r=[];for(const a of this.issues)a.path.length>0?(t[a.path[0]]=t[a.path[0]]||[],t[a.path[0]].push(e(a))):r.push(e(a));return{formErrors:r,fieldErrors:t}}get formErrors(){return this.flatten()}}he.create=n=>new he(n);const dt=(n,e)=>{let t;switch(n.code){case g.invalid_type:n.received===E.undefined?t="Required":t=`Expected ${n.expected}, received ${n.received}`;break;case g.invalid_literal:t=`Invalid literal value, expected ${JSON.stringify(n.expected,B.jsonStringifyReplacer)}`;break;case g.unrecognized_keys:t=`Unrecognized key(s) in object: ${B.joinValues(n.keys,", ")}`;break;case g.invalid_union:t="Invalid input";break;case g.invalid_union_discriminator:t=`Invalid discriminator value. Expected ${B.joinValues(n.options)}`;break;case g.invalid_enum_value:t=`Invalid enum value. Expected ${B.joinValues(n.options)}, received '${n.received}'`;break;case g.invalid_arguments:t="Invalid function arguments";break;case g.invalid_return_type:t="Invalid function return type";break;case g.invalid_date:t="Invalid date";break;case g.invalid_string:typeof n.validation=="object"?"includes"in n.validation?(t=`Invalid input: must include "${n.validation.includes}"`,typeof n.validation.position=="number"&&(t=`${t} at one or more positions greater than or equal to ${n.validation.position}`)):"startsWith"in n.validation?t=`Invalid input: must start with "${n.validation.startsWith}"`:"endsWith"in n.validation?t=`Invalid input: must end with "${n.validation.endsWith}"`:B.assertNever(n.validation):n.validation!=="regex"?t=`Invalid ${n.validation}`:t="Invalid";break;case g.too_small:n.type==="array"?t=`Array must contain ${n.exact?"exactly":n.inclusive?"at least":"more than"} ${n.minimum} element(s)`:n.type==="string"?t=`String must contain ${n.exact?"exactly":n.inclusive?"at least":"over"} ${n.minimum} character(s)`:n.type==="number"?t=`Number must be ${n.exact?"exactly equal to ":n.inclusive?"greater than or equal to ":"greater than "}${n.minimum}`:n.type==="date"?t=`Date must be ${n.exact?"exactly equal to ":n.inclusive?"greater than or equal to ":"greater than "}${new Date(Number(n.minimum))}`:t="Invalid input";break;case g.too_big:n.type==="array"?t=`Array must contain ${n.exact?"exactly":n.inclusive?"at most":"less than"} ${n.maximum} element(s)`:n.type==="string"?t=`String must contain ${n.exact?"exactly":n.inclusive?"at most":"under"} ${n.maximum} character(s)`:n.type==="number"?t=`Number must be ${n.exact?"exactly":n.inclusive?"less than or equal to":"less than"} ${n.maximum}`:n.type==="bigint"?t=`BigInt must be ${n.exact?"exactly":n.inclusive?"less than or equal to":"less than"} ${n.maximum}`:n.type==="date"?t=`Date must be ${n.exact?"exactly":n.inclusive?"smaller than or equal to":"smaller than"} ${new Date(Number(n.maximum))}`:t="Invalid input";break;case g.custom:t="Invalid input";break;case g.invalid_intersection_types:t="Intersection results could not be merged";break;case g.not_multiple_of:t=`Number must be a multiple of ${n.multipleOf}`;break;case g.not_finite:t="Number must be finite";break;default:t=e.defaultError,B.assertNever(n)}return{message:t}};let xa=dt;function Rs(n){xa=n}function nr(){return xa}const ar=n=>{const{data:e,path:t,errorMaps:r,issueData:a}=n,s=[...t,...a.path||[]],i={...a,path:s};if(a.message!==void 0)return{...a,path:s,message:a.message};let o="";const u=r.filter(c=>!!c).slice().reverse();for(const c of u)o=c(i,{data:e,defaultError:o}).message;return{...a,path:s,message:o}},xs=[];function w(n,e){const t=nr(),r=ar({issueData:e,data:n.data,path:n.path,errorMaps:[n.common.contextualErrorMap,n.schemaErrorMap,t,t===dt?void 0:dt].filter(a=>!!a)});n.common.issues.push(r)}class te{constructor(){this.value="valid"}dirty(){this.value==="valid"&&(this.value="dirty")}abort(){this.value!=="aborted"&&(this.value="aborted")}static mergeArray(e,t){const r=[];for(const a of t){if(a.status==="aborted")return x;a.status==="dirty"&&e.dirty(),r.push(a.value)}return{status:e.value,value:r}}static async mergeObjectAsync(e,t){const r=[];for(const a of t){const s=await a.key,i=await a.value;r.push({key:s,value:i})}return te.mergeObjectSync(e,r)}static mergeObjectSync(e,t){const r={};for(const a of t){const{key:s,value:i}=a;if(s.status==="aborted"||i.status==="aborted")return x;s.status==="dirty"&&e.dirty(),i.status==="dirty"&&e.dirty(),s.value!=="__proto__"&&(typeof i.value<"u"||a.alwaysSet)&&(r[s.value]=i.value)}return{status:e.value,value:r}}}const x=Object.freeze({status:"aborted"}),ot=n=>({status:"dirty",value:n}),se=n=>({status:"valid",value:n}),rn=n=>n.status==="aborted",nn=n=>n.status==="dirty",et=n=>n.status==="valid",At=n=>typeof Promise<"u"&&n instanceof Promise;function sr(n,e,t,r){if(typeof e=="function"?n!==e||!r:!e.has(n))throw new TypeError("Cannot read private member from an object whose class did not declare it");return e.get(n)}function Ca(n,e,t,r,a){if(typeof e=="function"?n!==e||!a:!e.has(n))throw new TypeError("Cannot write private member to an object whose class did not declare it");return e.set(n,t),t}var T;(function(n){n.errToObj=e=>typeof e=="string"?{message:e}:e||{},n.toString=e=>typeof e=="string"?e:e?.message})(T||(T={}));var Et,Ot;class Re{constructor(e,t,r,a){this._cachedPath=[],this.parent=e,this.data=t,this._path=r,this._key=a}get path(){return this._cachedPath.length||(this._key instanceof Array?this._cachedPath.push(...this._path,...this._key):this._cachedPath.push(...this._path,this._key)),this._cachedPath}}const Nn=(n,e)=>{if(et(e))return{success:!0,data:e.value};if(!n.common.issues.length)throw new Error("Validation failed but no issues detected.");return{success:!1,get error(){if(this._error)return this._error;const t=new he(n.common.issues);return this._error=t,this._error}}};function N(n){if(!n)return{};const{errorMap:e,invalid_type_error:t,required_error:r,description:a}=n;if(e&&(t||r))throw new Error(`Can't use "invalid_type_error" or "required_error" in conjunction with custom error map.`);return e?{errorMap:e,description:a}:{errorMap:(i,o)=>{var u,c;const{message:l}=n;return i.code==="invalid_enum_value"?{message:l??o.defaultError}:typeof o.data>"u"?{message:(u=l??r)!==null&&u!==void 0?u:o.defaultError}:i.code!=="invalid_type"?{message:o.defaultError}:{message:(c=l??t)!==null&&c!==void 0?c:o.defaultError}},description:a}}class M{get description(){return this._def.description}_getType(e){return Ne(e.data)}_getOrReturnCtx(e,t){return t||{common:e.parent.common,data:e.data,parsedType:Ne(e.data),schemaErrorMap:this._def.errorMap,path:e.path,parent:e.parent}}_processInputParams(e){return{status:new te,ctx:{common:e.parent.common,data:e.data,parsedType:Ne(e.data),schemaErrorMap:this._def.errorMap,path:e.path,parent:e.parent}}}_parseSync(e){const t=this._parse(e);if(At(t))throw new Error("Synchronous parse encountered promise.");return t}_parseAsync(e){const t=this._parse(e);return Promise.resolve(t)}parse(e,t){const r=this.safeParse(e,t);if(r.success)return r.data;throw r.error}safeParse(e,t){var r;const a={common:{issues:[],async:(r=t?.async)!==null&&r!==void 0?r:!1,contextualErrorMap:t?.errorMap},path:t?.path||[],schemaErrorMap:this._def.errorMap,parent:null,data:e,parsedType:Ne(e)},s=this._parseSync({data:e,path:a.path,parent:a});return Nn(a,s)}"~validate"(e){var t,r;const a={common:{issues:[],async:!!this["~standard"].async},path:[],schemaErrorMap:this._def.errorMap,parent:null,data:e,parsedType:Ne(e)};if(!this["~standard"].async)try{const s=this._parseSync({data:e,path:[],parent:a});return et(s)?{value:s.value}:{issues:a.common.issues}}catch(s){!((r=(t=s?.message)===null||t===void 0?void 0:t.toLowerCase())===null||r===void 0)&&r.includes("encountered")&&(this["~standard"].async=!0),a.common={issues:[],async:!0}}return this._parseAsync({data:e,path:[],parent:a}).then(s=>et(s)?{value:s.value}:{issues:a.common.issues})}async parseAsync(e,t){const r=await this.safeParseAsync(e,t);if(r.success)return r.data;throw r.error}async safeParseAsync(e,t){const r={common:{issues:[],contextualErrorMap:t?.errorMap,async:!0},path:t?.path||[],schemaErrorMap:this._def.errorMap,parent:null,data:e,parsedType:Ne(e)},a=this._parse({data:e,path:r.path,parent:r}),s=await(At(a)?a:Promise.resolve(a));return Nn(r,s)}refine(e,t){const r=a=>typeof t=="string"||typeof t>"u"?{message:t}:typeof t=="function"?t(a):t;return this._refinement((a,s)=>{const i=e(a),o=()=>s.addIssue({code:g.custom,...r(a)});return typeof Promise<"u"&&i instanceof Promise?i.then(u=>u?!0:(o(),!1)):i?!0:(o(),!1)})}refinement(e,t){return this._refinement((r,a)=>e(r)?!0:(a.addIssue(typeof t=="function"?t(r,a):t),!1))}_refinement(e){return new Te({schema:this,typeName:y.ZodEffects,effect:{type:"refinement",refinement:e}})}superRefine(e){return this._refinement(e)}constructor(e){this.spa=this.safeParseAsync,this._def=e,this.parse=this.parse.bind(this),this.safeParse=this.safeParse.bind(this),this.parseAsync=this.parseAsync.bind(this),this.safeParseAsync=this.safeParseAsync.bind(this),this.spa=this.spa.bind(this),this.refine=this.refine.bind(this),this.refinement=this.refinement.bind(this),this.superRefine=this.superRefine.bind(this),this.optional=this.optional.bind(this),this.nullable=this.nullable.bind(this),this.nullish=this.nullish.bind(this),this.array=this.array.bind(this),this.promise=this.promise.bind(this),this.or=this.or.bind(this),this.and=this.and.bind(this),this.transform=this.transform.bind(this),this.brand=this.brand.bind(this),this.default=this.default.bind(this),this.catch=this.catch.bind(this),this.describe=this.describe.bind(this),this.pipe=this.pipe.bind(this),this.readonly=this.readonly.bind(this),this.isNullable=this.isNullable.bind(this),this.isOptional=this.isOptional.bind(this),this["~standard"]={version:1,vendor:"zod",validate:t=>this["~validate"](t)}}optional(){return Oe.create(this,this._def)}nullable(){return Ve.create(this,this._def)}nullish(){return this.nullable().optional()}array(){return Ee.create(this)}promise(){return ft.create(this,this._def)}or(e){return Pt.create([this,e],this._def)}and(e){return Nt.create(this,e,this._def)}transform(e){return new Te({...N(this._def),schema:this,typeName:y.ZodEffects,effect:{type:"transform",transform:e}})}default(e){const t=typeof e=="function"?e:()=>e;return new Ft({...N(this._def),innerType:this,defaultValue:t,typeName:y.ZodDefault})}brand(){return new gn({typeName:y.ZodBranded,type:this,...N(this._def)})}catch(e){const t=typeof e=="function"?e:()=>e;return new Ut({...N(this._def),innerType:this,catchValue:t,typeName:y.ZodCatch})}describe(e){const t=this.constructor;return new t({...this._def,description:e})}pipe(e){return zt.create(this,e)}readonly(){return Bt.create(this)}isOptional(){return this.safeParse(void 0).success}isNullable(){return this.safeParse(null).success}}const Cs=/^c[^\s-]{8,}$/i,Ps=/^[0-9a-z]+$/,Ns=/^[0-9A-HJKMNP-TV-Z]{26}$/i,js=/^[0-9a-fA-F]{8}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{12}$/i,Ls=/^[a-z0-9_-]{21}$/i,Ms=/^[A-Za-z0-9-_]+\.[A-Za-z0-9-_]+\.[A-Za-z0-9-_]*$/,Ds=/^[-+]?P(?!$)(?:(?:[-+]?\d+Y)|(?:[-+]?\d+[.,]\d+Y$))?(?:(?:[-+]?\d+M)|(?:[-+]?\d+[.,]\d+M$))?(?:(?:[-+]?\d+W)|(?:[-+]?\d+[.,]\d+W$))?(?:(?:[-+]?\d+D)|(?:[-+]?\d+[.,]\d+D$))?(?:T(?=[\d+-])(?:(?:[-+]?\d+H)|(?:[-+]?\d+[.,]\d+H$))?(?:(?:[-+]?\d+M)|(?:[-+]?\d+[.,]\d+M$))?(?:[-+]?\d+(?:[.,]\d+)?S)?)??$/,Fs=/^(?!\.)(?!.*\.\.)([A-Z0-9_'+\-\.]*)[A-Z0-9_+-]@([A-Z0-9][A-Z0-9\-]*\.)+[A-Z]{2,}$/i,Us="^(\\p{Extended_Pictographic}|\\p{Emoji_Component})+$";let Nr;const Bs=/^(?:(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])$/,Zs=/^(?:(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\/(3[0-2]|[12]?[0-9])$/,Hs=/^(([0-9a-fA-F]{1,4}:){7,7}[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,7}:|([0-9a-fA-F]{1,4}:){1,6}:[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,5}(:[0-9a-fA-F]{1,4}){1,2}|([0-9a-fA-F]{1,4}:){1,4}(:[0-9a-fA-F]{1,4}){1,3}|([0-9a-fA-F]{1,4}:){1,3}(:[0-9a-fA-F]{1,4}){1,4}|([0-9a-fA-F]{1,4}:){1,2}(:[0-9a-fA-F]{1,4}){1,5}|[0-9a-fA-F]{1,4}:((:[0-9a-fA-F]{1,4}){1,6})|:((:[0-9a-fA-F]{1,4}){1,7}|:)|fe80:(:[0-9a-fA-F]{0,4}){0,4}%[0-9a-zA-Z]{1,}|::(ffff(:0{1,4}){0,1}:){0,1}((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])|([0-9a-fA-F]{1,4}:){1,4}:((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9]))$/,Gs=/^(([0-9a-fA-F]{1,4}:){7,7}[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,7}:|([0-9a-fA-F]{1,4}:){1,6}:[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,5}(:[0-9a-fA-F]{1,4}){1,2}|([0-9a-fA-F]{1,4}:){1,4}(:[0-9a-fA-F]{1,4}){1,3}|([0-9a-fA-F]{1,4}:){1,3}(:[0-9a-fA-F]{1,4}){1,4}|([0-9a-fA-F]{1,4}:){1,2}(:[0-9a-fA-F]{1,4}){1,5}|[0-9a-fA-F]{1,4}:((:[0-9a-fA-F]{1,4}){1,6})|:((:[0-9a-fA-F]{1,4}){1,7}|:)|fe80:(:[0-9a-fA-F]{0,4}){0,4}%[0-9a-zA-Z]{1,}|::(ffff(:0{1,4}){0,1}:){0,1}((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])|([0-9a-fA-F]{1,4}:){1,4}:((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9]))\/(12[0-8]|1[01][0-9]|[1-9]?[0-9])$/,zs=/^([0-9a-zA-Z+/]{4})*(([0-9a-zA-Z+/]{2}==)|([0-9a-zA-Z+/]{3}=))?$/,Vs=/^([0-9a-zA-Z-_]{4})*(([0-9a-zA-Z-_]{2}(==)?)|([0-9a-zA-Z-_]{3}(=)?))?$/,Pa="((\\d\\d[2468][048]|\\d\\d[13579][26]|\\d\\d0[48]|[02468][048]00|[13579][26]00)-02-29|\\d{4}-((0[13578]|1[02])-(0[1-9]|[12]\\d|3[01])|(0[469]|11)-(0[1-9]|[12]\\d|30)|(02)-(0[1-9]|1\\d|2[0-8])))",qs=new RegExp(`^${Pa}$`);function Na(n){let e="([01]\\d|2[0-3]):[0-5]\\d:[0-5]\\d";return n.precision?e=`${e}\\.\\d{${n.precision}}`:n.precision==null&&(e=`${e}(\\.\\d+)?`),e}function Ws(n){return new RegExp(`^${Na(n)}$`)}function ja(n){let e=`${Pa}T${Na(n)}`;const t=[];return t.push(n.local?"Z?":"Z"),n.offset&&t.push("([+-]\\d{2}:?\\d{2})"),e=`${e}(${t.join("|")})`,new RegExp(`^${e}$`)}function Js(n,e){return!!((e==="v4"||!e)&&Bs.test(n)||(e==="v6"||!e)&&Hs.test(n))}function Xs(n,e){if(!Ms.test(n))return!1;try{const[t]=n.split("."),r=t.replace(/-/g,"+").replace(/_/g,"/").padEnd(t.length+(4-t.length%4)%4,"="),a=JSON.parse(atob(r));return!(typeof a!="object"||a===null||!a.typ||!a.alg||e&&a.alg!==e)}catch{return!1}}function Ks(n,e){return!!((e==="v4"||!e)&&Zs.test(n)||(e==="v6"||!e)&&Gs.test(n))}class we extends M{_parse(e){if(this._def.coerce&&(e.data=String(e.data)),this._getType(e)!==E.string){const s=this._getOrReturnCtx(e);return w(s,{code:g.invalid_type,expected:E.string,received:s.parsedType}),x}const r=new te;let a;for(const s of this._def.checks)if(s.kind==="min")e.data.length<s.value&&(a=this._getOrReturnCtx(e,a),w(a,{code:g.too_small,minimum:s.value,type:"string",inclusive:!0,exact:!1,message:s.message}),r.dirty());else if(s.kind==="max")e.data.length>s.value&&(a=this._getOrReturnCtx(e,a),w(a,{code:g.too_big,maximum:s.value,type:"string",inclusive:!0,exact:!1,message:s.message}),r.dirty());else if(s.kind==="length"){const i=e.data.length>s.value,o=e.data.length<s.value;(i||o)&&(a=this._getOrReturnCtx(e,a),i?w(a,{code:g.too_big,maximum:s.value,type:"string",inclusive:!0,exact:!0,message:s.message}):o&&w(a,{code:g.too_small,minimum:s.value,type:"string",inclusive:!0,exact:!0,message:s.message}),r.dirty())}else if(s.kind==="email")Fs.test(e.data)||(a=this._getOrReturnCtx(e,a),w(a,{validation:"email",code:g.invalid_string,message:s.message}),r.dirty());else if(s.kind==="emoji")Nr||(Nr=new RegExp(Us,"u")),Nr.test(e.data)||(a=this._getOrReturnCtx(e,a),w(a,{validation:"emoji",code:g.invalid_string,message:s.message}),r.dirty());else if(s.kind==="uuid")js.test(e.data)||(a=this._getOrReturnCtx(e,a),w(a,{validation:"uuid",code:g.invalid_string,message:s.message}),r.dirty());else if(s.kind==="nanoid")Ls.test(e.data)||(a=this._getOrReturnCtx(e,a),w(a,{validation:"nanoid",code:g.invalid_string,message:s.message}),r.dirty());else if(s.kind==="cuid")Cs.test(e.data)||(a=this._getOrReturnCtx(e,a),w(a,{validation:"cuid",code:g.invalid_string,message:s.message}),r.dirty());else if(s.kind==="cuid2")Ps.test(e.data)||(a=this._getOrReturnCtx(e,a),w(a,{validation:"cuid2",code:g.invalid_string,message:s.message}),r.dirty());else if(s.kind==="ulid")Ns.test(e.data)||(a=this._getOrReturnCtx(e,a),w(a,{validation:"ulid",code:g.invalid_string,message:s.message}),r.dirty());else if(s.kind==="url")try{new URL(e.data)}catch{a=this._getOrReturnCtx(e,a),w(a,{validation:"url",code:g.invalid_string,message:s.message}),r.dirty()}else s.kind==="regex"?(s.regex.lastIndex=0,s.regex.test(e.data)||(a=this._getOrReturnCtx(e,a),w(a,{validation:"regex",code:g.invalid_string,message:s.message}),r.dirty())):s.kind==="trim"?e.data=e.data.trim():s.kind==="includes"?e.data.includes(s.value,s.position)||(a=this._getOrReturnCtx(e,a),w(a,{code:g.invalid_string,validation:{includes:s.value,position:s.position},message:s.message}),r.dirty()):s.kind==="toLowerCase"?e.data=e.data.toLowerCase():s.kind==="toUpperCase"?e.data=e.data.toUpperCase():s.kind==="startsWith"?e.data.startsWith(s.value)||(a=this._getOrReturnCtx(e,a),w(a,{code:g.invalid_string,validation:{startsWith:s.value},message:s.message}),r.dirty()):s.kind==="endsWith"?e.data.endsWith(s.value)||(a=this._getOrReturnCtx(e,a),w(a,{code:g.invalid_string,validation:{endsWith:s.value},message:s.message}),r.dirty()):s.kind==="datetime"?ja(s).test(e.data)||(a=this._getOrReturnCtx(e,a),w(a,{code:g.invalid_string,validation:"datetime",message:s.message}),r.dirty()):s.kind==="date"?qs.test(e.data)||(a=this._getOrReturnCtx(e,a),w(a,{code:g.invalid_string,validation:"date",message:s.message}),r.dirty()):s.kind==="time"?Ws(s).test(e.data)||(a=this._getOrReturnCtx(e,a),w(a,{code:g.invalid_string,validation:"time",message:s.message}),r.dirty()):s.kind==="duration"?Ds.test(e.data)||(a=this._getOrReturnCtx(e,a),w(a,{validation:"duration",code:g.invalid_string,message:s.message}),r.dirty()):s.kind==="ip"?Js(e.data,s.version)||(a=this._getOrReturnCtx(e,a),w(a,{validation:"ip",code:g.invalid_string,message:s.message}),r.dirty()):s.kind==="jwt"?Xs(e.data,s.alg)||(a=this._getOrReturnCtx(e,a),w(a,{validation:"jwt",code:g.invalid_string,message:s.message}),r.dirty()):s.kind==="cidr"?Ks(e.data,s.version)||(a=this._getOrReturnCtx(e,a),w(a,{validation:"cidr",code:g.invalid_string,message:s.message}),r.dirty()):s.kind==="base64"?zs.test(e.data)||(a=this._getOrReturnCtx(e,a),w(a,{validation:"base64",code:g.invalid_string,message:s.message}),r.dirty()):s.kind==="base64url"?Vs.test(e.data)||(a=this._getOrReturnCtx(e,a),w(a,{validation:"base64url",code:g.invalid_string,message:s.message}),r.dirty()):B.assertNever(s);return{status:r.value,value:e.data}}_regex(e,t,r){return this.refinement(a=>e.test(a),{validation:t,code:g.invalid_string,...T.errToObj(r)})}_addCheck(e){return new we({...this._def,checks:[...this._def.checks,e]})}email(e){return this._addCheck({kind:"email",...T.errToObj(e)})}url(e){return this._addCheck({kind:"url",...T.errToObj(e)})}emoji(e){return this._addCheck({kind:"emoji",...T.errToObj(e)})}uuid(e){return this._addCheck({kind:"uuid",...T.errToObj(e)})}nanoid(e){return this._addCheck({kind:"nanoid",...T.errToObj(e)})}cuid(e){return this._addCheck({kind:"cuid",...T.errToObj(e)})}cuid2(e){return this._addCheck({kind:"cuid2",...T.errToObj(e)})}ulid(e){return this._addCheck({kind:"ulid",...T.errToObj(e)})}base64(e){return this._addCheck({kind:"base64",...T.errToObj(e)})}base64url(e){return this._addCheck({kind:"base64url",...T.errToObj(e)})}jwt(e){return this._addCheck({kind:"jwt",...T.errToObj(e)})}ip(e){return this._addCheck({kind:"ip",...T.errToObj(e)})}cidr(e){return this._addCheck({kind:"cidr",...T.errToObj(e)})}datetime(e){var t,r;return typeof e=="string"?this._addCheck({kind:"datetime",precision:null,offset:!1,local:!1,message:e}):this._addCheck({kind:"datetime",precision:typeof e?.precision>"u"?null:e?.precision,offset:(t=e?.offset)!==null&&t!==void 0?t:!1,local:(r=e?.local)!==null&&r!==void 0?r:!1,...T.errToObj(e?.message)})}date(e){return this._addCheck({kind:"date",message:e})}time(e){return typeof e=="string"?this._addCheck({kind:"time",precision:null,message:e}):this._addCheck({kind:"time",precision:typeof e?.precision>"u"?null:e?.precision,...T.errToObj(e?.message)})}duration(e){return this._addCheck({kind:"duration",...T.errToObj(e)})}regex(e,t){return this._addCheck({kind:"regex",regex:e,...T.errToObj(t)})}includes(e,t){return this._addCheck({kind:"includes",value:e,position:t?.position,...T.errToObj(t?.message)})}startsWith(e,t){return this._addCheck({kind:"startsWith",value:e,...T.errToObj(t)})}endsWith(e,t){return this._addCheck({kind:"endsWith",value:e,...T.errToObj(t)})}min(e,t){return this._addCheck({kind:"min",value:e,...T.errToObj(t)})}max(e,t){return this._addCheck({kind:"max",value:e,...T.errToObj(t)})}length(e,t){return this._addCheck({kind:"length",value:e,...T.errToObj(t)})}nonempty(e){return this.min(1,T.errToObj(e))}trim(){return new we({...this._def,checks:[...this._def.checks,{kind:"trim"}]})}toLowerCase(){return new we({...this._def,checks:[...this._def.checks,{kind:"toLowerCase"}]})}toUpperCase(){return new we({...this._def,checks:[...this._def.checks,{kind:"toUpperCase"}]})}get isDatetime(){return!!this._def.checks.find(e=>e.kind==="datetime")}get isDate(){return!!this._def.checks.find(e=>e.kind==="date")}get isTime(){return!!this._def.checks.find(e=>e.kind==="time")}get isDuration(){return!!this._def.checks.find(e=>e.kind==="duration")}get isEmail(){return!!this._def.checks.find(e=>e.kind==="email")}get isURL(){return!!this._def.checks.find(e=>e.kind==="url")}get isEmoji(){return!!this._def.checks.find(e=>e.kind==="emoji")}get isUUID(){return!!this._def.checks.find(e=>e.kind==="uuid")}get isNANOID(){return!!this._def.checks.find(e=>e.kind==="nanoid")}get isCUID(){return!!this._def.checks.find(e=>e.kind==="cuid")}get isCUID2(){return!!this._def.checks.find(e=>e.kind==="cuid2")}get isULID(){return!!this._def.checks.find(e=>e.kind==="ulid")}get isIP(){return!!this._def.checks.find(e=>e.kind==="ip")}get isCIDR(){return!!this._def.checks.find(e=>e.kind==="cidr")}get isBase64(){return!!this._def.checks.find(e=>e.kind==="base64")}get isBase64url(){return!!this._def.checks.find(e=>e.kind==="base64url")}get minLength(){let e=null;for(const t of this._def.checks)t.kind==="min"&&(e===null||t.value>e)&&(e=t.value);return e}get maxLength(){let e=null;for(const t of this._def.checks)t.kind==="max"&&(e===null||t.value<e)&&(e=t.value);return e}}we.create=n=>{var e;return new we({checks:[],typeName:y.ZodString,coerce:(e=n?.coerce)!==null&&e!==void 0?e:!1,...N(n)})};function Ys(n,e){const t=(n.toString().split(".")[1]||"").length,r=(e.toString().split(".")[1]||"").length,a=t>r?t:r,s=parseInt(n.toFixed(a).replace(".","")),i=parseInt(e.toFixed(a).replace(".",""));return s%i/Math.pow(10,a)}class He extends M{constructor(){super(...arguments),this.min=this.gte,this.max=this.lte,this.step=this.multipleOf}_parse(e){if(this._def.coerce&&(e.data=Number(e.data)),this._getType(e)!==E.number){const s=this._getOrReturnCtx(e);return w(s,{code:g.invalid_type,expected:E.number,received:s.parsedType}),x}let r;const a=new te;for(const s of this._def.checks)s.kind==="int"?B.isInteger(e.data)||(r=this._getOrReturnCtx(e,r),w(r,{code:g.invalid_type,expected:"integer",received:"float",message:s.message}),a.dirty()):s.kind==="min"?(s.inclusive?e.data<s.value:e.data<=s.value)&&(r=this._getOrReturnCtx(e,r),w(r,{code:g.too_small,minimum:s.value,type:"number",inclusive:s.inclusive,exact:!1,message:s.message}),a.dirty()):s.kind==="max"?(s.inclusive?e.data>s.value:e.data>=s.value)&&(r=this._getOrReturnCtx(e,r),w(r,{code:g.too_big,maximum:s.value,type:"number",inclusive:s.inclusive,exact:!1,message:s.message}),a.dirty()):s.kind==="multipleOf"?Ys(e.data,s.value)!==0&&(r=this._getOrReturnCtx(e,r),w(r,{code:g.not_multiple_of,multipleOf:s.value,message:s.message}),a.dirty()):s.kind==="finite"?Number.isFinite(e.data)||(r=this._getOrReturnCtx(e,r),w(r,{code:g.not_finite,message:s.message}),a.dirty()):B.assertNever(s);return{status:a.value,value:e.data}}gte(e,t){return this.setLimit("min",e,!0,T.toString(t))}gt(e,t){return this.setLimit("min",e,!1,T.toString(t))}lte(e,t){return this.setLimit("max",e,!0,T.toString(t))}lt(e,t){return this.setLimit("max",e,!1,T.toString(t))}setLimit(e,t,r,a){return new He({...this._def,checks:[...this._def.checks,{kind:e,value:t,inclusive:r,message:T.toString(a)}]})}_addCheck(e){return new He({...this._def,checks:[...this._def.checks,e]})}int(e){return this._addCheck({kind:"int",message:T.toString(e)})}positive(e){return this._addCheck({kind:"min",value:0,inclusive:!1,message:T.toString(e)})}negative(e){return this._addCheck({kind:"max",value:0,inclusive:!1,message:T.toString(e)})}nonpositive(e){return this._addCheck({kind:"max",value:0,inclusive:!0,message:T.toString(e)})}nonnegative(e){return this._addCheck({kind:"min",value:0,inclusive:!0,message:T.toString(e)})}multipleOf(e,t){return this._addCheck({kind:"multipleOf",value:e,message:T.toString(t)})}finite(e){return this._addCheck({kind:"finite",message:T.toString(e)})}safe(e){return this._addCheck({kind:"min",inclusive:!0,value:Number.MIN_SAFE_INTEGER,message:T.toString(e)})._addCheck({kind:"max",inclusive:!0,value:Number.MAX_SAFE_INTEGER,message:T.toString(e)})}get minValue(){let e=null;for(const t of this._def.checks)t.kind==="min"&&(e===null||t.value>e)&&(e=t.value);return e}get maxValue(){let e=null;for(const t of this._def.checks)t.kind==="max"&&(e===null||t.value<e)&&(e=t.value);return e}get isInt(){return!!this._def.checks.find(e=>e.kind==="int"||e.kind==="multipleOf"&&B.isInteger(e.value))}get isFinite(){let e=null,t=null;for(const r of this._def.checks){if(r.kind==="finite"||r.kind==="int"||r.kind==="multipleOf")return!0;r.kind==="min"?(t===null||r.value>t)&&(t=r.value):r.kind==="max"&&(e===null||r.value<e)&&(e=r.value)}return Number.isFinite(t)&&Number.isFinite(e)}}He.create=n=>new He({checks:[],typeName:y.ZodNumber,coerce:n?.coerce||!1,...N(n)});class Ge extends M{constructor(){super(...arguments),this.min=this.gte,this.max=this.lte}_parse(e){if(this._def.coerce)try{e.data=BigInt(e.data)}catch{return this._getInvalidInput(e)}if(this._getType(e)!==E.bigint)return this._getInvalidInput(e);let r;const a=new te;for(const s of this._def.checks)s.kind==="min"?(s.inclusive?e.data<s.value:e.data<=s.value)&&(r=this._getOrReturnCtx(e,r),w(r,{code:g.too_small,type:"bigint",minimum:s.value,inclusive:s.inclusive,message:s.message}),a.dirty()):s.kind==="max"?(s.inclusive?e.data>s.value:e.data>=s.value)&&(r=this._getOrReturnCtx(e,r),w(r,{code:g.too_big,type:"bigint",maximum:s.value,inclusive:s.inclusive,message:s.message}),a.dirty()):s.kind==="multipleOf"?e.data%s.value!==BigInt(0)&&(r=this._getOrReturnCtx(e,r),w(r,{code:g.not_multiple_of,multipleOf:s.value,message:s.message}),a.dirty()):B.assertNever(s);return{status:a.value,value:e.data}}_getInvalidInput(e){const t=this._getOrReturnCtx(e);return w(t,{code:g.invalid_type,expected:E.bigint,received:t.parsedType}),x}gte(e,t){return this.setLimit("min",e,!0,T.toString(t))}gt(e,t){return this.setLimit("min",e,!1,T.toString(t))}lte(e,t){return this.setLimit("max",e,!0,T.toString(t))}lt(e,t){return this.setLimit("max",e,!1,T.toString(t))}setLimit(e,t,r,a){return new Ge({...this._def,checks:[...this._def.checks,{kind:e,value:t,inclusive:r,message:T.toString(a)}]})}_addCheck(e){return new Ge({...this._def,checks:[...this._def.checks,e]})}positive(e){return this._addCheck({kind:"min",value:BigInt(0),inclusive:!1,message:T.toString(e)})}negative(e){return this._addCheck({kind:"max",value:BigInt(0),inclusive:!1,message:T.toString(e)})}nonpositive(e){return this._addCheck({kind:"max",value:BigInt(0),inclusive:!0,message:T.toString(e)})}nonnegative(e){return this._addCheck({kind:"min",value:BigInt(0),inclusive:!0,message:T.toString(e)})}multipleOf(e,t){return this._addCheck({kind:"multipleOf",value:e,message:T.toString(t)})}get minValue(){let e=null;for(const t of this._def.checks)t.kind==="min"&&(e===null||t.value>e)&&(e=t.value);return e}get maxValue(){let e=null;for(const t of this._def.checks)t.kind==="max"&&(e===null||t.value<e)&&(e=t.value);return e}}Ge.create=n=>{var e;return new Ge({checks:[],typeName:y.ZodBigInt,coerce:(e=n?.coerce)!==null&&e!==void 0?e:!1,...N(n)})};class Rt extends M{_parse(e){if(this._def.coerce&&(e.data=!!e.data),this._getType(e)!==E.boolean){const r=this._getOrReturnCtx(e);return w(r,{code:g.invalid_type,expected:E.boolean,received:r.parsedType}),x}return se(e.data)}}Rt.create=n=>new Rt({typeName:y.ZodBoolean,coerce:n?.coerce||!1,...N(n)});class tt extends M{_parse(e){if(this._def.coerce&&(e.data=new Date(e.data)),this._getType(e)!==E.date){const s=this._getOrReturnCtx(e);return w(s,{code:g.invalid_type,expected:E.date,received:s.parsedType}),x}if(isNaN(e.data.getTime())){const s=this._getOrReturnCtx(e);return w(s,{code:g.invalid_date}),x}const r=new te;let a;for(const s of this._def.checks)s.kind==="min"?e.data.getTime()<s.value&&(a=this._getOrReturnCtx(e,a),w(a,{code:g.too_small,message:s.message,inclusive:!0,exact:!1,minimum:s.value,type:"date"}),r.dirty()):s.kind==="max"?e.data.getTime()>s.value&&(a=this._getOrReturnCtx(e,a),w(a,{code:g.too_big,message:s.message,inclusive:!0,exact:!1,maximum:s.value,type:"date"}),r.dirty()):B.assertNever(s);return{status:r.value,value:new Date(e.data.getTime())}}_addCheck(e){return new tt({...this._def,checks:[...this._def.checks,e]})}min(e,t){return this._addCheck({kind:"min",value:e.getTime(),message:T.toString(t)})}max(e,t){return this._addCheck({kind:"max",value:e.getTime(),message:T.toString(t)})}get minDate(){let e=null;for(const t of this._def.checks)t.kind==="min"&&(e===null||t.value>e)&&(e=t.value);return e!=null?new Date(e):null}get maxDate(){let e=null;for(const t of this._def.checks)t.kind==="max"&&(e===null||t.value<e)&&(e=t.value);return e!=null?new Date(e):null}}tt.create=n=>new tt({checks:[],coerce:n?.coerce||!1,typeName:y.ZodDate,...N(n)});class ir extends M{_parse(e){if(this._getType(e)!==E.symbol){const r=this._getOrReturnCtx(e);return w(r,{code:g.invalid_type,expected:E.symbol,received:r.parsedType}),x}return se(e.data)}}ir.create=n=>new ir({typeName:y.ZodSymbol,...N(n)});class xt extends M{_parse(e){if(this._getType(e)!==E.undefined){const r=this._getOrReturnCtx(e);return w(r,{code:g.invalid_type,expected:E.undefined,received:r.parsedType}),x}return se(e.data)}}xt.create=n=>new xt({typeName:y.ZodUndefined,...N(n)});class Ct extends M{_parse(e){if(this._getType(e)!==E.null){const r=this._getOrReturnCtx(e);return w(r,{code:g.invalid_type,expected:E.null,received:r.parsedType}),x}return se(e.data)}}Ct.create=n=>new Ct({typeName:y.ZodNull,...N(n)});class ht extends M{constructor(){super(...arguments),this._any=!0}_parse(e){return se(e.data)}}ht.create=n=>new ht({typeName:y.ZodAny,...N(n)});class Ye extends M{constructor(){super(...arguments),this._unknown=!0}_parse(e){return se(e.data)}}Ye.create=n=>new Ye({typeName:y.ZodUnknown,...N(n)});class Me extends M{_parse(e){const t=this._getOrReturnCtx(e);return w(t,{code:g.invalid_type,expected:E.never,received:t.parsedType}),x}}Me.create=n=>new Me({typeName:y.ZodNever,...N(n)});class or extends M{_parse(e){if(this._getType(e)!==E.undefined){const r=this._getOrReturnCtx(e);return w(r,{code:g.invalid_type,expected:E.void,received:r.parsedType}),x}return se(e.data)}}or.create=n=>new or({typeName:y.ZodVoid,...N(n)});class Ee extends M{_parse(e){const{ctx:t,status:r}=this._processInputParams(e),a=this._def;if(t.parsedType!==E.array)return w(t,{code:g.invalid_type,expected:E.array,received:t.parsedType}),x;if(a.exactLength!==null){const i=t.data.length>a.exactLength.value,o=t.data.length<a.exactLength.value;(i||o)&&(w(t,{code:i?g.too_big:g.too_small,minimum:o?a.exactLength.value:void 0,maximum:i?a.exactLength.value:void 0,type:"array",inclusive:!0,exact:!0,message:a.exactLength.message}),r.dirty())}if(a.minLength!==null&&t.data.length<a.minLength.value&&(w(t,{code:g.too_small,minimum:a.minLength.value,type:"array",inclusive:!0,exact:!1,message:a.minLength.message}),r.dirty()),a.maxLength!==null&&t.data.length>a.maxLength.value&&(w(t,{code:g.too_big,maximum:a.maxLength.value,type:"array",inclusive:!0,exact:!1,message:a.maxLength.message}),r.dirty()),t.common.async)return Promise.all([...t.data].map((i,o)=>a.type._parseAsync(new Re(t,i,t.path,o)))).then(i=>te.mergeArray(r,i));const s=[...t.data].map((i,o)=>a.type._parseSync(new Re(t,i,t.path,o)));return te.mergeArray(r,s)}get element(){return this._def.type}min(e,t){return new Ee({...this._def,minLength:{value:e,message:T.toString(t)}})}max(e,t){return new Ee({...this._def,maxLength:{value:e,message:T.toString(t)}})}length(e,t){return new Ee({...this._def,exactLength:{value:e,message:T.toString(t)}})}nonempty(e){return this.min(1,e)}}Ee.create=(n,e)=>new Ee({type:n,minLength:null,maxLength:null,exactLength:null,typeName:y.ZodArray,...N(e)});function it(n){if(n instanceof J){const e={};for(const t in n.shape){const r=n.shape[t];e[t]=Oe.create(it(r))}return new J({...n._def,shape:()=>e})}else return n instanceof Ee?new Ee({...n._def,type:it(n.element)}):n instanceof Oe?Oe.create(it(n.unwrap())):n instanceof Ve?Ve.create(it(n.unwrap())):n instanceof xe?xe.create(n.items.map(e=>it(e))):n}class J extends M{constructor(){super(...arguments),this._cached=null,this.nonstrict=this.passthrough,this.augment=this.extend}_getCached(){if(this._cached!==null)return this._cached;const e=this._def.shape(),t=B.objectKeys(e);return this._cached={shape:e,keys:t}}_parse(e){if(this._getType(e)!==E.object){const c=this._getOrReturnCtx(e);return w(c,{code:g.invalid_type,expected:E.object,received:c.parsedType}),x}const{status:r,ctx:a}=this._processInputParams(e),{shape:s,keys:i}=this._getCached(),o=[];if(!(this._def.catchall instanceof Me&&this._def.unknownKeys==="strip"))for(const c in a.data)i.includes(c)||o.push(c);const u=[];for(const c of i){const l=s[c],d=a.data[c];u.push({key:{status:"valid",value:c},value:l._parse(new Re(a,d,a.path,c)),alwaysSet:c in a.data})}if(this._def.catchall instanceof Me){const c=this._def.unknownKeys;if(c==="passthrough")for(const l of o)u.push({key:{status:"valid",value:l},value:{status:"valid",value:a.data[l]}});else if(c==="strict")o.length>0&&(w(a,{code:g.unrecognized_keys,keys:o}),r.dirty());else if(c!=="strip")throw new Error("Internal ZodObject error: invalid unknownKeys value.")}else{const c=this._def.catchall;for(const l of o){const d=a.data[l];u.push({key:{status:"valid",value:l},value:c._parse(new Re(a,d,a.path,l)),alwaysSet:l in a.data})}}return a.common.async?Promise.resolve().then(async()=>{const c=[];for(const l of u){const d=await l.key,h=await l.value;c.push({key:d,value:h,alwaysSet:l.alwaysSet})}return c}).then(c=>te.mergeObjectSync(r,c)):te.mergeObjectSync(r,u)}get shape(){return this._def.shape()}strict(e){return T.errToObj,new J({...this._def,unknownKeys:"strict",...e!==void 0?{errorMap:(t,r)=>{var a,s,i,o;const u=(i=(s=(a=this._def).errorMap)===null||s===void 0?void 0:s.call(a,t,r).message)!==null&&i!==void 0?i:r.defaultError;return t.code==="unrecognized_keys"?{message:(o=T.errToObj(e).message)!==null&&o!==void 0?o:u}:{message:u}}}:{}})}strip(){return new J({...this._def,unknownKeys:"strip"})}passthrough(){return new J({...this._def,unknownKeys:"passthrough"})}extend(e){return new J({...this._def,shape:()=>({...this._def.shape(),...e})})}merge(e){return new J({unknownKeys:e._def.unknownKeys,catchall:e._def.catchall,shape:()=>({...this._def.shape(),...e._def.shape()}),typeName:y.ZodObject})}setKey(e,t){return this.augment({[e]:t})}catchall(e){return new J({...this._def,catchall:e})}pick(e){const t={};return B.objectKeys(e).forEach(r=>{e[r]&&this.shape[r]&&(t[r]=this.shape[r])}),new J({...this._def,shape:()=>t})}omit(e){const t={};return B.objectKeys(this.shape).forEach(r=>{e[r]||(t[r]=this.shape[r])}),new J({...this._def,shape:()=>t})}deepPartial(){return it(this)}partial(e){const t={};return B.objectKeys(this.shape).forEach(r=>{const a=this.shape[r];e&&!e[r]?t[r]=a:t[r]=a.optional()}),new J({...this._def,shape:()=>t})}required(e){const t={};return B.objectKeys(this.shape).forEach(r=>{if(e&&!e[r])t[r]=this.shape[r];else{let s=this.shape[r];for(;s instanceof Oe;)s=s._def.innerType;t[r]=s}}),new J({...this._def,shape:()=>t})}keyof(){return La(B.objectKeys(this.shape))}}J.create=(n,e)=>new J({shape:()=>n,unknownKeys:"strip",catchall:Me.create(),typeName:y.ZodObject,...N(e)});J.strictCreate=(n,e)=>new J({shape:()=>n,unknownKeys:"strict",catchall:Me.create(),typeName:y.ZodObject,...N(e)});J.lazycreate=(n,e)=>new J({shape:n,unknownKeys:"strip",catchall:Me.create(),typeName:y.ZodObject,...N(e)});class Pt extends M{_parse(e){const{ctx:t}=this._processInputParams(e),r=this._def.options;function a(s){for(const o of s)if(o.result.status==="valid")return o.result;for(const o of s)if(o.result.status==="dirty")return t.common.issues.push(...o.ctx.common.issues),o.result;const i=s.map(o=>new he(o.ctx.common.issues));return w(t,{code:g.invalid_union,unionErrors:i}),x}if(t.common.async)return Promise.all(r.map(async s=>{const i={...t,common:{...t.common,issues:[]},parent:null};return{result:await s._parseAsync({data:t.data,path:t.path,parent:i}),ctx:i}})).then(a);{let s;const i=[];for(const u of r){const c={...t,common:{...t.common,issues:[]},parent:null},l=u._parseSync({data:t.data,path:t.path,parent:c});if(l.status==="valid")return l;l.status==="dirty"&&!s&&(s={result:l,ctx:c}),c.common.issues.length&&i.push(c.common.issues)}if(s)return t.common.issues.push(...s.ctx.common.issues),s.result;const o=i.map(u=>new he(u));return w(t,{code:g.invalid_union,unionErrors:o}),x}}get options(){return this._def.options}}Pt.create=(n,e)=>new Pt({options:n,typeName:y.ZodUnion,...N(e)});const Pe=n=>n instanceof Lt?Pe(n.schema):n instanceof Te?Pe(n.innerType()):n instanceof Mt?[n.value]:n instanceof ze?n.options:n instanceof Dt?B.objectValues(n.enum):n instanceof Ft?Pe(n._def.innerType):n instanceof xt?[void 0]:n instanceof Ct?[null]:n instanceof Oe?[void 0,...Pe(n.unwrap())]:n instanceof Ve?[null,...Pe(n.unwrap())]:n instanceof gn||n instanceof Bt?Pe(n.unwrap()):n instanceof Ut?Pe(n._def.innerType):[];class wr extends M{_parse(e){const{ctx:t}=this._processInputParams(e);if(t.parsedType!==E.object)return w(t,{code:g.invalid_type,expected:E.object,received:t.parsedType}),x;const r=this.discriminator,a=t.data[r],s=this.optionsMap.get(a);return s?t.common.async?s._parseAsync({data:t.data,path:t.path,parent:t}):s._parseSync({data:t.data,path:t.path,parent:t}):(w(t,{code:g.invalid_union_discriminator,options:Array.from(this.optionsMap.keys()),path:[r]}),x)}get discriminator(){return this._def.discriminator}get options(){return this._def.options}get optionsMap(){return this._def.optionsMap}static create(e,t,r){const a=new Map;for(const s of t){const i=Pe(s.shape[e]);if(!i.length)throw new Error(`A discriminator value for key \`${e}\` could not be extracted from all schema options`);for(const o of i){if(a.has(o))throw new Error(`Discriminator property ${String(e)} has duplicate value ${String(o)}`);a.set(o,s)}}return new wr({typeName:y.ZodDiscriminatedUnion,discriminator:e,options:t,optionsMap:a,...N(r)})}}function an(n,e){const t=Ne(n),r=Ne(e);if(n===e)return{valid:!0,data:n};if(t===E.object&&r===E.object){const a=B.objectKeys(e),s=B.objectKeys(n).filter(o=>a.indexOf(o)!==-1),i={...n,...e};for(const o of s){const u=an(n[o],e[o]);if(!u.valid)return{valid:!1};i[o]=u.data}return{valid:!0,data:i}}else if(t===E.array&&r===E.array){if(n.length!==e.length)return{valid:!1};const a=[];for(let s=0;s<n.length;s++){const i=n[s],o=e[s],u=an(i,o);if(!u.valid)return{valid:!1};a.push(u.data)}return{valid:!0,data:a}}else return t===E.date&&r===E.date&&+n==+e?{valid:!0,data:n}:{valid:!1}}class Nt extends M{_parse(e){const{status:t,ctx:r}=this._processInputParams(e),a=(s,i)=>{if(rn(s)||rn(i))return x;const o=an(s.value,i.value);return o.valid?((nn(s)||nn(i))&&t.dirty(),{status:t.value,value:o.data}):(w(r,{code:g.invalid_intersection_types}),x)};return r.common.async?Promise.all([this._def.left._parseAsync({data:r.data,path:r.path,parent:r}),this._def.right._parseAsync({data:r.data,path:r.path,parent:r})]).then(([s,i])=>a(s,i)):a(this._def.left._parseSync({data:r.data,path:r.path,parent:r}),this._def.right._parseSync({data:r.data,path:r.path,parent:r}))}}Nt.create=(n,e,t)=>new Nt({left:n,right:e,typeName:y.ZodIntersection,...N(t)});class xe extends M{_parse(e){const{status:t,ctx:r}=this._processInputParams(e);if(r.parsedType!==E.array)return w(r,{code:g.invalid_type,expected:E.array,received:r.parsedType}),x;if(r.data.length<this._def.items.length)return w(r,{code:g.too_small,minimum:this._def.items.length,inclusive:!0,exact:!1,type:"array"}),x;!this._def.rest&&r.data.length>this._def.items.length&&(w(r,{code:g.too_big,maximum:this._def.items.length,inclusive:!0,exact:!1,type:"array"}),t.dirty());const s=[...r.data].map((i,o)=>{const u=this._def.items[o]||this._def.rest;return u?u._parse(new Re(r,i,r.path,o)):null}).filter(i=>!!i);return r.common.async?Promise.all(s).then(i=>te.mergeArray(t,i)):te.mergeArray(t,s)}get items(){return this._def.items}rest(e){return new xe({...this._def,rest:e})}}xe.create=(n,e)=>{if(!Array.isArray(n))throw new Error("You must pass an array of schemas to z.tuple([ ... ])");return new xe({items:n,typeName:y.ZodTuple,rest:null,...N(e)})};class jt extends M{get keySchema(){return this._def.keyType}get valueSchema(){return this._def.valueType}_parse(e){const{status:t,ctx:r}=this._processInputParams(e);if(r.parsedType!==E.object)return w(r,{code:g.invalid_type,expected:E.object,received:r.parsedType}),x;const a=[],s=this._def.keyType,i=this._def.valueType;for(const o in r.data)a.push({key:s._parse(new Re(r,o,r.path,o)),value:i._parse(new Re(r,r.data[o],r.path,o)),alwaysSet:o in r.data});return r.common.async?te.mergeObjectAsync(t,a):te.mergeObjectSync(t,a)}get element(){return this._def.valueType}static create(e,t,r){return t instanceof M?new jt({keyType:e,valueType:t,typeName:y.ZodRecord,...N(r)}):new jt({keyType:we.create(),valueType:e,typeName:y.ZodRecord,...N(t)})}}class ur extends M{get keySchema(){return this._def.keyType}get valueSchema(){return this._def.valueType}_parse(e){const{status:t,ctx:r}=this._processInputParams(e);if(r.parsedType!==E.map)return w(r,{code:g.invalid_type,expected:E.map,received:r.parsedType}),x;const a=this._def.keyType,s=this._def.valueType,i=[...r.data.entries()].map(([o,u],c)=>({key:a._parse(new Re(r,o,r.path,[c,"key"])),value:s._parse(new Re(r,u,r.path,[c,"value"]))}));if(r.common.async){const o=new Map;return Promise.resolve().then(async()=>{for(const u of i){const c=await u.key,l=await u.value;if(c.status==="aborted"||l.status==="aborted")return x;(c.status==="dirty"||l.status==="dirty")&&t.dirty(),o.set(c.value,l.value)}return{status:t.value,value:o}})}else{const o=new Map;for(const u of i){const c=u.key,l=u.value;if(c.status==="aborted"||l.status==="aborted")return x;(c.status==="dirty"||l.status==="dirty")&&t.dirty(),o.set(c.value,l.value)}return{status:t.value,value:o}}}}ur.create=(n,e,t)=>new ur({valueType:e,keyType:n,typeName:y.ZodMap,...N(t)});class rt extends M{_parse(e){const{status:t,ctx:r}=this._processInputParams(e);if(r.parsedType!==E.set)return w(r,{code:g.invalid_type,expected:E.set,received:r.parsedType}),x;const a=this._def;a.minSize!==null&&r.data.size<a.minSize.value&&(w(r,{code:g.too_small,minimum:a.minSize.value,type:"set",inclusive:!0,exact:!1,message:a.minSize.message}),t.dirty()),a.maxSize!==null&&r.data.size>a.maxSize.value&&(w(r,{code:g.too_big,maximum:a.maxSize.value,type:"set",inclusive:!0,exact:!1,message:a.maxSize.message}),t.dirty());const s=this._def.valueType;function i(u){const c=new Set;for(const l of u){if(l.status==="aborted")return x;l.status==="dirty"&&t.dirty(),c.add(l.value)}return{status:t.value,value:c}}const o=[...r.data.values()].map((u,c)=>s._parse(new Re(r,u,r.path,c)));return r.common.async?Promise.all(o).then(u=>i(u)):i(o)}min(e,t){return new rt({...this._def,minSize:{value:e,message:T.toString(t)}})}max(e,t){return new rt({...this._def,maxSize:{value:e,message:T.toString(t)}})}size(e,t){return this.min(e,t).max(e,t)}nonempty(e){return this.min(1,e)}}rt.create=(n,e)=>new rt({valueType:n,minSize:null,maxSize:null,typeName:y.ZodSet,...N(e)});class lt extends M{constructor(){super(...arguments),this.validate=this.implement}_parse(e){const{ctx:t}=this._processInputParams(e);if(t.parsedType!==E.function)return w(t,{code:g.invalid_type,expected:E.function,received:t.parsedType}),x;function r(o,u){return ar({data:o,path:t.path,errorMaps:[t.common.contextualErrorMap,t.schemaErrorMap,nr(),dt].filter(c=>!!c),issueData:{code:g.invalid_arguments,argumentsError:u}})}function a(o,u){return ar({data:o,path:t.path,errorMaps:[t.common.contextualErrorMap,t.schemaErrorMap,nr(),dt].filter(c=>!!c),issueData:{code:g.invalid_return_type,returnTypeError:u}})}const s={errorMap:t.common.contextualErrorMap},i=t.data;if(this._def.returns instanceof ft){const o=this;return se(async function(...u){const c=new he([]),l=await o._def.args.parseAsync(u,s).catch(f=>{throw c.addIssue(r(u,f)),c}),d=await Reflect.apply(i,this,l);return await o._def.returns._def.type.parseAsync(d,s).catch(f=>{throw c.addIssue(a(d,f)),c})})}else{const o=this;return se(function(...u){const c=o._def.args.safeParse(u,s);if(!c.success)throw new he([r(u,c.error)]);const l=Reflect.apply(i,this,c.data),d=o._def.returns.safeParse(l,s);if(!d.success)throw new he([a(l,d.error)]);return d.data})}}parameters(){return this._def.args}returnType(){return this._def.returns}args(...e){return new lt({...this._def,args:xe.create(e).rest(Ye.create())})}returns(e){return new lt({...this._def,returns:e})}implement(e){return this.parse(e)}strictImplement(e){return this.parse(e)}static create(e,t,r){return new lt({args:e||xe.create([]).rest(Ye.create()),returns:t||Ye.create(),typeName:y.ZodFunction,...N(r)})}}class Lt extends M{get schema(){return this._def.getter()}_parse(e){const{ctx:t}=this._processInputParams(e);return this._def.getter()._parse({data:t.data,path:t.path,parent:t})}}Lt.create=(n,e)=>new Lt({getter:n,typeName:y.ZodLazy,...N(e)});class Mt extends M{_parse(e){if(e.data!==this._def.value){const t=this._getOrReturnCtx(e);return w(t,{received:t.data,code:g.invalid_literal,expected:this._def.value}),x}return{status:"valid",value:e.data}}get value(){return this._def.value}}Mt.create=(n,e)=>new Mt({value:n,typeName:y.ZodLiteral,...N(e)});function La(n,e){return new ze({values:n,typeName:y.ZodEnum,...N(e)})}class ze extends M{constructor(){super(...arguments),Et.set(this,void 0)}_parse(e){if(typeof e.data!="string"){const t=this._getOrReturnCtx(e),r=this._def.values;return w(t,{expected:B.joinValues(r),received:t.parsedType,code:g.invalid_type}),x}if(sr(this,Et)||Ca(this,Et,new Set(this._def.values)),!sr(this,Et).has(e.data)){const t=this._getOrReturnCtx(e),r=this._def.values;return w(t,{received:t.data,code:g.invalid_enum_value,options:r}),x}return se(e.data)}get options(){return this._def.values}get enum(){const e={};for(const t of this._def.values)e[t]=t;return e}get Values(){const e={};for(const t of this._def.values)e[t]=t;return e}get Enum(){const e={};for(const t of this._def.values)e[t]=t;return e}extract(e,t=this._def){return ze.create(e,{...this._def,...t})}exclude(e,t=this._def){return ze.create(this.options.filter(r=>!e.includes(r)),{...this._def,...t})}}Et=new WeakMap;ze.create=La;class Dt extends M{constructor(){super(...arguments),Ot.set(this,void 0)}_parse(e){const t=B.getValidEnumValues(this._def.values),r=this._getOrReturnCtx(e);if(r.parsedType!==E.string&&r.parsedType!==E.number){const a=B.objectValues(t);return w(r,{expected:B.joinValues(a),received:r.parsedType,code:g.invalid_type}),x}if(sr(this,Ot)||Ca(this,Ot,new Set(B.getValidEnumValues(this._def.values))),!sr(this,Ot).has(e.data)){const a=B.objectValues(t);return w(r,{received:r.data,code:g.invalid_enum_value,options:a}),x}return se(e.data)}get enum(){return this._def.values}}Ot=new WeakMap;Dt.create=(n,e)=>new Dt({values:n,typeName:y.ZodNativeEnum,...N(e)});class ft extends M{unwrap(){return this._def.type}_parse(e){const{ctx:t}=this._processInputParams(e);if(t.parsedType!==E.promise&&t.common.async===!1)return w(t,{code:g.invalid_type,expected:E.promise,received:t.parsedType}),x;const r=t.parsedType===E.promise?t.data:Promise.resolve(t.data);return se(r.then(a=>this._def.type.parseAsync(a,{path:t.path,errorMap:t.common.contextualErrorMap})))}}ft.create=(n,e)=>new ft({type:n,typeName:y.ZodPromise,...N(e)});class Te extends M{innerType(){return this._def.schema}sourceType(){return this._def.schema._def.typeName===y.ZodEffects?this._def.schema.sourceType():this._def.schema}_parse(e){const{status:t,ctx:r}=this._processInputParams(e),a=this._def.effect||null,s={addIssue:i=>{w(r,i),i.fatal?t.abort():t.dirty()},get path(){return r.path}};if(s.addIssue=s.addIssue.bind(s),a.type==="preprocess"){const i=a.transform(r.data,s);if(r.common.async)return Promise.resolve(i).then(async o=>{if(t.value==="aborted")return x;const u=await this._def.schema._parseAsync({data:o,path:r.path,parent:r});return u.status==="aborted"?x:u.status==="dirty"||t.value==="dirty"?ot(u.value):u});{if(t.value==="aborted")return x;const o=this._def.schema._parseSync({data:i,path:r.path,parent:r});return o.status==="aborted"?x:o.status==="dirty"||t.value==="dirty"?ot(o.value):o}}if(a.type==="refinement"){const i=o=>{const u=a.refinement(o,s);if(r.common.async)return Promise.resolve(u);if(u instanceof Promise)throw new Error("Async refinement encountered during synchronous parse operation. Use .parseAsync instead.");return o};if(r.common.async===!1){const o=this._def.schema._parseSync({data:r.data,path:r.path,parent:r});return o.status==="aborted"?x:(o.status==="dirty"&&t.dirty(),i(o.value),{status:t.value,value:o.value})}else return this._def.schema._parseAsync({data:r.data,path:r.path,parent:r}).then(o=>o.status==="aborted"?x:(o.status==="dirty"&&t.dirty(),i(o.value).then(()=>({status:t.value,value:o.value}))))}if(a.type==="transform")if(r.common.async===!1){const i=this._def.schema._parseSync({data:r.data,path:r.path,parent:r});if(!et(i))return i;const o=a.transform(i.value,s);if(o instanceof Promise)throw new Error("Asynchronous transform encountered during synchronous parse operation. Use .parseAsync instead.");return{status:t.value,value:o}}else return this._def.schema._parseAsync({data:r.data,path:r.path,parent:r}).then(i=>et(i)?Promise.resolve(a.transform(i.value,s)).then(o=>({status:t.value,value:o})):i);B.assertNever(a)}}Te.create=(n,e,t)=>new Te({schema:n,typeName:y.ZodEffects,effect:e,...N(t)});Te.createWithPreprocess=(n,e,t)=>new Te({schema:e,effect:{type:"preprocess",transform:n},typeName:y.ZodEffects,...N(t)});class Oe extends M{_parse(e){return this._getType(e)===E.undefined?se(void 0):this._def.innerType._parse(e)}unwrap(){return this._def.innerType}}Oe.create=(n,e)=>new Oe({innerType:n,typeName:y.ZodOptional,...N(e)});class Ve extends M{_parse(e){return this._getType(e)===E.null?se(null):this._def.innerType._parse(e)}unwrap(){return this._def.innerType}}Ve.create=(n,e)=>new Ve({innerType:n,typeName:y.ZodNullable,...N(e)});class Ft extends M{_parse(e){const{ctx:t}=this._processInputParams(e);let r=t.data;return t.parsedType===E.undefined&&(r=this._def.defaultValue()),this._def.innerType._parse({data:r,path:t.path,parent:t})}removeDefault(){return this._def.innerType}}Ft.create=(n,e)=>new Ft({innerType:n,typeName:y.ZodDefault,defaultValue:typeof e.default=="function"?e.default:()=>e.default,...N(e)});class Ut extends M{_parse(e){const{ctx:t}=this._processInputParams(e),r={...t,common:{...t.common,issues:[]}},a=this._def.innerType._parse({data:r.data,path:r.path,parent:{...r}});return At(a)?a.then(s=>({status:"valid",value:s.status==="valid"?s.value:this._def.catchValue({get error(){return new he(r.common.issues)},input:r.data})})):{status:"valid",value:a.status==="valid"?a.value:this._def.catchValue({get error(){return new he(r.common.issues)},input:r.data})}}removeCatch(){return this._def.innerType}}Ut.create=(n,e)=>new Ut({innerType:n,typeName:y.ZodCatch,catchValue:typeof e.catch=="function"?e.catch:()=>e.catch,...N(e)});class cr extends M{_parse(e){if(this._getType(e)!==E.nan){const r=this._getOrReturnCtx(e);return w(r,{code:g.invalid_type,expected:E.nan,received:r.parsedType}),x}return{status:"valid",value:e.data}}}cr.create=n=>new cr({typeName:y.ZodNaN,...N(n)});const Qs=Symbol("zod_brand");class gn extends M{_parse(e){const{ctx:t}=this._processInputParams(e),r=t.data;return this._def.type._parse({data:r,path:t.path,parent:t})}unwrap(){return this._def.type}}class zt extends M{_parse(e){const{status:t,ctx:r}=this._processInputParams(e);if(r.common.async)return(async()=>{const s=await this._def.in._parseAsync({data:r.data,path:r.path,parent:r});return s.status==="aborted"?x:s.status==="dirty"?(t.dirty(),ot(s.value)):this._def.out._parseAsync({data:s.value,path:r.path,parent:r})})();{const a=this._def.in._parseSync({data:r.data,path:r.path,parent:r});return a.status==="aborted"?x:a.status==="dirty"?(t.dirty(),{status:"dirty",value:a.value}):this._def.out._parseSync({data:a.value,path:r.path,parent:r})}}static create(e,t){return new zt({in:e,out:t,typeName:y.ZodPipeline})}}class Bt extends M{_parse(e){const t=this._def.innerType._parse(e),r=a=>(et(a)&&(a.value=Object.freeze(a.value)),a);return At(t)?t.then(a=>r(a)):r(t)}unwrap(){return this._def.innerType}}Bt.create=(n,e)=>new Bt({innerType:n,typeName:y.ZodReadonly,...N(e)});function Ma(n,e={},t){return n?ht.create().superRefine((r,a)=>{var s,i;if(!n(r)){const o=typeof e=="function"?e(r):typeof e=="string"?{message:e}:e,u=(i=(s=o.fatal)!==null&&s!==void 0?s:t)!==null&&i!==void 0?i:!0,c=typeof o=="string"?{message:o}:o;a.addIssue({code:"custom",...c,fatal:u})}}):ht.create()}const ei={object:J.lazycreate};var y;(function(n){n.ZodString="ZodString",n.ZodNumber="ZodNumber",n.ZodNaN="ZodNaN",n.ZodBigInt="ZodBigInt",n.ZodBoolean="ZodBoolean",n.ZodDate="ZodDate",n.ZodSymbol="ZodSymbol",n.ZodUndefined="ZodUndefined",n.ZodNull="ZodNull",n.ZodAny="ZodAny",n.ZodUnknown="ZodUnknown",n.ZodNever="ZodNever",n.ZodVoid="ZodVoid",n.ZodArray="ZodArray",n.ZodObject="ZodObject",n.ZodUnion="ZodUnion",n.ZodDiscriminatedUnion="ZodDiscriminatedUnion",n.ZodIntersection="ZodIntersection",n.ZodTuple="ZodTuple",n.ZodRecord="ZodRecord",n.ZodMap="ZodMap",n.ZodSet="ZodSet",n.ZodFunction="ZodFunction",n.ZodLazy="ZodLazy",n.ZodLiteral="ZodLiteral",n.ZodEnum="ZodEnum",n.ZodEffects="ZodEffects",n.ZodNativeEnum="ZodNativeEnum",n.ZodOptional="ZodOptional",n.ZodNullable="ZodNullable",n.ZodDefault="ZodDefault",n.ZodCatch="ZodCatch",n.ZodPromise="ZodPromise",n.ZodBranded="ZodBranded",n.ZodPipeline="ZodPipeline",n.ZodReadonly="ZodReadonly"})(y||(y={}));const ti=(n,e={message:`Input not instance of ${n.name}`})=>Ma(t=>t instanceof n,e),Da=we.create,Fa=He.create,ri=cr.create,ni=Ge.create,Ua=Rt.create,ai=tt.create,si=ir.create,ii=xt.create,oi=Ct.create,ui=ht.create,ci=Ye.create,li=Me.create,di=or.create,hi=Ee.create,fi=J.create,pi=J.strictCreate,mi=Pt.create,gi=wr.create,yi=Nt.create,_i=xe.create,bi=jt.create,wi=ur.create,vi=rt.create,Ei=lt.create,Oi=Lt.create,Si=Mt.create,Ti=ze.create,ki=Dt.create,Ii=ft.create,jn=Te.create,$i=Oe.create,Ai=Ve.create,Ri=Te.createWithPreprocess,xi=zt.create,Ci=()=>Da().optional(),Pi=()=>Fa().optional(),Ni=()=>Ua().optional(),ji={string:n=>we.create({...n,coerce:!0}),number:n=>He.create({...n,coerce:!0}),boolean:n=>Rt.create({...n,coerce:!0}),bigint:n=>Ge.create({...n,coerce:!0}),date:n=>tt.create({...n,coerce:!0})},Li=x;var Tt=Object.freeze({__proto__:null,defaultErrorMap:dt,setErrorMap:Rs,getErrorMap:nr,makeIssue:ar,EMPTY_PATH:xs,addIssueToContext:w,ParseStatus:te,INVALID:x,DIRTY:ot,OK:se,isAborted:rn,isDirty:nn,isValid:et,isAsync:At,get util(){return B},get objectUtil(){return tn},ZodParsedType:E,getParsedType:Ne,ZodType:M,datetimeRegex:ja,ZodString:we,ZodNumber:He,ZodBigInt:Ge,ZodBoolean:Rt,ZodDate:tt,ZodSymbol:ir,ZodUndefined:xt,ZodNull:Ct,ZodAny:ht,ZodUnknown:Ye,ZodNever:Me,ZodVoid:or,ZodArray:Ee,ZodObject:J,ZodUnion:Pt,ZodDiscriminatedUnion:wr,ZodIntersection:Nt,ZodTuple:xe,ZodRecord:jt,ZodMap:ur,ZodSet:rt,ZodFunction:lt,ZodLazy:Lt,ZodLiteral:Mt,ZodEnum:ze,ZodNativeEnum:Dt,ZodPromise:ft,ZodEffects:Te,ZodTransformer:Te,ZodOptional:Oe,ZodNullable:Ve,ZodDefault:Ft,ZodCatch:Ut,ZodNaN:cr,BRAND:Qs,ZodBranded:gn,ZodPipeline:zt,ZodReadonly:Bt,custom:Ma,Schema:M,ZodSchema:M,late:ei,get ZodFirstPartyTypeKind(){return y},coerce:ji,any:ui,array:hi,bigint:ni,boolean:Ua,date:ai,discriminatedUnion:gi,effect:jn,enum:Ti,function:Ei,instanceof:ti,intersection:yi,lazy:Oi,literal:Si,map:wi,nan:ri,nativeEnum:ki,never:li,null:oi,nullable:Ai,number:Fa,object:fi,oboolean:Ni,onumber:Pi,optional:$i,ostring:Ci,pipeline:xi,preprocess:Ri,promise:Ii,record:bi,set:vi,strictObject:pi,string:Da,symbol:si,transformer:jn,tuple:_i,undefined:ii,union:mi,unknown:ci,void:di,NEVER:Li,ZodIssueCode:g,quotelessJson:As,ZodError:he});function yn(n){return n&&n.__esModule&&Object.prototype.hasOwnProperty.call(n,"default")?n.default:n}var vr={exports:{}},Ba={};function ye(n,e){typeof e=="boolean"&&(e={forever:e}),this._originalTimeouts=JSON.parse(JSON.stringify(n)),this._timeouts=n,this._options=e||{},this._maxRetryTime=e&&e.maxRetryTime||1/0,this._fn=null,this._errors=[],this._attempts=1,this._operationTimeout=null,this._operationTimeoutCb=null,this._timeout=null,this._operationStart=null,this._timer=null,this._options.forever&&(this._cachedTimeouts=this._timeouts.slice(0))}var Mi=ye;ye.prototype.reset=function(){this._attempts=1,this._timeouts=this._originalTimeouts.slice(0)};ye.prototype.stop=function(){this._timeout&&clearTimeout(this._timeout),this._timer&&clearTimeout(this._timer),this._timeouts=[],this._cachedTimeouts=null};ye.prototype.retry=function(n){if(this._timeout&&clearTimeout(this._timeout),!n)return!1;var e=new Date().getTime();if(n&&e-this._operationStart>=this._maxRetryTime)return this._errors.push(n),this._errors.unshift(new Error("RetryOperation timeout occurred")),!1;this._errors.push(n);var t=this._timeouts.shift();if(t===void 0)if(this._cachedTimeouts)this._errors.splice(0,this._errors.length-1),t=this._cachedTimeouts.slice(-1);else return!1;var r=this;return this._timer=setTimeout(function(){r._attempts++,r._operationTimeoutCb&&(r._timeout=setTimeout(function(){r._operationTimeoutCb(r._attempts)},r._operationTimeout),r._options.unref&&r._timeout.unref()),r._fn(r._attempts)},t),this._options.unref&&this._timer.unref(),!0};ye.prototype.attempt=function(n,e){this._fn=n,e&&(e.timeout&&(this._operationTimeout=e.timeout),e.cb&&(this._operationTimeoutCb=e.cb));var t=this;this._operationTimeoutCb&&(this._timeout=setTimeout(function(){t._operationTimeoutCb()},t._operationTimeout)),this._operationStart=new Date().getTime(),this._fn(this._attempts)};ye.prototype.try=function(n){console.log("Using RetryOperation.try() is deprecated"),this.attempt(n)};ye.prototype.start=function(n){console.log("Using RetryOperation.start() is deprecated"),this.attempt(n)};ye.prototype.start=ye.prototype.try;ye.prototype.errors=function(){return this._errors};ye.prototype.attempts=function(){return this._attempts};ye.prototype.mainError=function(){if(this._errors.length===0)return null;for(var n={},e=null,t=0,r=0;r<this._errors.length;r++){var a=this._errors[r],s=a.message,i=(n[s]||0)+1;n[s]=i,i>=t&&(e=a,t=i)}return e};(function(n){var e=Mi;n.operation=function(t){var r=n.timeouts(t);return new e(r,{forever:t&&(t.forever||t.retries===1/0),unref:t&&t.unref,maxRetryTime:t&&t.maxRetryTime})},n.timeouts=function(t){if(t instanceof Array)return[].concat(t);var r={retries:10,factor:2,minTimeout:1*1e3,maxTimeout:1/0,randomize:!1};for(var a in t)r[a]=t[a];if(r.minTimeout>r.maxTimeout)throw new Error("minTimeout is greater than maxTimeout");for(var s=[],i=0;i<r.retries;i++)s.push(this.createTimeout(i,r));return t&&t.forever&&!s.length&&s.push(this.createTimeout(i,r)),s.sort(function(o,u){return o-u}),s},n.createTimeout=function(t,r){var a=r.randomize?Math.random()+1:1,s=Math.round(a*Math.max(r.minTimeout,1)*Math.pow(r.factor,t));return s=Math.min(s,r.maxTimeout),s},n.wrap=function(t,r,a){if(r instanceof Array&&(a=r,r=null),!a){a=[];for(var s in t)typeof t[s]=="function"&&a.push(s)}for(var i=0;i<a.length;i++){var o=a[i],u=t[o];t[o]=function(l){var d=n.operation(r),h=Array.prototype.slice.call(arguments,1),f=h.pop();h.push(function(p){d.retry(p)||(p&&(arguments[0]=d.mainError()),f.apply(this,arguments))}),d.attempt(function(){l.apply(t,h)})}.bind(t,u),t[o].options=r}}})(Ba);var Di=Ba;const Fi=Di,Ui=["Failed to fetch","NetworkError when attempting to fetch resource.","The Internet connection appears to be offline.","Network request failed"];class Za extends Error{constructor(e){super(),e instanceof Error?(this.originalError=e,{message:e}=e):(this.originalError=new Error(e),this.originalError.stack=this.stack),this.name="AbortError",this.message=e}}const Bi=(n,e,t)=>{const r=t.retries-(e-1);return n.attemptNumber=e,n.retriesLeft=r,n},Zi=n=>Ui.includes(n),Ha=(n,e)=>new Promise((t,r)=>{e={onFailedAttempt:()=>{},retries:10,...e};const a=Fi.operation(e);a.attempt(async s=>{try{t(await n(s))}catch(i){if(!(i instanceof Error)){r(new TypeError(`Non-error was thrown: "${i}". You should only throw errors.`));return}if(i instanceof Za)a.stop(),r(i.originalError);else if(i instanceof TypeError&&!Zi(i.message))a.stop(),r(i);else{Bi(i,s,e);try{await e.onFailedAttempt(i)}catch(o){r(o);return}a.retry(i)||r(a.mainError())}}})});vr.exports=Ha;vr.exports.default=Ha;vr.exports.AbortError=Za;var Hi=vr.exports;const lr=yn(Hi);var Ga={},za={exports:{}};(function(n){var e=Object.prototype.hasOwnProperty,t="~";function r(){}Object.create&&(r.prototype=Object.create(null),new r().__proto__||(t=!1));function a(u,c,l){this.fn=u,this.context=c,this.once=l||!1}function s(u,c,l,d,h){if(typeof l!="function")throw new TypeError("The listener must be a function");var f=new a(l,d||u,h),p=t?t+c:c;return u._events[p]?u._events[p].fn?u._events[p]=[u._events[p],f]:u._events[p].push(f):(u._events[p]=f,u._eventsCount++),u}function i(u,c){--u._eventsCount===0?u._events=new r:delete u._events[c]}function o(){this._events=new r,this._eventsCount=0}o.prototype.eventNames=function(){var c=[],l,d;if(this._eventsCount===0)return c;for(d in l=this._events)e.call(l,d)&&c.push(t?d.slice(1):d);return Object.getOwnPropertySymbols?c.concat(Object.getOwnPropertySymbols(l)):c},o.prototype.listeners=function(c){var l=t?t+c:c,d=this._events[l];if(!d)return[];if(d.fn)return[d.fn];for(var h=0,f=d.length,p=new Array(f);h<f;h++)p[h]=d[h].fn;return p},o.prototype.listenerCount=function(c){var l=t?t+c:c,d=this._events[l];return d?d.fn?1:d.length:0},o.prototype.emit=function(c,l,d,h,f,p){var S=t?t+c:c;if(!this._events[S])return!1;var m=this._events[S],_=arguments.length,P,b;if(m.fn){switch(m.once&&this.removeListener(c,m.fn,void 0,!0),_){case 1:return m.fn.call(m.context),!0;case 2:return m.fn.call(m.context,l),!0;case 3:return m.fn.call(m.context,l,d),!0;case 4:return m.fn.call(m.context,l,d,h),!0;case 5:return m.fn.call(m.context,l,d,h,f),!0;case 6:return m.fn.call(m.context,l,d,h,f,p),!0}for(b=1,P=new Array(_-1);b<_;b++)P[b-1]=arguments[b];m.fn.apply(m.context,P)}else{var U=m.length,A;for(b=0;b<U;b++)switch(m[b].once&&this.removeListener(c,m[b].fn,void 0,!0),_){case 1:m[b].fn.call(m[b].context);break;case 2:m[b].fn.call(m[b].context,l);break;case 3:m[b].fn.call(m[b].context,l,d);break;case 4:m[b].fn.call(m[b].context,l,d,h);break;default:if(!P)for(A=1,P=new Array(_-1);A<_;A++)P[A-1]=arguments[A];m[b].fn.apply(m[b].context,P)}}return!0},o.prototype.on=function(c,l,d){return s(this,c,l,d,!1)},o.prototype.once=function(c,l,d){return s(this,c,l,d,!0)},o.prototype.removeListener=function(c,l,d,h){var f=t?t+c:c;if(!this._events[f])return this;if(!l)return i(this,f),this;var p=this._events[f];if(p.fn)p.fn===l&&(!h||p.once)&&(!d||p.context===d)&&i(this,f);else{for(var S=0,m=[],_=p.length;S<_;S++)(p[S].fn!==l||h&&!p[S].once||d&&p[S].context!==d)&&m.push(p[S]);m.length?this._events[f]=m.length===1?m[0]:m:i(this,f)}return this},o.prototype.removeAllListeners=function(c){var l;return c?(l=t?t+c:c,this._events[l]&&i(this,l)):(this._events=new r,this._eventsCount=0),this},o.prototype.off=o.prototype.removeListener,o.prototype.addListener=o.prototype.on,o.prefixed=t,o.EventEmitter=o,n.exports=o})(za);var Gi=za.exports,Er={exports:{}},zi=(n,e)=>(e=e||(()=>{}),n.then(t=>new Promise(r=>{r(e())}).then(()=>t),t=>new Promise(r=>{r(e())}).then(()=>{throw t})));const Vi=zi;class Va extends Error{constructor(e){super(e),this.name="TimeoutError"}}const qa=(n,e,t)=>new Promise((r,a)=>{if(typeof e!="number"||e<0)throw new TypeError("Expected `milliseconds` to be a positive number");if(e===1/0){r(n);return}const s=setTimeout(()=>{if(typeof t=="function"){try{r(t())}catch(u){a(u)}return}const i=typeof t=="string"?t:`Promise timed out after ${e} milliseconds`,o=t instanceof Error?t:new Va(i);typeof n.cancel=="function"&&n.cancel(),a(o)},e);Vi(n.then(r,a),()=>{clearTimeout(s)})});Er.exports=qa;Er.exports.default=qa;Er.exports.TimeoutError=Va;var qi=Er.exports,_n={},bn={};Object.defineProperty(bn,"__esModule",{value:!0});function Wi(n,e,t){let r=0,a=n.length;for(;a>0;){const s=a/2|0;let i=r+s;t(n[i],e)<=0?(r=++i,a-=s+1):a=s}return r}bn.default=Wi;Object.defineProperty(_n,"__esModule",{value:!0});const Ji=bn;class Xi{constructor(){this._queue=[]}enqueue(e,t){t=Object.assign({priority:0},t);const r={priority:t.priority,run:e};if(this.size&&this._queue[this.size-1].priority>=t.priority){this._queue.push(r);return}const a=Ji.default(this._queue,r,(s,i)=>i.priority-s.priority);this._queue.splice(a,0,r)}dequeue(){const e=this._queue.shift();return e?.run}filter(e){return this._queue.filter(t=>t.priority===e.priority).map(t=>t.run)}get size(){return this._queue.length}}_n.default=Xi;Object.defineProperty(Ga,"__esModule",{value:!0});const Ki=Gi,Wa=qi,Yi=_n,Xt=()=>{},Qi=new Wa.TimeoutError;class eo extends Ki{constructor(e){var t,r,a,s;if(super(),this._intervalCount=0,this._intervalEnd=0,this._pendingCount=0,this._resolveEmpty=Xt,this._resolveIdle=Xt,e=Object.assign({carryoverConcurrencyCount:!1,intervalCap:1/0,interval:0,concurrency:1/0,autoStart:!0,queueClass:Yi.default},e),!(typeof e.intervalCap=="number"&&e.intervalCap>=1))throw new TypeError(`Expected \`intervalCap\` to be a number from 1 and up, got \`${(r=(t=e.intervalCap)===null||t===void 0?void 0:t.toString())!==null&&r!==void 0?r:""}\` (${typeof e.intervalCap})`);if(e.interval===void 0||!(Number.isFinite(e.interval)&&e.interval>=0))throw new TypeError(`Expected \`interval\` to be a finite number >= 0, got \`${(s=(a=e.interval)===null||a===void 0?void 0:a.toString())!==null&&s!==void 0?s:""}\` (${typeof e.interval})`);this._carryoverConcurrencyCount=e.carryoverConcurrencyCount,this._isIntervalIgnored=e.intervalCap===1/0||e.interval===0,this._intervalCap=e.intervalCap,this._interval=e.interval,this._queue=new e.queueClass,this._queueClass=e.queueClass,this.concurrency=e.concurrency,this._timeout=e.timeout,this._throwOnTimeout=e.throwOnTimeout===!0,this._isPaused=e.autoStart===!1}get _doesIntervalAllowAnother(){return this._isIntervalIgnored||this._intervalCount<this._intervalCap}get _doesConcurrentAllowAnother(){return this._pendingCount<this._concurrency}_next(){this._pendingCount--,this._tryToStartAnother(),this.emit("next")}_resolvePromises(){this._resolveEmpty(),this._resolveEmpty=Xt,this._pendingCount===0&&(this._resolveIdle(),this._resolveIdle=Xt,this.emit("idle"))}_onResumeInterval(){this._onInterval(),this._initializeIntervalIfNeeded(),this._timeoutId=void 0}_isIntervalPaused(){const e=Date.now();if(this._intervalId===void 0){const t=this._intervalEnd-e;if(t<0)this._intervalCount=this._carryoverConcurrencyCount?this._pendingCount:0;else return this._timeoutId===void 0&&(this._timeoutId=setTimeout(()=>{this._onResumeInterval()},t)),!0}return!1}_tryToStartAnother(){if(this._queue.size===0)return this._intervalId&&clearInterval(this._intervalId),this._intervalId=void 0,this._resolvePromises(),!1;if(!this._isPaused){const e=!this._isIntervalPaused();if(this._doesIntervalAllowAnother&&this._doesConcurrentAllowAnother){const t=this._queue.dequeue();return t?(this.emit("active"),t(),e&&this._initializeIntervalIfNeeded(),!0):!1}}return!1}_initializeIntervalIfNeeded(){this._isIntervalIgnored||this._intervalId!==void 0||(this._intervalId=setInterval(()=>{this._onInterval()},this._interval),this._intervalEnd=Date.now()+this._interval)}_onInterval(){this._intervalCount===0&&this._pendingCount===0&&this._intervalId&&(clearInterval(this._intervalId),this._intervalId=void 0),this._intervalCount=this._carryoverConcurrencyCount?this._pendingCount:0,this._processQueue()}_processQueue(){for(;this._tryToStartAnother(););}get concurrency(){return this._concurrency}set concurrency(e){if(!(typeof e=="number"&&e>=1))throw new TypeError(`Expected \`concurrency\` to be a number from 1 and up, got \`${e}\` (${typeof e})`);this._concurrency=e,this._processQueue()}async add(e,t={}){return new Promise((r,a)=>{const s=async()=>{this._pendingCount++,this._intervalCount++;try{const i=this._timeout===void 0&&t.timeout===void 0?e():Wa.default(Promise.resolve(e()),t.timeout===void 0?this._timeout:t.timeout,()=>{(t.throwOnTimeout===void 0?this._throwOnTimeout:t.throwOnTimeout)&&a(Qi)});r(await i)}catch(i){a(i)}this._next()};this._queue.enqueue(s,t),this._tryToStartAnother(),this.emit("add")})}async addAll(e,t){return Promise.all(e.map(async r=>this.add(r,t)))}start(){return this._isPaused?(this._isPaused=!1,this._processQueue(),this):this}pause(){this._isPaused=!0}clear(){this._queue=new this._queueClass}async onEmpty(){if(this._queue.size!==0)return new Promise(e=>{const t=this._resolveEmpty;this._resolveEmpty=()=>{t(),e()}})}async onIdle(){if(!(this._pendingCount===0&&this._queue.size===0))return new Promise(e=>{const t=this._resolveIdle;this._resolveIdle=()=>{t(),e()}})}get size(){return this._queue.size}sizeBy(e){return this._queue.filter(e).length}get pending(){return this._pendingCount}get isPaused(){return this._isPaused}get timeout(){return this._timeout}set timeout(e){this._timeout=e}}var je=Ga.default=eo;const to=(...n)=>fetch(...n),ro=Symbol.for("ls:fetch_implementation"),k=()=>globalThis[ro]??to,no=[400,401,403,404,405,406,407,408],ao=[409];let Ln=class{constructor(e){Object.defineProperty(this,"maxConcurrency",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"maxRetries",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"queue",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"onFailedResponseHook",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.maxConcurrency=e.maxConcurrency??1/0,this.maxRetries=e.maxRetries??6,"default"in je?this.queue=new je.default({concurrency:this.maxConcurrency}):this.queue=new je({concurrency:this.maxConcurrency}),this.onFailedResponseHook=e?.onFailedResponseHook}call(e,...t){const r=this.onFailedResponseHook;return this.queue.add(()=>lr(()=>e(...t).catch(a=>{throw a instanceof Error?a:new Error(a)}),{async onFailedAttempt(a){if(a.message.startsWith("Cancel")||a.message.startsWith("TimeoutError")||a.message.startsWith("AbortError")||a?.code==="ECONNABORTED")throw a;const s=a?.response,i=s?.status;if(i){if(no.includes(+i))throw a;if(ao.includes(+i))return;r&&await r(s)}},retries:this.maxRetries,randomize:!0}),{throwOnTimeout:!0})}callWithOptions(e,t,...r){return e.signal?Promise.race([this.call(t,...r),new Promise((a,s)=>{e.signal?.addEventListener("abort",()=>{s(new Error("AbortError"))})})]):this.call(t,...r)}fetch(...e){return this.call(()=>k()(...e).then(t=>t.ok?t:Promise.reject(t)))}};function Mn(n){return typeof n?._getType=="function"}function Dn(n){const e={type:n._getType(),data:{content:n.content}};return n?.additional_kwargs&&Object.keys(n.additional_kwargs).length>0&&(e.data.additional_kwargs={...n.additional_kwargs}),e}function D(n,e){if(!St(n)){const t=e!==void 0?`Invalid UUID for ${e}: ${n}`:`Invalid UUID: ${n}`;throw new Error(t)}return n}const Fn={};function Ja(n){Fn[n]||(console.warn(n),Fn[n]=!0)}var sn={exports:{}};const so="2.0.0",Xa=256,io=Number.MAX_SAFE_INTEGER||9007199254740991,oo=16,uo=Xa-6,co=["major","premajor","minor","preminor","patch","prepatch","prerelease"];var Or={MAX_LENGTH:Xa,MAX_SAFE_COMPONENT_LENGTH:oo,MAX_SAFE_BUILD_LENGTH:uo,MAX_SAFE_INTEGER:io,RELEASE_TYPES:co,SEMVER_SPEC_VERSION:so,FLAG_INCLUDE_PRERELEASE:1,FLAG_LOOSE:2},jr={};const lo=typeof process=="object"&&jr&&jr.NODE_DEBUG&&/\bsemver\b/i.test(jr.NODE_DEBUG)?(...n)=>console.error("SEMVER",...n):()=>{};var Sr=lo;(function(n,e){const{MAX_SAFE_COMPONENT_LENGTH:t,MAX_SAFE_BUILD_LENGTH:r,MAX_LENGTH:a}=Or,s=Sr;e=n.exports={};const i=e.re=[],o=e.safeRe=[],u=e.src=[],c=e.t={};let l=0;const d="[a-zA-Z0-9-]",h=[["\\s",1],["\\d",a],[d,r]],f=S=>{for(const[m,_]of h)S=S.split(`${m}*`).join(`${m}{0,${_}}`).split(`${m}+`).join(`${m}{1,${_}}`);return S},p=(S,m,_)=>{const P=f(m),b=l++;s(S,b,m),c[S]=b,u[b]=m,i[b]=new RegExp(m,_?"g":void 0),o[b]=new RegExp(P,_?"g":void 0)};p("NUMERICIDENTIFIER","0|[1-9]\\d*"),p("NUMERICIDENTIFIERLOOSE","\\d+"),p("NONNUMERICIDENTIFIER",`\\d*[a-zA-Z-]${d}*`),p("MAINVERSION",`(${u[c.NUMERICIDENTIFIER]})\\.(${u[c.NUMERICIDENTIFIER]})\\.(${u[c.NUMERICIDENTIFIER]})`),p("MAINVERSIONLOOSE",`(${u[c.NUMERICIDENTIFIERLOOSE]})\\.(${u[c.NUMERICIDENTIFIERLOOSE]})\\.(${u[c.NUMERICIDENTIFIERLOOSE]})`),p("PRERELEASEIDENTIFIER",`(?:${u[c.NUMERICIDENTIFIER]}|${u[c.NONNUMERICIDENTIFIER]})`),p("PRERELEASEIDENTIFIERLOOSE",`(?:${u[c.NUMERICIDENTIFIERLOOSE]}|${u[c.NONNUMERICIDENTIFIER]})`),p("PRERELEASE",`(?:-(${u[c.PRERELEASEIDENTIFIER]}(?:\\.${u[c.PRERELEASEIDENTIFIER]})*))`),p("PRERELEASELOOSE",`(?:-?(${u[c.PRERELEASEIDENTIFIERLOOSE]}(?:\\.${u[c.PRERELEASEIDENTIFIERLOOSE]})*))`),p("BUILDIDENTIFIER",`${d}+`),p("BUILD",`(?:\\+(${u[c.BUILDIDENTIFIER]}(?:\\.${u[c.BUILDIDENTIFIER]})*))`),p("FULLPLAIN",`v?${u[c.MAINVERSION]}${u[c.PRERELEASE]}?${u[c.BUILD]}?`),p("FULL",`^${u[c.FULLPLAIN]}$`),p("LOOSEPLAIN",`[v=\\s]*${u[c.MAINVERSIONLOOSE]}${u[c.PRERELEASELOOSE]}?${u[c.BUILD]}?`),p("LOOSE",`^${u[c.LOOSEPLAIN]}$`),p("GTLT","((?:<|>)?=?)"),p("XRANGEIDENTIFIERLOOSE",`${u[c.NUMERICIDENTIFIERLOOSE]}|x|X|\\*`),p("XRANGEIDENTIFIER",`${u[c.NUMERICIDENTIFIER]}|x|X|\\*`),p("XRANGEPLAIN",`[v=\\s]*(${u[c.XRANGEIDENTIFIER]})(?:\\.(${u[c.XRANGEIDENTIFIER]})(?:\\.(${u[c.XRANGEIDENTIFIER]})(?:${u[c.PRERELEASE]})?${u[c.BUILD]}?)?)?`),p("XRANGEPLAINLOOSE",`[v=\\s]*(${u[c.XRANGEIDENTIFIERLOOSE]})(?:\\.(${u[c.XRANGEIDENTIFIERLOOSE]})(?:\\.(${u[c.XRANGEIDENTIFIERLOOSE]})(?:${u[c.PRERELEASELOOSE]})?${u[c.BUILD]}?)?)?`),p("XRANGE",`^${u[c.GTLT]}\\s*${u[c.XRANGEPLAIN]}$`),p("XRANGELOOSE",`^${u[c.GTLT]}\\s*${u[c.XRANGEPLAINLOOSE]}$`),p("COERCEPLAIN",`(^|[^\\d])(\\d{1,${t}})(?:\\.(\\d{1,${t}}))?(?:\\.(\\d{1,${t}}))?`),p("COERCE",`${u[c.COERCEPLAIN]}(?:$|[^\\d])`),p("COERCEFULL",u[c.COERCEPLAIN]+`(?:${u[c.PRERELEASE]})?(?:${u[c.BUILD]})?(?:$|[^\\d])`),p("COERCERTL",u[c.COERCE],!0),p("COERCERTLFULL",u[c.COERCEFULL],!0),p("LONETILDE","(?:~>?)"),p("TILDETRIM",`(\\s*)${u[c.LONETILDE]}\\s+`,!0),e.tildeTrimReplace="$1~",p("TILDE",`^${u[c.LONETILDE]}${u[c.XRANGEPLAIN]}$`),p("TILDELOOSE",`^${u[c.LONETILDE]}${u[c.XRANGEPLAINLOOSE]}$`),p("LONECARET","(?:\\^)"),p("CARETTRIM",`(\\s*)${u[c.LONECARET]}\\s+`,!0),e.caretTrimReplace="$1^",p("CARET",`^${u[c.LONECARET]}${u[c.XRANGEPLAIN]}$`),p("CARETLOOSE",`^${u[c.LONECARET]}${u[c.XRANGEPLAINLOOSE]}$`),p("COMPARATORLOOSE",`^${u[c.GTLT]}\\s*(${u[c.LOOSEPLAIN]})$|^$`),p("COMPARATOR",`^${u[c.GTLT]}\\s*(${u[c.FULLPLAIN]})$|^$`),p("COMPARATORTRIM",`(\\s*)${u[c.GTLT]}\\s*(${u[c.LOOSEPLAIN]}|${u[c.XRANGEPLAIN]})`,!0),e.comparatorTrimReplace="$1$2$3",p("HYPHENRANGE",`^\\s*(${u[c.XRANGEPLAIN]})\\s+-\\s+(${u[c.XRANGEPLAIN]})\\s*$`),p("HYPHENRANGELOOSE",`^\\s*(${u[c.XRANGEPLAINLOOSE]})\\s+-\\s+(${u[c.XRANGEPLAINLOOSE]})\\s*$`),p("STAR","(<|>)?=?\\s*\\*"),p("GTE0","^\\s*>=\\s*0\\.0\\.0\\s*$"),p("GTE0PRE","^\\s*>=\\s*0\\.0\\.0-0\\s*$")})(sn,sn.exports);var Vt=sn.exports;const ho=Object.freeze({loose:!0}),fo=Object.freeze({}),po=n=>n?typeof n!="object"?ho:n:fo;var wn=po;const Un=/^[0-9]+$/,Ka=(n,e)=>{const t=Un.test(n),r=Un.test(e);return t&&r&&(n=+n,e=+e),n===e?0:t&&!r?-1:r&&!t?1:n<e?-1:1},mo=(n,e)=>Ka(e,n);var Ya={compareIdentifiers:Ka,rcompareIdentifiers:mo};const Kt=Sr,{MAX_LENGTH:Bn,MAX_SAFE_INTEGER:Yt}=Or,{safeRe:Zn,t:Hn}=Vt,go=wn,{compareIdentifiers:at}=Ya;let yo=class $e{constructor(e,t){if(t=go(t),e instanceof $e){if(e.loose===!!t.loose&&e.includePrerelease===!!t.includePrerelease)return e;e=e.version}else if(typeof e!="string")throw new TypeError(`Invalid version. Must be a string. Got type "${typeof e}".`);if(e.length>Bn)throw new TypeError(`version is longer than ${Bn} characters`);Kt("SemVer",e,t),this.options=t,this.loose=!!t.loose,this.includePrerelease=!!t.includePrerelease;const r=e.trim().match(t.loose?Zn[Hn.LOOSE]:Zn[Hn.FULL]);if(!r)throw new TypeError(`Invalid Version: ${e}`);if(this.raw=e,this.major=+r[1],this.minor=+r[2],this.patch=+r[3],this.major>Yt||this.major<0)throw new TypeError("Invalid major version");if(this.minor>Yt||this.minor<0)throw new TypeError("Invalid minor version");if(this.patch>Yt||this.patch<0)throw new TypeError("Invalid patch version");r[4]?this.prerelease=r[4].split(".").map(a=>{if(/^[0-9]+$/.test(a)){const s=+a;if(s>=0&&s<Yt)return s}return a}):this.prerelease=[],this.build=r[5]?r[5].split("."):[],this.format()}format(){return this.version=`${this.major}.${this.minor}.${this.patch}`,this.prerelease.length&&(this.version+=`-${this.prerelease.join(".")}`),this.version}toString(){return this.version}compare(e){if(Kt("SemVer.compare",this.version,this.options,e),!(e instanceof $e)){if(typeof e=="string"&&e===this.version)return 0;e=new $e(e,this.options)}return e.version===this.version?0:this.compareMain(e)||this.comparePre(e)}compareMain(e){return e instanceof $e||(e=new $e(e,this.options)),at(this.major,e.major)||at(this.minor,e.minor)||at(this.patch,e.patch)}comparePre(e){if(e instanceof $e||(e=new $e(e,this.options)),this.prerelease.length&&!e.prerelease.length)return-1;if(!this.prerelease.length&&e.prerelease.length)return 1;if(!this.prerelease.length&&!e.prerelease.length)return 0;let t=0;do{const r=this.prerelease[t],a=e.prerelease[t];if(Kt("prerelease compare",t,r,a),r===void 0&&a===void 0)return 0;if(a===void 0)return 1;if(r===void 0)return-1;if(r===a)continue;return at(r,a)}while(++t)}compareBuild(e){e instanceof $e||(e=new $e(e,this.options));let t=0;do{const r=this.build[t],a=e.build[t];if(Kt("build compare",t,r,a),r===void 0&&a===void 0)return 0;if(a===void 0)return 1;if(r===void 0)return-1;if(r===a)continue;return at(r,a)}while(++t)}inc(e,t,r){switch(e){case"premajor":this.prerelease.length=0,this.patch=0,this.minor=0,this.major++,this.inc("pre",t,r);break;case"preminor":this.prerelease.length=0,this.patch=0,this.minor++,this.inc("pre",t,r);break;case"prepatch":this.prerelease.length=0,this.inc("patch",t,r),this.inc("pre",t,r);break;case"prerelease":this.prerelease.length===0&&this.inc("patch",t,r),this.inc("pre",t,r);break;case"major":(this.minor!==0||this.patch!==0||this.prerelease.length===0)&&this.major++,this.minor=0,this.patch=0,this.prerelease=[];break;case"minor":(this.patch!==0||this.prerelease.length===0)&&this.minor++,this.patch=0,this.prerelease=[];break;case"patch":this.prerelease.length===0&&this.patch++,this.prerelease=[];break;case"pre":{const a=Number(r)?1:0;if(!t&&r===!1)throw new Error("invalid increment argument: identifier is empty");if(this.prerelease.length===0)this.prerelease=[a];else{let s=this.prerelease.length;for(;--s>=0;)typeof this.prerelease[s]=="number"&&(this.prerelease[s]++,s=-2);if(s===-1){if(t===this.prerelease.join(".")&&r===!1)throw new Error("invalid increment argument: identifier already exists");this.prerelease.push(a)}}if(t){let s=[t,a];r===!1&&(s=[t]),at(this.prerelease[0],t)===0?isNaN(this.prerelease[1])&&(this.prerelease=s):this.prerelease=s}break}default:throw new Error(`invalid increment argument: ${e}`)}return this.raw=this.format(),this.build.length&&(this.raw+=`+${this.build.join(".")}`),this}};var ie=yo;const Gn=ie,_o=(n,e,t=!1)=>{if(n instanceof Gn)return n;try{return new Gn(n,e)}catch(r){if(!t)return null;throw r}};var yt=_o;const bo=yt,wo=(n,e)=>{const t=bo(n,e);return t?t.version:null};var vo=wo;const Eo=yt,Oo=(n,e)=>{const t=Eo(n.trim().replace(/^[=v]+/,""),e);return t?t.version:null};var So=Oo;const zn=ie,To=(n,e,t,r,a)=>{typeof t=="string"&&(a=r,r=t,t=void 0);try{return new zn(n instanceof zn?n.version:n,t).inc(e,r,a).version}catch{return null}};var ko=To;const Vn=yt,Io=(n,e)=>{const t=Vn(n,null,!0),r=Vn(e,null,!0),a=t.compare(r);if(a===0)return null;const s=a>0,i=s?t:r,o=s?r:t,u=!!i.prerelease.length;if(!!o.prerelease.length&&!u)return!o.patch&&!o.minor?"major":i.patch?"patch":i.minor?"minor":"major";const l=u?"pre":"";return t.major!==r.major?l+"major":t.minor!==r.minor?l+"minor":t.patch!==r.patch?l+"patch":"prerelease"};var $o=Io;const Ao=ie,Ro=(n,e)=>new Ao(n,e).major;var xo=Ro;const Co=ie,Po=(n,e)=>new Co(n,e).minor;var No=Po;const jo=ie,Lo=(n,e)=>new jo(n,e).patch;var Mo=Lo;const Do=yt,Fo=(n,e)=>{const t=Do(n,e);return t&&t.prerelease.length?t.prerelease:null};var Uo=Fo;const qn=ie,Bo=(n,e,t)=>new qn(n,t).compare(new qn(e,t));var ke=Bo;const Zo=ke,Ho=(n,e,t)=>Zo(e,n,t);var Go=Ho;const zo=ke,Vo=(n,e)=>zo(n,e,!0);var qo=Vo;const Wn=ie,Wo=(n,e,t)=>{const r=new Wn(n,t),a=new Wn(e,t);return r.compare(a)||r.compareBuild(a)};var vn=Wo;const Jo=vn,Xo=(n,e)=>n.sort((t,r)=>Jo(t,r,e));var Ko=Xo;const Yo=vn,Qo=(n,e)=>n.sort((t,r)=>Yo(r,t,e));var eu=Qo;const tu=ke,ru=(n,e,t)=>tu(n,e,t)>0;var Tr=ru;const nu=ke,au=(n,e,t)=>nu(n,e,t)<0;var En=au;const su=ke,iu=(n,e,t)=>su(n,e,t)===0;var Qa=iu;const ou=ke,uu=(n,e,t)=>ou(n,e,t)!==0;var es=uu;const cu=ke,lu=(n,e,t)=>cu(n,e,t)>=0;var On=lu;const du=ke,hu=(n,e,t)=>du(n,e,t)<=0;var Sn=hu;const fu=Qa,pu=es,mu=Tr,gu=On,yu=En,_u=Sn,bu=(n,e,t,r)=>{switch(e){case"===":return typeof n=="object"&&(n=n.version),typeof t=="object"&&(t=t.version),n===t;case"!==":return typeof n=="object"&&(n=n.version),typeof t=="object"&&(t=t.version),n!==t;case"":case"=":case"==":return fu(n,t,r);case"!=":return pu(n,t,r);case">":return mu(n,t,r);case">=":return gu(n,t,r);case"<":return yu(n,t,r);case"<=":return _u(n,t,r);default:throw new TypeError(`Invalid operator: ${e}`)}};var ts=bu;const wu=ie,vu=yt,{safeRe:Qt,t:er}=Vt,Eu=(n,e)=>{if(n instanceof wu)return n;if(typeof n=="number"&&(n=String(n)),typeof n!="string")return null;e=e||{};let t=null;if(!e.rtl)t=n.match(e.includePrerelease?Qt[er.COERCEFULL]:Qt[er.COERCE]);else{const u=e.includePrerelease?Qt[er.COERCERTLFULL]:Qt[er.COERCERTL];let c;for(;(c=u.exec(n))&&(!t||t.index+t[0].length!==n.length);)(!t||c.index+c[0].length!==t.index+t[0].length)&&(t=c),u.lastIndex=c.index+c[1].length+c[2].length;u.lastIndex=-1}if(t===null)return null;const r=t[2],a=t[3]||"0",s=t[4]||"0",i=e.includePrerelease&&t[5]?`-${t[5]}`:"",o=e.includePrerelease&&t[6]?`+${t[6]}`:"";return vu(`${r}.${a}.${s}${i}${o}`,e)};var Ou=Eu;class Su{constructor(){this.max=1e3,this.map=new Map}get(e){const t=this.map.get(e);if(t!==void 0)return this.map.delete(e),this.map.set(e,t),t}delete(e){return this.map.delete(e)}set(e,t){if(!this.delete(e)&&t!==void 0){if(this.map.size>=this.max){const a=this.map.keys().next().value;this.delete(a)}this.map.set(e,t)}return this}}var Tu=Su,Lr,Jn;function Ie(){if(Jn)return Lr;Jn=1;const n=/\s+/g;class e{constructor(v,R){if(R=a(R),v instanceof e)return v.loose===!!R.loose&&v.includePrerelease===!!R.includePrerelease?v:new e(v.raw,R);if(v instanceof s)return this.raw=v.value,this.set=[[v]],this.formatted=void 0,this;if(this.options=R,this.loose=!!R.loose,this.includePrerelease=!!R.includePrerelease,this.raw=v.trim().replace(n," "),this.set=this.raw.split("||").map(I=>this.parseRange(I.trim())).filter(I=>I.length),!this.set.length)throw new TypeError(`Invalid SemVer Range: ${this.raw}`);if(this.set.length>1){const I=this.set[0];if(this.set=this.set.filter(C=>!S(C[0])),this.set.length===0)this.set=[I];else if(this.set.length>1){for(const C of this.set)if(C.length===1&&m(C[0])){this.set=[C];break}}}this.formatted=void 0}get range(){if(this.formatted===void 0){this.formatted="";for(let v=0;v<this.set.length;v++){v>0&&(this.formatted+="||");const R=this.set[v];for(let I=0;I<R.length;I++)I>0&&(this.formatted+=" "),this.formatted+=R[I].toString().trim()}}return this.formatted}format(){return this.range}toString(){return this.range}parseRange(v){const I=((this.options.includePrerelease&&f)|(this.options.loose&&p))+":"+v,C=r.get(I);if(C)return C;const $=this.options.loose,j=$?u[c.HYPHENRANGELOOSE]:u[c.HYPHENRANGE];v=v.replace(j,Ts(this.options.includePrerelease)),i("hyphen replace",v),v=v.replace(u[c.COMPARATORTRIM],l),i("comparator trim",v),v=v.replace(u[c.TILDETRIM],d),i("tilde trim",v),v=v.replace(u[c.CARETTRIM],h),i("caret trim",v);let z=v.split(" ").map(X=>P(X,this.options)).join(" ").split(/\s+/).map(X=>Ss(X,this.options));$&&(z=z.filter(X=>(i("loose invalid filter",X,this.options),!!X.match(u[c.COMPARATORLOOSE])))),i("range list",z);const F=new Map,W=z.map(X=>new s(X,this.options));for(const X of W){if(S(X))return[X];F.set(X.value,X)}F.size>1&&F.has("")&&F.delete("");const ce=[...F.values()];return r.set(I,ce),ce}intersects(v,R){if(!(v instanceof e))throw new TypeError("a Range is required");return this.set.some(I=>_(I,R)&&v.set.some(C=>_(C,R)&&I.every($=>C.every(j=>$.intersects(j,R)))))}test(v){if(!v)return!1;if(typeof v=="string")try{v=new o(v,this.options)}catch{return!1}for(let R=0;R<this.set.length;R++)if(ks(this.set[R],v,this.options))return!0;return!1}}Lr=e;const t=Tu,r=new t,a=wn,s=kr(),i=Sr,o=ie,{safeRe:u,t:c,comparatorTrimReplace:l,tildeTrimReplace:d,caretTrimReplace:h}=Vt,{FLAG_INCLUDE_PRERELEASE:f,FLAG_LOOSE:p}=Or,S=O=>O.value==="<0.0.0-0",m=O=>O.value==="",_=(O,v)=>{let R=!0;const I=O.slice();let C=I.pop();for(;R&&I.length;)R=I.every($=>C.intersects($,v)),C=I.pop();return R},P=(O,v)=>(i("comp",O,v),O=H(O,v),i("caret",O),O=U(O,v),i("tildes",O),O=pe(O,v),i("xrange",O),O=Pr(O,v),i("stars",O),O),b=O=>!O||O.toLowerCase()==="x"||O==="*",U=(O,v)=>O.trim().split(/\s+/).map(R=>A(R,v)).join(" "),A=(O,v)=>{const R=v.loose?u[c.TILDELOOSE]:u[c.TILDE];return O.replace(R,(I,C,$,j,z)=>{i("tilde",O,I,C,$,j,z);let F;return b(C)?F="":b($)?F=`>=${C}.0.0 <${+C+1}.0.0-0`:b(j)?F=`>=${C}.${$}.0 <${C}.${+$+1}.0-0`:z?(i("replaceTilde pr",z),F=`>=${C}.${$}.${j}-${z} <${C}.${+$+1}.0-0`):F=`>=${C}.${$}.${j} <${C}.${+$+1}.0-0`,i("tilde return",F),F})},H=(O,v)=>O.trim().split(/\s+/).map(R=>q(R,v)).join(" "),q=(O,v)=>{i("caret",O,v);const R=v.loose?u[c.CARETLOOSE]:u[c.CARET],I=v.includePrerelease?"-0":"";return O.replace(R,(C,$,j,z,F)=>{i("caret",O,C,$,j,z,F);let W;return b($)?W="":b(j)?W=`>=${$}.0.0${I} <${+$+1}.0.0-0`:b(z)?$==="0"?W=`>=${$}.${j}.0${I} <${$}.${+j+1}.0-0`:W=`>=${$}.${j}.0${I} <${+$+1}.0.0-0`:F?(i("replaceCaret pr",F),$==="0"?j==="0"?W=`>=${$}.${j}.${z}-${F} <${$}.${j}.${+z+1}-0`:W=`>=${$}.${j}.${z}-${F} <${$}.${+j+1}.0-0`:W=`>=${$}.${j}.${z}-${F} <${+$+1}.0.0-0`):(i("no pr"),$==="0"?j==="0"?W=`>=${$}.${j}.${z}${I} <${$}.${j}.${+z+1}-0`:W=`>=${$}.${j}.${z}${I} <${$}.${+j+1}.0-0`:W=`>=${$}.${j}.${z} <${+$+1}.0.0-0`),i("caret return",W),W})},pe=(O,v)=>(i("replaceXRanges",O,v),O.split(/\s+/).map(R=>nt(R,v)).join(" ")),nt=(O,v)=>{O=O.trim();const R=v.loose?u[c.XRANGELOOSE]:u[c.XRANGE];return O.replace(R,(I,C,$,j,z,F)=>{i("xRange",O,I,C,$,j,z,F);const W=b($),ce=W||b(j),X=ce||b(z),bt=X;return C==="="&&bt&&(C=""),F=v.includePrerelease?"-0":"",W?C===">"||C==="<"?I="<0.0.0-0":I="*":C&&bt?(ce&&(j=0),z=0,C===">"?(C=">=",ce?($=+$+1,j=0,z=0):(j=+j+1,z=0)):C==="<="&&(C="<",ce?$=+$+1:j=+j+1),C==="<"&&(F="-0"),I=`${C+$}.${j}.${z}${F}`):ce?I=`>=${$}.0.0${F} <${+$+1}.0.0-0`:X&&(I=`>=${$}.${j}.0${F} <${$}.${+j+1}.0-0`),i("xRange return",I),I})},Pr=(O,v)=>(i("replaceStars",O,v),O.trim().replace(u[c.STAR],"")),Ss=(O,v)=>(i("replaceGTE0",O,v),O.trim().replace(u[v.includePrerelease?c.GTE0PRE:c.GTE0],"")),Ts=O=>(v,R,I,C,$,j,z,F,W,ce,X,bt)=>(b(I)?R="":b(C)?R=`>=${I}.0.0${O?"-0":""}`:b($)?R=`>=${I}.${C}.0${O?"-0":""}`:j?R=`>=${R}`:R=`>=${R}${O?"-0":""}`,b(W)?F="":b(ce)?F=`<${+W+1}.0.0-0`:b(X)?F=`<${W}.${+ce+1}.0-0`:bt?F=`<=${W}.${ce}.${X}-${bt}`:O?F=`<${W}.${ce}.${+X+1}-0`:F=`<=${F}`,`${R} ${F}`.trim()),ks=(O,v,R)=>{for(let I=0;I<O.length;I++)if(!O[I].test(v))return!1;if(v.prerelease.length&&!R.includePrerelease){for(let I=0;I<O.length;I++)if(i(O[I].semver),O[I].semver!==s.ANY&&O[I].semver.prerelease.length>0){const C=O[I].semver;if(C.major===v.major&&C.minor===v.minor&&C.patch===v.patch)return!0}return!1}return!0};return Lr}var Mr,Xn;function kr(){if(Xn)return Mr;Xn=1;const n=Symbol("SemVer ANY");class e{static get ANY(){return n}constructor(l,d){if(d=t(d),l instanceof e){if(l.loose===!!d.loose)return l;l=l.value}l=l.trim().split(/\s+/).join(" "),i("comparator",l,d),this.options=d,this.loose=!!d.loose,this.parse(l),this.semver===n?this.value="":this.value=this.operator+this.semver.version,i("comp",this)}parse(l){const d=this.options.loose?r[a.COMPARATORLOOSE]:r[a.COMPARATOR],h=l.match(d);if(!h)throw new TypeError(`Invalid comparator: ${l}`);this.operator=h[1]!==void 0?h[1]:"",this.operator==="="&&(this.operator=""),h[2]?this.semver=new o(h[2],this.options.loose):this.semver=n}toString(){return this.value}test(l){if(i("Comparator.test",l,this.options.loose),this.semver===n||l===n)return!0;if(typeof l=="string")try{l=new o(l,this.options)}catch{return!1}return s(l,this.operator,this.semver,this.options)}intersects(l,d){if(!(l instanceof e))throw new TypeError("a Comparator is required");return this.operator===""?this.value===""?!0:new u(l.value,d).test(this.value):l.operator===""?l.value===""?!0:new u(this.value,d).test(l.semver):(d=t(d),d.includePrerelease&&(this.value==="<0.0.0-0"||l.value==="<0.0.0-0")||!d.includePrerelease&&(this.value.startsWith("<0.0.0")||l.value.startsWith("<0.0.0"))?!1:!!(this.operator.startsWith(">")&&l.operator.startsWith(">")||this.operator.startsWith("<")&&l.operator.startsWith("<")||this.semver.version===l.semver.version&&this.operator.includes("=")&&l.operator.includes("=")||s(this.semver,"<",l.semver,d)&&this.operator.startsWith(">")&&l.operator.startsWith("<")||s(this.semver,">",l.semver,d)&&this.operator.startsWith("<")&&l.operator.startsWith(">")))}}Mr=e;const t=wn,{safeRe:r,t:a}=Vt,s=ts,i=Sr,o=ie,u=Ie();return Mr}const ku=Ie(),Iu=(n,e,t)=>{try{e=new ku(e,t)}catch{return!1}return e.test(n)};var Ir=Iu;const $u=Ie(),Au=(n,e)=>new $u(n,e).set.map(t=>t.map(r=>r.value).join(" ").trim().split(" "));var Ru=Au;const xu=ie,Cu=Ie(),Pu=(n,e,t)=>{let r=null,a=null,s=null;try{s=new Cu(e,t)}catch{return null}return n.forEach(i=>{s.test(i)&&(!r||a.compare(i)===-1)&&(r=i,a=new xu(r,t))}),r};var Nu=Pu;const ju=ie,Lu=Ie(),Mu=(n,e,t)=>{let r=null,a=null,s=null;try{s=new Lu(e,t)}catch{return null}return n.forEach(i=>{s.test(i)&&(!r||a.compare(i)===1)&&(r=i,a=new ju(r,t))}),r};var Du=Mu;const Dr=ie,Fu=Ie(),Kn=Tr,Uu=(n,e)=>{n=new Fu(n,e);let t=new Dr("0.0.0");if(n.test(t)||(t=new Dr("0.0.0-0"),n.test(t)))return t;t=null;for(let r=0;r<n.set.length;++r){const a=n.set[r];let s=null;a.forEach(i=>{const o=new Dr(i.semver.version);switch(i.operator){case">":o.prerelease.length===0?o.patch++:o.prerelease.push(0),o.raw=o.format();case"":case">=":(!s||Kn(o,s))&&(s=o);break;case"<":case"<=":break;default:throw new Error(`Unexpected operation: ${i.operator}`)}}),s&&(!t||Kn(t,s))&&(t=s)}return t&&n.test(t)?t:null};var Bu=Uu;const Zu=Ie(),Hu=(n,e)=>{try{return new Zu(n,e).range||"*"}catch{return null}};var Gu=Hu;const zu=ie,rs=kr(),{ANY:Vu}=rs,qu=Ie(),Wu=Ir,Yn=Tr,Qn=En,Ju=Sn,Xu=On,Ku=(n,e,t,r)=>{n=new zu(n,r),e=new qu(e,r);let a,s,i,o,u;switch(t){case">":a=Yn,s=Ju,i=Qn,o=">",u=">=";break;case"<":a=Qn,s=Xu,i=Yn,o="<",u="<=";break;default:throw new TypeError('Must provide a hilo val of "<" or ">"')}if(Wu(n,e,r))return!1;for(let c=0;c<e.set.length;++c){const l=e.set[c];let d=null,h=null;if(l.forEach(f=>{f.semver===Vu&&(f=new rs(">=0.0.0")),d=d||f,h=h||f,a(f.semver,d.semver,r)?d=f:i(f.semver,h.semver,r)&&(h=f)}),d.operator===o||d.operator===u||(!h.operator||h.operator===o)&&s(n,h.semver))return!1;if(h.operator===u&&i(n,h.semver))return!1}return!0};var Tn=Ku;const Yu=Tn,Qu=(n,e,t)=>Yu(n,e,">",t);var ec=Qu;const tc=Tn,rc=(n,e,t)=>tc(n,e,"<",t);var nc=rc;const ea=Ie(),ac=(n,e,t)=>(n=new ea(n,t),e=new ea(e,t),n.intersects(e,t));var sc=ac;const ic=Ir,oc=ke;var uc=(n,e,t)=>{const r=[];let a=null,s=null;const i=n.sort((l,d)=>oc(l,d,t));for(const l of i)ic(l,e,t)?(s=l,a||(a=l)):(s&&r.push([a,s]),s=null,a=null);a&&r.push([a,null]);const o=[];for(const[l,d]of r)l===d?o.push(l):!d&&l===i[0]?o.push("*"):d?l===i[0]?o.push(`<=${d}`):o.push(`${l} - ${d}`):o.push(`>=${l}`);const u=o.join(" || "),c=typeof e.raw=="string"?e.raw:String(e);return u.length<c.length?u:e};const ta=Ie(),kn=kr(),{ANY:Fr}=kn,wt=Ir,In=ke,cc=(n,e,t={})=>{if(n===e)return!0;n=new ta(n,t),e=new ta(e,t);let r=!1;e:for(const a of n.set){for(const s of e.set){const i=dc(a,s,t);if(r=r||i!==null,i)continue e}if(r)return!1}return!0},lc=[new kn(">=0.0.0-0")],ra=[new kn(">=0.0.0")],dc=(n,e,t)=>{if(n===e)return!0;if(n.length===1&&n[0].semver===Fr){if(e.length===1&&e[0].semver===Fr)return!0;t.includePrerelease?n=lc:n=ra}if(e.length===1&&e[0].semver===Fr){if(t.includePrerelease)return!0;e=ra}const r=new Set;let a,s;for(const f of n)f.operator===">"||f.operator===">="?a=na(a,f,t):f.operator==="<"||f.operator==="<="?s=aa(s,f,t):r.add(f.semver);if(r.size>1)return null;let i;if(a&&s){if(i=In(a.semver,s.semver,t),i>0)return null;if(i===0&&(a.operator!==">="||s.operator!=="<="))return null}for(const f of r){if(a&&!wt(f,String(a),t)||s&&!wt(f,String(s),t))return null;for(const p of e)if(!wt(f,String(p),t))return!1;return!0}let o,u,c,l,d=s&&!t.includePrerelease&&s.semver.prerelease.length?s.semver:!1,h=a&&!t.includePrerelease&&a.semver.prerelease.length?a.semver:!1;d&&d.prerelease.length===1&&s.operator==="<"&&d.prerelease[0]===0&&(d=!1);for(const f of e){if(l=l||f.operator===">"||f.operator===">=",c=c||f.operator==="<"||f.operator==="<=",a){if(h&&f.semver.prerelease&&f.semver.prerelease.length&&f.semver.major===h.major&&f.semver.minor===h.minor&&f.semver.patch===h.patch&&(h=!1),f.operator===">"||f.operator===">="){if(o=na(a,f,t),o===f&&o!==a)return!1}else if(a.operator===">="&&!wt(a.semver,String(f),t))return!1}if(s){if(d&&f.semver.prerelease&&f.semver.prerelease.length&&f.semver.major===d.major&&f.semver.minor===d.minor&&f.semver.patch===d.patch&&(d=!1),f.operator==="<"||f.operator==="<="){if(u=aa(s,f,t),u===f&&u!==s)return!1}else if(s.operator==="<="&&!wt(s.semver,String(f),t))return!1}if(!f.operator&&(s||a)&&i!==0)return!1}return!(a&&c&&!s&&i!==0||s&&l&&!a&&i!==0||h||d)},na=(n,e,t)=>{if(!n)return e;const r=In(n.semver,e.semver,t);return r>0?n:r<0||e.operator===">"&&n.operator===">="?e:n},aa=(n,e,t)=>{if(!n)return e;const r=In(n.semver,e.semver,t);return r<0?n:r>0||e.operator==="<"&&n.operator==="<="?e:n};var hc=cc;const Ur=Vt,sa=Or,fc=ie,ia=Ya,pc=yt,mc=vo,gc=So,yc=ko,_c=$o,bc=xo,wc=No,vc=Mo,Ec=Uo,Oc=ke,Sc=Go,Tc=qo,kc=vn,Ic=Ko,$c=eu,Ac=Tr,Rc=En,xc=Qa,Cc=es,Pc=On,Nc=Sn,jc=ts,Lc=Ou,Mc=kr(),Dc=Ie(),Fc=Ir,Uc=Ru,Bc=Nu,Zc=Du,Hc=Bu,Gc=Gu,zc=Tn,Vc=ec,qc=nc,Wc=sc,Jc=uc,Xc=hc;Ur.re,Ur.src,Ur.t,sa.SEMVER_SPEC_VERSION,sa.RELEASE_TYPES,ia.compareIdentifiers,ia.rcompareIdentifiers;function De(n){if(!n||n.split("/").length>2||n.startsWith("/")||n.endsWith("/")||n.split(":").length>2)throw new Error(`Invalid identifier format: ${n}`);const[e,t]=n.split(":"),r=t||"latest";if(e.includes("/")){const[a,s]=e.split("/",2);if(!a||!s)throw new Error(`Invalid identifier format: ${n}`);return[a,s,r]}else{if(!e)throw new Error(`Invalid identifier format: ${n}`);return["-",e,r]}}class Kc extends Error{constructor(e){super(e),this.name="LangSmithConflictError"}}async function L(n,e,t){let r;if(n.ok){t&&(r=await n.text());return}r=await n.text();const a=`Failed to ${e}. Received status [${n.status}]: ${n.statusText}. Server response: ${r}`;throw n.status===409?new Kc(a):new Error(a)}var oa="[...]",Yc={result:"[Circular]"},dr=[],ut=[];function Qc(){return{depthLimit:Number.MAX_SAFE_INTEGER,edgesLimit:Number.MAX_SAFE_INTEGER}}function le(n,e,t,r){try{return JSON.stringify(n,e,t)}catch(i){if(!i.message?.includes("Converting circular structure to JSON"))return console.warn("[WARNING]: LangSmith received unserializable value."),"[Unserializable]";console.warn("[WARNING]: LangSmith received circular JSON. This will decrease tracer performance."),typeof r>"u"&&(r=Qc()),on(n,"",0,[],void 0,0,r);var a;try{ut.length===0?a=JSON.stringify(n,e,t):a=JSON.stringify(n,el(e),t)}catch{return JSON.stringify("[unable to serialize, circular reference is too complex to analyze]")}finally{for(;dr.length!==0;){var s=dr.pop();s.length===4?Object.defineProperty(s[0],s[1],s[3]):s[0][s[1]]=s[2]}}return a}}function Br(n,e,t,r){var a=Object.getOwnPropertyDescriptor(r,t);a.get!==void 0?a.configurable?(Object.defineProperty(r,t,{value:n}),dr.push([r,t,e,a])):ut.push([e,t,n]):(r[t]=n,dr.push([r,t,e]))}function on(n,e,t,r,a,s,i){s+=1;var o;if(typeof n=="object"&&n!==null){for(o=0;o<r.length;o++)if(r[o]===n){Br(Yc,n,e,a);return}if(typeof i.depthLimit<"u"&&s>i.depthLimit){Br(oa,n,e,a);return}if(typeof i.edgesLimit<"u"&&t+1>i.edgesLimit){Br(oa,n,e,a);return}if(r.push(n),Array.isArray(n))for(o=0;o<n.length;o++)on(n[o],o,o,r,n,s,i);else{var u=Object.keys(n);for(o=0;o<u.length;o++){var c=u[o];on(n[c],c,o,r,n,s,i)}}r.pop()}}function el(n){return n=typeof n<"u"?n:function(e,t){return t},function(e,t){if(ut.length>0)for(var r=0;r<ut.length;r++){var a=ut[r];if(a[1]===e&&a[0]===t){t=a[2],ut.splice(r,1);break}}return n.call(this,e,t)}}function ua(n){const e=ss(),t=fl(),r=n.extra??{},a=r.metadata;return n.extra={...r,runtime:{...e,...r?.runtime},metadata:{...t,...t.revision_id||n.revision_id?{revision_id:n.revision_id??t.revision_id}:{},...a}},n}const tl=()=>{const n=Je("TRACING_SAMPLING_RATE");if(n===void 0)return;const e=parseFloat(n);if(e<0||e>1)throw new Error(`LANGSMITH_TRACING_SAMPLING_RATE must be between 0 and 1 if set. Got: ${e}`);return e},rl=n=>{const t=n.replace("http://","").replace("https://","").split("/")[0].split(":")[0];return t==="localhost"||t==="127.0.0.1"||t==="::1"};async function nl(n){const e=[];for await(const t of n)e.push(t);return e}function Zr(n){if(n!==void 0)return n.trim().replace(/^"(.*)"$/,"$1").replace(/^'(.*)'$/,"$1")}const al=async n=>{if(n?.status===429){const e=parseInt(n.headers.get("retry-after")??"30",10)*1e3;if(e>0)return await new Promise(t=>setTimeout(t,e)),!0}return!1};class sl{constructor(){Object.defineProperty(this,"items",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"sizeBytes",{enumerable:!0,configurable:!0,writable:!0,value:0})}peek(){return this.items[0]}push(e){let t;const r=new Promise(s=>{t=s}),a=le(e.item).length;return this.items.push({action:e.action,payload:e.item,itemPromiseResolve:t,itemPromise:r,size:a}),this.sizeBytes+=a,r}pop(e){if(e<1)throw new Error("Number of bytes to pop off may not be less than 1.");const t=[];let r=0;for(;r+(this.peek()?.size??0)<e&&this.items.length>0;){const a=this.items.shift();a&&(t.push(a),r+=a.size,this.sizeBytes-=a.size)}if(t.length===0&&this.items.length>0){const a=this.items.shift();t.push(a),r+=a.size,this.sizeBytes-=a.size}return[t.map(a=>({action:a.action,item:a.payload})),()=>t.forEach(a=>a.itemPromiseResolve())]}}const il=20971520,ol=2500;class Zt{constructor(e={}){Object.defineProperty(this,"apiKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"apiUrl",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"webUrl",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"caller",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"batchIngestCaller",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"timeout_ms",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_tenantId",{enumerable:!0,configurable:!0,writable:!0,value:null}),Object.defineProperty(this,"hideInputs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"hideOutputs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tracingSampleRate",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"filteredPostUuids",{enumerable:!0,configurable:!0,writable:!0,value:new Set}),Object.defineProperty(this,"autoBatchTracing",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"autoBatchQueue",{enumerable:!0,configurable:!0,writable:!0,value:new sl}),Object.defineProperty(this,"autoBatchTimeout",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"autoBatchAggregationDelayMs",{enumerable:!0,configurable:!0,writable:!0,value:250}),Object.defineProperty(this,"batchSizeBytesLimit",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"fetchOptions",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"settings",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"blockOnRootRunFinalization",{enumerable:!0,configurable:!0,writable:!0,value:Be("LANGSMITH_TRACING_BACKGROUND")==="false"}),Object.defineProperty(this,"traceBatchConcurrency",{enumerable:!0,configurable:!0,writable:!0,value:5}),Object.defineProperty(this,"_serverInfo",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_getServerInfoPromise",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"manualFlushMode",{enumerable:!0,configurable:!0,writable:!0,value:!1});const t=Zt.getDefaultClientConfig();if(this.tracingSampleRate=tl(),this.apiUrl=Zr(e.apiUrl??t.apiUrl)??"",this.apiUrl.endsWith("/")&&(this.apiUrl=this.apiUrl.slice(0,-1)),this.apiKey=Zr(e.apiKey??t.apiKey),this.webUrl=Zr(e.webUrl??t.webUrl),this.webUrl?.endsWith("/")&&(this.webUrl=this.webUrl.slice(0,-1)),this.timeout_ms=e.timeout_ms??9e4,this.caller=new Ln(e.callerOptions??{}),this.traceBatchConcurrency=e.traceBatchConcurrency??this.traceBatchConcurrency,this.traceBatchConcurrency<1)throw new Error("Trace batch concurrency must be positive.");this.batchIngestCaller=new Ln({maxRetries:2,maxConcurrency:this.traceBatchConcurrency,...e.callerOptions??{},onFailedResponseHook:al}),this.hideInputs=e.hideInputs??e.anonymizer??t.hideInputs,this.hideOutputs=e.hideOutputs??e.anonymizer??t.hideOutputs,this.autoBatchTracing=e.autoBatchTracing??this.autoBatchTracing,this.blockOnRootRunFinalization=e.blockOnRootRunFinalization??this.blockOnRootRunFinalization,this.batchSizeBytesLimit=e.batchSizeBytesLimit,this.fetchOptions=e.fetchOptions||{},this.manualFlushMode=e.manualFlushMode??this.manualFlushMode}static getDefaultClientConfig(){const e=Je("API_KEY"),t=Je("ENDPOINT")??"https://api.smith.langchain.com",r=Je("HIDE_INPUTS")==="true",a=Je("HIDE_OUTPUTS")==="true";return{apiUrl:t,apiKey:e,webUrl:void 0,hideInputs:r,hideOutputs:a}}getHostUrl(){return this.webUrl?this.webUrl:rl(this.apiUrl)?(this.webUrl="http://localhost:3000",this.webUrl):this.apiUrl.includes("/api")&&!this.apiUrl.split(".",1)[0].endsWith("api")?(this.webUrl=this.apiUrl.replace("/api",""),this.webUrl):this.apiUrl.split(".",1)[0].includes("dev")?(this.webUrl="https://dev.smith.langchain.com",this.webUrl):this.apiUrl.split(".",1)[0].includes("eu")?(this.webUrl="https://eu.smith.langchain.com",this.webUrl):(this.webUrl="https://smith.langchain.com",this.webUrl)}get headers(){const e={"User-Agent":`langsmith-js/${ns}`};return this.apiKey&&(e["x-api-key"]=`${this.apiKey}`),e}processInputs(e){return this.hideInputs===!1?e:this.hideInputs===!0?{}:typeof this.hideInputs=="function"?this.hideInputs(e):e}processOutputs(e){return this.hideOutputs===!1?e:this.hideOutputs===!0?{}:typeof this.hideOutputs=="function"?this.hideOutputs(e):e}prepareRunCreateOrUpdateInputs(e){const t={...e};return t.inputs!==void 0&&(t.inputs=this.processInputs(t.inputs)),t.outputs!==void 0&&(t.outputs=this.processOutputs(t.outputs)),t}async _getResponse(e,t){const r=t?.toString()??"",a=`${this.apiUrl}${e}?${r}`,s=await this.caller.call(k(),a,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await L(s,`Failed to fetch ${e}`),s}async _get(e,t){return(await this._getResponse(e,t)).json()}async*_getPaginated(e,t=new URLSearchParams,r){let a=Number(t.get("offset"))||0;const s=Number(t.get("limit"))||100;for(;;){t.set("offset",String(a)),t.set("limit",String(s));const i=`${this.apiUrl}${e}?${t}`,o=await this.caller.call(k(),i,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await L(o,`Failed to fetch ${e}`);const u=r?r(await o.json()):await o.json();if(u.length===0||(yield u,u.length<s))break;a+=u.length}}async*_getCursorPaginatedList(e,t=null,r="POST",a="runs"){const s=t?{...t}:{};for(;;){const o=await(await this.caller.call(k(),`${this.apiUrl}${e}`,{method:r,headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:JSON.stringify(s)})).json();if(!o||!o[a])break;yield o[a];const u=o.cursors;if(!u||!u.next)break;s.cursor=u.next}}_filterForSampling(e,t=!1){if(this.tracingSampleRate===void 0)return e;if(t){const r=[];for(const a of e)this.filteredPostUuids.has(a.id)?this.filteredPostUuids.delete(a.id):r.push(a);return r}else{const r=[];for(const a of e)a.id!==a.trace_id&&!this.filteredPostUuids.has(a.trace_id)||Math.random()<this.tracingSampleRate?r.push(a):this.filteredPostUuids.add(a.id);return r}}async _getBatchSizeLimitBytes(){const e=await this._ensureServerInfo();return this.batchSizeBytesLimit??e.batch_ingest_config?.size_limit_bytes??il}async _getMultiPartSupport(){return(await this._ensureServerInfo()).instance_flags?.dataset_examples_multipart_enabled??!1}drainAutoBatchQueue(e){const t=[];for(;this.autoBatchQueue.items.length>0;){const[r,a]=this.autoBatchQueue.pop(e);if(!r.length){a();break}const s=this._processBatch(r,a).catch(console.error);t.push(s)}return Promise.all(t)}async _processBatch(e,t){if(!e.length){t();return}try{const r={runCreates:e.filter(s=>s.action==="create").map(s=>s.item),runUpdates:e.filter(s=>s.action==="update").map(s=>s.item)};(await this._ensureServerInfo())?.batch_ingest_config?.use_multipart_endpoint?await this.multipartIngestRuns(r):await this.batchIngestRuns(r)}finally{t()}}async processRunOperation(e){clearTimeout(this.autoBatchTimeout),this.autoBatchTimeout=void 0,e.action==="create"&&(e.item=ua(e.item));const t=this.autoBatchQueue.push(e);if(this.manualFlushMode)return t;const r=await this._getBatchSizeLimitBytes();return this.autoBatchQueue.sizeBytes>r&&this.drainAutoBatchQueue(r),this.autoBatchQueue.items.length>0&&(this.autoBatchTimeout=setTimeout(()=>{this.autoBatchTimeout=void 0,this.drainAutoBatchQueue(r)},this.autoBatchAggregationDelayMs)),t}async _getServerInfo(){const e=await k()(`${this.apiUrl}/info`,{method:"GET",headers:{Accept:"application/json"},signal:AbortSignal.timeout(ol),...this.fetchOptions});return await L(e,"get server info"),e.json()}async _ensureServerInfo(){return this._getServerInfoPromise===void 0&&(this._getServerInfoPromise=(async()=>{if(this._serverInfo===void 0)try{this._serverInfo=await this._getServerInfo()}catch{console.warn("[WARNING]: LangSmith failed to fetch info on supported operations. Falling back to batch operations and default limits.")}return this._serverInfo??{}})()),this._getServerInfoPromise.then(e=>(this._serverInfo===void 0&&(this._getServerInfoPromise=void 0),e))}async _getSettings(){return this.settings||(this.settings=this._get("/settings")),await this.settings}async flush(){const e=await this._getBatchSizeLimitBytes();await this.drainAutoBatchQueue(e)}async createRun(e){if(!this._filterForSampling([e]).length)return;const t={...this.headers,"Content-Type":"application/json"},r=e.project_name;delete e.project_name;const a=this.prepareRunCreateOrUpdateInputs({session_name:r,...e,start_time:e.start_time??Date.now()});if(this.autoBatchTracing&&a.trace_id!==void 0&&a.dotted_order!==void 0){this.processRunOperation({action:"create",item:a}).catch(console.error);return}const s=ua(a),i=await this.caller.call(k(),`${this.apiUrl}/runs`,{method:"POST",headers:t,body:le(s),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await L(i,"create run",!0)}async batchIngestRuns({runCreates:e,runUpdates:t}){if(e===void 0&&t===void 0)return;let r=e?.map(o=>this.prepareRunCreateOrUpdateInputs(o))??[],a=t?.map(o=>this.prepareRunCreateOrUpdateInputs(o))??[];if(r.length>0&&a.length>0){const o=r.reduce((c,l)=>(l.id&&(c[l.id]=l),c),{}),u=[];for(const c of a)c.id!==void 0&&o[c.id]?o[c.id]={...o[c.id],...c}:u.push(c);r=Object.values(o),a=u}const s={post:this._filterForSampling(r),patch:this._filterForSampling(a,!0)};if(!s.post.length&&!s.patch.length)return;const i={post:[],patch:[]};for(const o of["post","patch"]){const u=o,c=s[u].reverse();let l=c.pop();for(;l!==void 0;)i[u].push(l),l=c.pop()}(i.post.length>0||i.patch.length>0)&&await this._postBatchIngestRuns(le(i))}async _postBatchIngestRuns(e){const t={...this.headers,"Content-Type":"application/json",Accept:"application/json"},r=await this.batchIngestCaller.call(k(),`${this.apiUrl}/runs/batch`,{method:"POST",headers:t,body:e,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await L(r,"batch create run",!0)}async multipartIngestRuns({runCreates:e,runUpdates:t}){if(e===void 0&&t===void 0)return;const r={};let a=[];for(const l of e??[]){const d=this.prepareRunCreateOrUpdateInputs(l);d.id!==void 0&&d.attachments!==void 0&&(r[d.id]=d.attachments),delete d.attachments,a.push(d)}let s=[];for(const l of t??[])s.push(this.prepareRunCreateOrUpdateInputs(l));if(a.find(l=>l.trace_id===void 0||l.dotted_order===void 0)!==void 0)throw new Error('Multipart ingest requires "trace_id" and "dotted_order" to be set when creating a run');if(s.find(l=>l.trace_id===void 0||l.dotted_order===void 0)!==void 0)throw new Error('Multipart ingest requires "trace_id" and "dotted_order" to be set when updating a run');if(a.length>0&&s.length>0){const l=a.reduce((h,f)=>(f.id&&(h[f.id]=f),h),{}),d=[];for(const h of s)h.id!==void 0&&l[h.id]?l[h.id]={...l[h.id],...h}:d.push(h);a=Object.values(l),s=d}if(a.length===0&&s.length===0)return;const u=[],c=[];for(const[l,d]of[["post",a],["patch",s]])for(const h of d){const{inputs:f,outputs:p,events:S,attachments:m,..._}=h,P={inputs:f,outputs:p,events:S},b=le(_);c.push({name:`${l}.${_.id}`,payload:new Blob([b],{type:`application/json; length=${b.length}`})});for(const[U,A]of Object.entries(P)){if(A===void 0)continue;const H=le(A);c.push({name:`${l}.${_.id}.${U}`,payload:new Blob([H],{type:`application/json; length=${H.length}`})})}if(_.id!==void 0){const U=r[_.id];if(U){delete r[_.id];for(const[A,H]of Object.entries(U)){let q,pe;if(Array.isArray(H)?[q,pe]=H:(q=H.mimeType,pe=H.data),A.includes(".")){console.warn(`Skipping attachment '${A}' for run ${_.id}: Invalid attachment name. Attachment names must not contain periods ('.'). Please rename the attachment and try again.`);continue}c.push({name:`attachment.${_.id}.${A}`,payload:new Blob([pe],{type:`${q}; length=${pe.byteLength}`})})}}}u.push(`trace=${_.trace_id},id=${_.id}`)}await this._sendMultipartRequest(c,u.join("; "))}async _sendMultipartRequest(e,t){try{const r="----LangSmithFormBoundary"+Math.random().toString(36).slice(2),a=[];for(const u of e)a.push(new Blob([`--${r}\r
`])),a.push(new Blob([`Content-Disposition: form-data; name="${u.name}"\r
`,`Content-Type: ${u.payload.type}\r
\r
`])),a.push(u.payload),a.push(new Blob([`\r
`]));a.push(new Blob([`--${r}--\r
`]));const i=await new Blob(a).arrayBuffer(),o=await this.batchIngestCaller.call(k(),`${this.apiUrl}/runs/multipart`,{method:"POST",headers:{...this.headers,"Content-Type":`multipart/form-data; boundary=${r}`},body:i,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await L(o,"ingest multipart runs",!0)}catch(r){console.warn(`${r.message.trim()}

Context: ${t}`)}}async updateRun(e,t){D(e),t.inputs&&(t.inputs=this.processInputs(t.inputs)),t.outputs&&(t.outputs=this.processOutputs(t.outputs));const r={...t,id:e};if(!this._filterForSampling([r],!0).length)return;if(this.autoBatchTracing&&r.trace_id!==void 0&&r.dotted_order!==void 0){if(t.end_time!==void 0&&r.parent_run_id===void 0&&this.blockOnRootRunFinalization&&!this.manualFlushMode){await this.processRunOperation({action:"update",item:r}).catch(console.error);return}else this.processRunOperation({action:"update",item:r}).catch(console.error);return}const a={...this.headers,"Content-Type":"application/json"},s=await this.caller.call(k(),`${this.apiUrl}/runs/${e}`,{method:"PATCH",headers:a,body:le(t),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await L(s,"update run",!0)}async readRun(e,{loadChildRuns:t}={loadChildRuns:!1}){D(e);let r=await this._get(`/runs/${e}`);return t&&r.child_run_ids&&(r=await this._loadChildRuns(r)),r}async getRunUrl({runId:e,run:t,projectOpts:r}){if(t!==void 0){let a;t.session_id?a=t.session_id:r?.projectName?a=(await this.readProject({projectName:r?.projectName})).id:r?.projectId?a=r?.projectId:a=(await this.readProject({projectName:Je("PROJECT")||"default"})).id;const s=await this._getTenantId();return`${this.getHostUrl()}/o/${s}/projects/p/${a}/r/${t.id}?poll=true`}else if(e!==void 0){const a=await this.readRun(e);if(!a.app_path)throw new Error(`Run ${e} has no app_path`);return`${this.getHostUrl()}${a.app_path}`}else throw new Error("Must provide either runId or run")}async _loadChildRuns(e){const t=await nl(this.listRuns({id:e.child_run_ids})),r={},a={};t.sort((s,i)=>(s?.dotted_order??"").localeCompare(i?.dotted_order??""));for(const s of t){if(s.parent_run_id===null||s.parent_run_id===void 0)throw new Error(`Child run ${s.id} has no parent`);s.parent_run_id in r||(r[s.parent_run_id]=[]),r[s.parent_run_id].push(s),a[s.id]=s}e.child_runs=r[e.id]||[];for(const s in r)s!==e.id&&(a[s].child_runs=r[s]);return e}async*listRuns(e){const{projectId:t,projectName:r,parentRunId:a,traceId:s,referenceExampleId:i,startTime:o,executionOrder:u,isRoot:c,runType:l,error:d,id:h,query:f,filter:p,traceFilter:S,treeFilter:m,limit:_,select:P}=e;let b=[];if(t&&(b=Array.isArray(t)?t:[t]),r){const q=Array.isArray(r)?r:[r],pe=await Promise.all(q.map(nt=>this.readProject({projectName:nt}).then(Pr=>Pr.id)));b.push(...pe)}const U=["app_path","child_run_ids","completion_cost","completion_tokens","dotted_order","end_time","error","events","extra","feedback_stats","first_token_time","id","inputs","name","outputs","parent_run_id","parent_run_ids","prompt_cost","prompt_tokens","reference_example_id","run_type","session_id","start_time","status","tags","total_cost","total_tokens","trace_id"],A={session:b.length?b:null,run_type:l,reference_example:i,query:f,filter:p,trace_filter:S,tree_filter:m,execution_order:u,parent_run:a,start_time:o?o.toISOString():null,error:d,id:h,limit:_,trace:s,select:P||U,is_root:c};let H=0;for await(const q of this._getCursorPaginatedList("/runs/query",A))if(_){if(H>=_)break;if(q.length+H>_){yield*q.slice(0,_-H);break}H+=q.length,yield*q}else yield*q}async getRunStats({id:e,trace:t,parentRun:r,runType:a,projectNames:s,projectIds:i,referenceExampleIds:o,startTime:u,endTime:c,error:l,query:d,filter:h,traceFilter:f,treeFilter:p,isRoot:S,dataSourceType:m}){let _=i||[];s&&(_=[...i||[],...await Promise.all(s.map(H=>this.readProject({projectName:H}).then(q=>q.id)))]);const b=Object.fromEntries(Object.entries({id:e,trace:t,parent_run:r,run_type:a,session:_,reference_example:o,start_time:u,end_time:c,error:l,query:d,filter:h,trace_filter:f,tree_filter:p,is_root:S,data_source_type:m}).filter(([H,q])=>q!==void 0));return await(await this.caller.call(k(),`${this.apiUrl}/runs/stats`,{method:"POST",headers:this.headers,body:JSON.stringify(b),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions})).json()}async shareRun(e,{shareId:t}={}){const r={run_id:e,share_token:t||ue()};D(e);const s=await(await this.caller.call(k(),`${this.apiUrl}/runs/${e}/share`,{method:"PUT",headers:this.headers,body:JSON.stringify(r),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions})).json();if(s===null||!("share_token"in s))throw new Error("Invalid response from server");return`${this.getHostUrl()}/public/${s.share_token}/r`}async unshareRun(e){D(e);const t=await this.caller.call(k(),`${this.apiUrl}/runs/${e}/share`,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await L(t,"unshare run",!0)}async readRunSharedLink(e){D(e);const r=await(await this.caller.call(k(),`${this.apiUrl}/runs/${e}/share`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions})).json();if(!(r===null||!("share_token"in r)))return`${this.getHostUrl()}/public/${r.share_token}/r`}async listSharedRuns(e,{runIds:t}={}){const r=new URLSearchParams({share_token:e});if(t!==void 0)for(const i of t)r.append("id",i);return D(e),await(await this.caller.call(k(),`${this.apiUrl}/public/${e}/runs${r}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions})).json()}async readDatasetSharedSchema(e,t){if(!e&&!t)throw new Error("Either datasetId or datasetName must be given");e||(e=(await this.readDataset({datasetName:t})).id),D(e);const a=await(await this.caller.call(k(),`${this.apiUrl}/datasets/${e}/share`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions})).json();return a.url=`${this.getHostUrl()}/public/${a.share_token}/d`,a}async shareDataset(e,t){if(!e&&!t)throw new Error("Either datasetId or datasetName must be given");e||(e=(await this.readDataset({datasetName:t})).id);const r={dataset_id:e};D(e);const s=await(await this.caller.call(k(),`${this.apiUrl}/datasets/${e}/share`,{method:"PUT",headers:this.headers,body:JSON.stringify(r),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions})).json();return s.url=`${this.getHostUrl()}/public/${s.share_token}/d`,s}async unshareDataset(e){D(e);const t=await this.caller.call(k(),`${this.apiUrl}/datasets/${e}/share`,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await L(t,"unshare dataset",!0)}async readSharedDataset(e){return D(e),await(await this.caller.call(k(),`${this.apiUrl}/public/${e}/datasets`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions})).json()}async listSharedExamples(e,t){const r={};t?.exampleIds&&(r.id=t.exampleIds);const a=new URLSearchParams;Object.entries(r).forEach(([o,u])=>{Array.isArray(u)?u.forEach(c=>a.append(o,c)):a.append(o,u)});const s=await this.caller.call(k(),`${this.apiUrl}/public/${e}/examples?${a.toString()}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions}),i=await s.json();if(!s.ok)throw"detail"in i?new Error(`Failed to list shared examples.
Status: ${s.status}
Message: ${i.detail.join(`
`)}`):new Error(`Failed to list shared examples: ${s.status} ${s.statusText}`);return i.map(o=>({...o,_hostUrl:this.getHostUrl()}))}async createProject({projectName:e,description:t=null,metadata:r=null,upsert:a=!1,projectExtra:s=null,referenceDatasetId:i=null}){const o=a?"?upsert=true":"",u=`${this.apiUrl}/sessions${o}`,c=s||{};r&&(c.metadata=r);const l={name:e,extra:c,description:t};i!==null&&(l.reference_dataset_id=i);const d=await this.caller.call(k(),u,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(l),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await L(d,"create project"),await d.json()}async updateProject(e,{name:t=null,description:r=null,metadata:a=null,projectExtra:s=null,endTime:i=null}){const o=`${this.apiUrl}/sessions/${e}`;let u=s;a&&(u={...u||{},metadata:a});const c={name:t,extra:u,description:r,end_time:i?new Date(i).toISOString():null},l=await this.caller.call(k(),o,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(c),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await L(l,"update project"),await l.json()}async hasProject({projectId:e,projectName:t}){let r="/sessions";const a=new URLSearchParams;if(e!==void 0&&t!==void 0)throw new Error("Must provide either projectName or projectId, not both");if(e!==void 0)D(e),r+=`/${e}`;else if(t!==void 0)a.append("name",t);else throw new Error("Must provide projectName or projectId");const s=await this.caller.call(k(),`${this.apiUrl}${r}?${a}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});try{const i=await s.json();return s.ok?Array.isArray(i)?i.length>0:!0:!1}catch{return!1}}async readProject({projectId:e,projectName:t,includeStats:r}){let a="/sessions";const s=new URLSearchParams;if(e!==void 0&&t!==void 0)throw new Error("Must provide either projectName or projectId, not both");if(e!==void 0)D(e),a+=`/${e}`;else if(t!==void 0)s.append("name",t);else throw new Error("Must provide projectName or projectId");r!==void 0&&s.append("include_stats",r.toString());const i=await this._get(a,s);let o;if(Array.isArray(i)){if(i.length===0)throw new Error(`Project[id=${e}, name=${t}] not found`);o=i[0]}else o=i;return o}async getProjectUrl({projectId:e,projectName:t}){if(e===void 0&&t===void 0)throw new Error("Must provide either projectName or projectId");const r=await this.readProject({projectId:e,projectName:t}),a=await this._getTenantId();return`${this.getHostUrl()}/o/${a}/projects/p/${r.id}`}async getDatasetUrl({datasetId:e,datasetName:t}){if(e===void 0&&t===void 0)throw new Error("Must provide either datasetName or datasetId");const r=await this.readDataset({datasetId:e,datasetName:t}),a=await this._getTenantId();return`${this.getHostUrl()}/o/${a}/datasets/${r.id}`}async _getTenantId(){if(this._tenantId!==null)return this._tenantId;const e=new URLSearchParams({limit:"1"});for await(const t of this._getPaginated("/sessions",e))return this._tenantId=t[0].tenant_id,t[0].tenant_id;throw new Error("No projects found to resolve tenant.")}async*listProjects({projectIds:e,name:t,nameContains:r,referenceDatasetId:a,referenceDatasetName:s,referenceFree:i,metadata:o}={}){const u=new URLSearchParams;if(e!==void 0)for(const c of e)u.append("id",c);if(t!==void 0&&u.append("name",t),r!==void 0&&u.append("name_contains",r),a!==void 0)u.append("reference_dataset",a);else if(s!==void 0){const c=await this.readDataset({datasetName:s});u.append("reference_dataset",c.id)}i!==void 0&&u.append("reference_free",i.toString()),o!==void 0&&u.append("metadata",JSON.stringify(o));for await(const c of this._getPaginated("/sessions",u))yield*c}async deleteProject({projectId:e,projectName:t}){let r;if(e===void 0&&t===void 0)throw new Error("Must provide projectName or projectId");if(e!==void 0&&t!==void 0)throw new Error("Must provide either projectName or projectId, not both");e===void 0?r=(await this.readProject({projectName:t})).id:r=e,D(r);const a=await this.caller.call(k(),`${this.apiUrl}/sessions/${r}`,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await L(a,`delete session ${r} (${t})`,!0)}async uploadCsv({csvFile:e,fileName:t,inputKeys:r,outputKeys:a,description:s,dataType:i,name:o}){const u=`${this.apiUrl}/datasets/upload`,c=new FormData;c.append("file",e,t),r.forEach(h=>{c.append("input_keys",h)}),a.forEach(h=>{c.append("output_keys",h)}),s&&c.append("description",s),i&&c.append("data_type",i),o&&c.append("name",o);const l=await this.caller.call(k(),u,{method:"POST",headers:this.headers,body:c,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await L(l,"upload CSV"),await l.json()}async createDataset(e,{description:t,dataType:r,inputsSchema:a,outputsSchema:s,metadata:i}={}){const o={name:e,description:t,extra:i?{metadata:i}:void 0};r&&(o.data_type=r),a&&(o.inputs_schema_definition=a),s&&(o.outputs_schema_definition=s);const u=await this.caller.call(k(),`${this.apiUrl}/datasets`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(o),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await L(u,"create dataset"),await u.json()}async readDataset({datasetId:e,datasetName:t}){let r="/datasets";const a=new URLSearchParams({limit:"1"});if(e!==void 0&&t!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");if(e!==void 0)D(e),r+=`/${e}`;else if(t!==void 0)a.append("name",t);else throw new Error("Must provide datasetName or datasetId");const s=await this._get(r,a);let i;if(Array.isArray(s)){if(s.length===0)throw new Error(`Dataset[id=${e}, name=${t}] not found`);i=s[0]}else i=s;return i}async hasDataset({datasetId:e,datasetName:t}){try{return await this.readDataset({datasetId:e,datasetName:t}),!0}catch(r){if(r instanceof Error&&r.message.toLocaleLowerCase().includes("not found"))return!1;throw r}}async diffDatasetVersions({datasetId:e,datasetName:t,fromVersion:r,toVersion:a}){let s=e;if(s===void 0&&t===void 0)throw new Error("Must provide either datasetName or datasetId");if(s!==void 0&&t!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");s===void 0&&(s=(await this.readDataset({datasetName:t})).id);const i=new URLSearchParams({from_version:typeof r=="string"?r:r.toISOString(),to_version:typeof a=="string"?a:a.toISOString()});return await this._get(`/datasets/${s}/versions/diff`,i)}async readDatasetOpenaiFinetuning({datasetId:e,datasetName:t}){const r="/datasets";if(e===void 0)if(t!==void 0)e=(await this.readDataset({datasetName:t})).id;else throw new Error("Must provide datasetName or datasetId");return(await(await this._getResponse(`${r}/${e}/openai_ft`)).text()).trim().split(`
`).map(o=>JSON.parse(o))}async*listDatasets({limit:e=100,offset:t=0,datasetIds:r,datasetName:a,datasetNameContains:s,metadata:i}={}){const o="/datasets",u=new URLSearchParams({limit:e.toString(),offset:t.toString()});if(r!==void 0)for(const c of r)u.append("id",c);a!==void 0&&u.append("name",a),s!==void 0&&u.append("name_contains",s),i!==void 0&&u.append("metadata",JSON.stringify(i));for await(const c of this._getPaginated(o,u))yield*c}async updateDataset(e){const{datasetId:t,datasetName:r,...a}=e;if(!t&&!r)throw new Error("Must provide either datasetName or datasetId");const s=t??(await this.readDataset({datasetName:r})).id;D(s);const i=await this.caller.call(k(),`${this.apiUrl}/datasets/${s}`,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(a),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await L(i,"update dataset"),await i.json()}async deleteDataset({datasetId:e,datasetName:t}){let r="/datasets",a=e;if(e!==void 0&&t!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");if(t!==void 0&&(a=(await this.readDataset({datasetName:t})).id),a!==void 0)D(a),r+=`/${a}`;else throw new Error("Must provide datasetName or datasetId");const s=await this.caller.call(k(),this.apiUrl+r,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await L(s,`delete ${r}`),await s.json()}async indexDataset({datasetId:e,datasetName:t,tag:r}){let a=e;if(!a&&!t)throw new Error("Must provide either datasetName or datasetId");if(a&&t)throw new Error("Must provide either datasetName or datasetId, not both");a||(a=(await this.readDataset({datasetName:t})).id),D(a);const s={tag:r},i=await this.caller.call(k(),`${this.apiUrl}/datasets/${a}/index`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(s),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await L(i,"index dataset"),await i.json()}async similarExamples(e,t,r,{filter:a}={}){const s={limit:r,inputs:e};a!==void 0&&(s.filter=a),D(t);const i=await this.caller.call(k(),`${this.apiUrl}/datasets/${t}/search`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(s),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await L(i,"fetch similar examples"),(await i.json()).examples}async createExample(e,t,{datasetId:r,datasetName:a,createdAt:s,exampleId:i,metadata:o,split:u,sourceRunId:c}){let l=r;if(l===void 0&&a===void 0)throw new Error("Must provide either datasetName or datasetId");if(l!==void 0&&a!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");l===void 0&&(l=(await this.readDataset({datasetName:a})).id);const h={dataset_id:l,inputs:e,outputs:t,created_at:(s||new Date)?.toISOString(),id:i,metadata:o,split:u,source_run_id:c},f=await this.caller.call(k(),`${this.apiUrl}/examples`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(h),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await L(f,"create example"),await f.json()}async createExamples(e){const{inputs:t,outputs:r,metadata:a,sourceRunIds:s,exampleIds:i,datasetId:o,datasetName:u}=e;let c=o;if(c===void 0&&u===void 0)throw new Error("Must provide either datasetName or datasetId");if(c!==void 0&&u!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");c===void 0&&(c=(await this.readDataset({datasetName:u})).id);const l=t.map((f,p)=>({dataset_id:c,inputs:f,outputs:r?r[p]:void 0,metadata:a?a[p]:void 0,split:e.splits?e.splits[p]:void 0,id:i?i[p]:void 0,source_run_id:s?s[p]:void 0})),d=await this.caller.call(k(),`${this.apiUrl}/examples/bulk`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(l),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await L(d,"create examples"),await d.json()}async createLLMExample(e,t,r){return this.createExample({input:e},{output:t},r)}async createChatExample(e,t,r){const a=e.map(i=>Mn(i)?Dn(i):i),s=Mn(t)?Dn(t):t;return this.createExample({input:a},{output:s},r)}async readExample(e){D(e);const t=`/examples/${e}`,r=await this._get(t),{attachment_urls:a,...s}=r,i=s;return a&&(i.attachments=Object.entries(a).reduce((o,[u,c])=>(o[u.slice(11)]={presigned_url:c.presigned_url},o),{})),i}async*listExamples({datasetId:e,datasetName:t,exampleIds:r,asOf:a,splits:s,inlineS3Urls:i,metadata:o,limit:u,offset:c,filter:l,includeAttachments:d}={}){let h;if(e!==void 0&&t!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");if(e!==void 0)h=e;else if(t!==void 0)h=(await this.readDataset({datasetName:t})).id;else throw new Error("Must provide a datasetName or datasetId");const f=new URLSearchParams({dataset:h}),p=a?typeof a=="string"?a:a?.toISOString():void 0;p&&f.append("as_of",p);const S=i??!0;if(f.append("inline_s3_urls",S.toString()),r!==void 0)for(const _ of r)f.append("id",_);if(s!==void 0)for(const _ of s)f.append("splits",_);if(o!==void 0){const _=JSON.stringify(o);f.append("metadata",_)}u!==void 0&&f.append("limit",u.toString()),c!==void 0&&f.append("offset",c.toString()),l!==void 0&&f.append("filter",l),d===!0&&["attachment_urls","outputs","metadata"].forEach(_=>f.append("select",_));let m=0;for await(const _ of this._getPaginated("/examples",f)){for(const P of _){const{attachment_urls:b,...U}=P,A=U;b&&(A.attachments=Object.entries(b).reduce((H,[q,pe])=>(H[q.slice(11)]={presigned_url:pe.presigned_url},H),{})),yield A,m++}if(u!==void 0&&m>=u)break}}async deleteExample(e){D(e);const t=`/examples/${e}`,r=await this.caller.call(k(),this.apiUrl+t,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await L(r,`delete ${t}`),await r.json()}async updateExample(e,t){D(e);const r=await this.caller.call(k(),`${this.apiUrl}/examples/${e}`,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(t),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await L(r,"update example"),await r.json()}async updateExamples(e){const t=await this.caller.call(k(),`${this.apiUrl}/examples/bulk`,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(e),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await L(t,"update examples"),await t.json()}async listDatasetSplits({datasetId:e,datasetName:t,asOf:r}){let a;if(e===void 0&&t===void 0)throw new Error("Must provide dataset name or ID");if(e!==void 0&&t!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");e===void 0?a=(await this.readDataset({datasetName:t})).id:a=e,D(a);const s=new URLSearchParams,i=r?typeof r=="string"?r:r?.toISOString():void 0;return i&&s.append("as_of",i),await this._get(`/datasets/${a}/splits`,s)}async updateDatasetSplits({datasetId:e,datasetName:t,splitName:r,exampleIds:a,remove:s=!1}){let i;if(e===void 0&&t===void 0)throw new Error("Must provide dataset name or ID");if(e!==void 0&&t!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");e===void 0?i=(await this.readDataset({datasetName:t})).id:i=e,D(i);const o={split_name:r,examples:a.map(c=>(D(c),c)),remove:s},u=await this.caller.call(k(),`${this.apiUrl}/datasets/${i}/splits`,{method:"PUT",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(o),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await L(u,"update dataset splits",!0)}async evaluateRun(e,t,{sourceInfo:r,loadChildRuns:a,referenceExample:s}={loadChildRuns:!1}){Ja("This method is deprecated and will be removed in future LangSmith versions, use `evaluate` from `langsmith/evaluation` instead.");let i;if(typeof e=="string")i=await this.readRun(e,{loadChildRuns:a});else if(typeof e=="object"&&"id"in e)i=e;else throw new Error(`Invalid run type: ${typeof e}`);i.reference_example_id!==null&&i.reference_example_id!==void 0&&(s=await this.readExample(i.reference_example_id));const o=await t.evaluateRun(i,s),[u,c]=await this._logEvaluationFeedback(o,i,r);return c[0]}async createFeedback(e,t,{score:r,value:a,correction:s,comment:i,sourceInfo:o,feedbackSourceType:u="api",sourceRunId:c,feedbackId:l,feedbackConfig:d,projectId:h,comparativeExperimentId:f}){if(!e&&!h)throw new Error("One of runId or projectId must be provided");if(e&&h)throw new Error("Only one of runId or projectId can be provided");const p={type:u??"api",metadata:o??{}};c!==void 0&&p?.metadata!==void 0&&!p.metadata.__run&&(p.metadata.__run={run_id:c}),p?.metadata!==void 0&&p.metadata.__run?.run_id!==void 0&&D(p.metadata.__run.run_id);const S={id:l??ue(),run_id:e,key:t,score:r,value:a,correction:s,comment:i,feedback_source:p,comparative_experiment_id:f,feedbackConfig:d,session_id:h},m=`${this.apiUrl}/feedback`,_=await this.caller.call(k(),m,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(S),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await L(_,"create feedback",!0),S}async updateFeedback(e,{score:t,value:r,correction:a,comment:s}){const i={};t!=null&&(i.score=t),r!=null&&(i.value=r),a!=null&&(i.correction=a),s!=null&&(i.comment=s),D(e);const o=await this.caller.call(k(),`${this.apiUrl}/feedback/${e}`,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(i),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await L(o,"update feedback",!0)}async readFeedback(e){D(e);const t=`/feedback/${e}`;return await this._get(t)}async deleteFeedback(e){D(e);const t=`/feedback/${e}`,r=await this.caller.call(k(),this.apiUrl+t,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await L(r,`delete ${t}`),await r.json()}async*listFeedback({runIds:e,feedbackKeys:t,feedbackSourceTypes:r}={}){const a=new URLSearchParams;if(e&&a.append("run",e.join(",")),t)for(const s of t)a.append("key",s);if(r)for(const s of r)a.append("source",s);for await(const s of this._getPaginated("/feedback",a))yield*s}async createPresignedFeedbackToken(e,t,{expiration:r,feedbackConfig:a}={}){const s={run_id:e,feedback_key:t,feedback_config:a};return r?typeof r=="string"?s.expires_at=r:(r?.hours||r?.minutes||r?.days)&&(s.expires_in=r):s.expires_in={hours:3},await(await this.caller.call(k(),`${this.apiUrl}/feedback/tokens`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(s),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions})).json()}async createComparativeExperiment({name:e,experimentIds:t,referenceDatasetId:r,createdAt:a,description:s,metadata:i,id:o}){if(t.length===0)throw new Error("At least one experiment is required");if(r||(r=(await this.readProject({projectId:t[0]})).reference_dataset_id),!r==null)throw new Error("A reference dataset is required");const u={id:o,name:e,experiment_ids:t,reference_dataset_id:r,description:s,created_at:(a??new Date)?.toISOString(),extra:{}};return i&&(u.extra.metadata=i),await(await this.caller.call(k(),`${this.apiUrl}/datasets/comparative`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(u),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions})).json()}async*listPresignedFeedbackTokens(e){D(e);const t=new URLSearchParams({run_id:e});for await(const r of this._getPaginated("/feedback/tokens",t))yield*r}_selectEvalResults(e){let t;return"results"in e?t=e.results:t=[e],t}async _logEvaluationFeedback(e,t,r){const a=this._selectEvalResults(e),s=[];for(const i of a){let o=r||{};i.evaluatorInfo&&(o={...i.evaluatorInfo,...o});let u=null;i.targetRunId?u=i.targetRunId:t&&(u=t.id),s.push(await this.createFeedback(u,i.key,{score:i.score,value:i.value,comment:i.comment,correction:i.correction,sourceInfo:o,sourceRunId:i.sourceRunId,feedbackConfig:i.feedbackConfig,feedbackSourceType:"model"}))}return[a,s]}async logEvaluationFeedback(e,t,r){const[a]=await this._logEvaluationFeedback(e,t,r);return a}async*listAnnotationQueues(e={}){const{queueIds:t,name:r,nameContains:a,limit:s}=e,i=new URLSearchParams;t&&t.forEach((u,c)=>{D(u,`queueIds[${c}]`),i.append("ids",u)}),r&&i.append("name",r),a&&i.append("name_contains",a),i.append("limit",(s!==void 0?Math.min(s,100):100).toString());let o=0;for await(const u of this._getPaginated("/annotation-queues",i))if(yield*u,o++,s!==void 0&&o>=s)break}async createAnnotationQueue(e){const{name:t,description:r,queueId:a}=e,s={name:t,description:r,id:a||ue()},i=await this.caller.call(k(),`${this.apiUrl}/annotation-queues`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(Object.fromEntries(Object.entries(s).filter(([u,c])=>c!==void 0))),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await L(i,"create annotation queue"),await i.json()}async readAnnotationQueue(e){const t=await this.listAnnotationQueues({queueIds:[e]}).next();if(t.done)throw new Error(`Annotation queue with ID ${e} not found`);return t.value}async updateAnnotationQueue(e,t){const{name:r,description:a}=t,s=await this.caller.call(k(),`${this.apiUrl}/annotation-queues/${D(e,"queueId")}`,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify({name:r,description:a}),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await L(s,"update annotation queue")}async deleteAnnotationQueue(e){const t=await this.caller.call(k(),`${this.apiUrl}/annotation-queues/${D(e,"queueId")}`,{method:"DELETE",headers:{...this.headers,Accept:"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await L(t,"delete annotation queue")}async addRunsToAnnotationQueue(e,t){const r=await this.caller.call(k(),`${this.apiUrl}/annotation-queues/${D(e,"queueId")}/runs`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(t.map((a,s)=>D(a,`runIds[${s}]`).toString())),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await L(r,"add runs to annotation queue")}async getRunFromAnnotationQueue(e,t){const r=`/annotation-queues/${D(e,"queueId")}/run`,a=await this.caller.call(k(),`${this.apiUrl}${r}/${t}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await L(a,"get run from annotation queue"),await a.json()}async deleteRunFromAnnotationQueue(e,t){const r=await this.caller.call(k(),`${this.apiUrl}/annotation-queues/${D(e,"queueId")}/runs/${D(t,"queueRunId")}`,{method:"DELETE",headers:{...this.headers,Accept:"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await L(r,"delete run from annotation queue")}async getSizeFromAnnotationQueue(e){const t=await this.caller.call(k(),`${this.apiUrl}/annotation-queues/${D(e,"queueId")}/size`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await L(t,"get size from annotation queue"),await t.json()}async _currentTenantIsOwner(e){const t=await this._getSettings();return e=="-"||t.tenant_handle===e}async _ownerConflictError(e,t){const r=await this._getSettings();return new Error(`Cannot ${e} for another tenant.

      Current tenant: ${r.tenant_handle}

      Requested tenant: ${t}`)}async _getLatestCommitHash(e){const t=await this.caller.call(k(),`${this.apiUrl}/commits/${e}/?limit=1&offset=0`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions}),r=await t.json();if(!t.ok){const a=typeof r.detail=="string"?r.detail:JSON.stringify(r.detail),s=new Error(`Error ${t.status}: ${t.statusText}
${a}`);throw s.statusCode=t.status,s}if(r.commits.length!==0)return r.commits[0].commit_hash}async _likeOrUnlikePrompt(e,t){const[r,a,s]=De(e),i=await this.caller.call(k(),`${this.apiUrl}/likes/${r}/${a}`,{method:"POST",body:JSON.stringify({like:t}),headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await L(i,`${t?"like":"unlike"} prompt`),await i.json()}async _getPromptUrl(e){const[t,r,a]=De(e);if(await this._currentTenantIsOwner(t)){const s=await this._getSettings();return a!=="latest"?`${this.getHostUrl()}/prompts/${r}/${a.substring(0,8)}?organizationId=${s.id}`:`${this.getHostUrl()}/prompts/${r}?organizationId=${s.id}`}else return a!=="latest"?`${this.getHostUrl()}/hub/${t}/${r}/${a.substring(0,8)}`:`${this.getHostUrl()}/hub/${t}/${r}`}async promptExists(e){return!!await this.getPrompt(e)}async likePrompt(e){return this._likeOrUnlikePrompt(e,!0)}async unlikePrompt(e){return this._likeOrUnlikePrompt(e,!1)}async*listCommits(e){for await(const t of this._getPaginated(`/commits/${e}/`,new URLSearchParams,r=>r.commits))yield*t}async*listPrompts(e){const t=new URLSearchParams;t.append("sort_field",e?.sortField??"updated_at"),t.append("sort_direction","desc"),t.append("is_archived",(!!e?.isArchived).toString()),e?.isPublic!==void 0&&t.append("is_public",e.isPublic.toString()),e?.query&&t.append("query",e.query);for await(const r of this._getPaginated("/repos",t,a=>a.repos))yield*r}async getPrompt(e){const[t,r,a]=De(e),s=await this.caller.call(k(),`${this.apiUrl}/repos/${t}/${r}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});if(s.status===404)return null;await L(s,"get prompt");const i=await s.json();return i.repo?i.repo:null}async createPrompt(e,t){const r=await this._getSettings();if(t?.isPublic&&!r.tenant_handle)throw new Error(`Cannot create a public prompt without first

        creating a LangChain Hub handle. 
        You can add a handle by creating a public prompt at:

        https://smith.langchain.com/prompts`);const[a,s,i]=De(e);if(!await this._currentTenantIsOwner(a))throw await this._ownerConflictError("create a prompt",a);const o={repo_handle:s,...t?.description&&{description:t.description},...t?.readme&&{readme:t.readme},...t?.tags&&{tags:t.tags},is_public:!!t?.isPublic},u=await this.caller.call(k(),`${this.apiUrl}/repos/`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(o),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await L(u,"create prompt");const{repo:c}=await u.json();return c}async createCommit(e,t,r){if(!await this.promptExists(e))throw new Error("Prompt does not exist, you must create it first.");const[a,s,i]=De(e),o=r?.parentCommitHash==="latest"||!r?.parentCommitHash?await this._getLatestCommitHash(`${a}/${s}`):r?.parentCommitHash,u={manifest:JSON.parse(JSON.stringify(t)),parent_commit:o},c=await this.caller.call(k(),`${this.apiUrl}/commits/${a}/${s}`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(u),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await L(c,"create commit");const l=await c.json();return this._getPromptUrl(`${a}/${s}${l.commit_hash?`:${l.commit_hash}`:""}`)}async updateExamplesMultipart(e,t=[]){if(!await this._getMultiPartSupport())throw new Error("Your LangSmith version does not allow using the multipart examples endpoint, please update to the latest version.");const r=new FormData;for(const i of t){const o=i.id,u={...i.metadata&&{metadata:i.metadata},...i.split&&{split:i.split}},c=le(u),l=new Blob([c],{type:"application/json"});if(r.append(o,l),i.inputs){const d=le(i.inputs),h=new Blob([d],{type:"application/json"});r.append(`${o}.inputs`,h)}if(i.outputs){const d=le(i.outputs),h=new Blob([d],{type:"application/json"});r.append(`${o}.outputs`,h)}if(i.attachments)for(const[d,h]of Object.entries(i.attachments)){let f,p;Array.isArray(h)?[f,p]=h:(f=h.mimeType,p=h.data);const S=new Blob([p],{type:`${f}; length=${p.byteLength}`});r.append(`${o}.attachment.${d}`,S)}if(i.attachments_operations){const d=le(i.attachments_operations),h=new Blob([d],{type:"application/json"});r.append(`${o}.attachments_operations`,h)}}return await(await this.caller.call(k(),`${this.apiUrl}/v1/platform/datasets/${e}/examples`,{method:"PATCH",headers:this.headers,body:r})).json()}async uploadExamplesMultipart(e,t=[]){if(!await this._getMultiPartSupport())throw new Error("Your LangSmith version does not allow using the multipart examples endpoint, please update to the latest version.");const r=new FormData;for(const i of t){const o=(i.id??ue()).toString(),u={created_at:i.created_at,...i.metadata&&{metadata:i.metadata},...i.split&&{split:i.split}},c=le(u),l=new Blob([c],{type:"application/json"});r.append(o,l);const d=le(i.inputs),h=new Blob([d],{type:"application/json"});if(r.append(`${o}.inputs`,h),i.outputs){const f=le(i.outputs),p=new Blob([f],{type:"application/json"});r.append(`${o}.outputs`,p)}if(i.attachments)for(const[f,p]of Object.entries(i.attachments)){let S,m;Array.isArray(p)?[S,m]=p:(S=p.mimeType,m=p.data);const _=new Blob([m],{type:`${S}; length=${m.byteLength}`});r.append(`${o}.attachment.${f}`,_)}}return await(await this.caller.call(k(),`${this.apiUrl}/v1/platform/datasets/${e}/examples`,{method:"POST",headers:this.headers,body:r})).json()}async updatePrompt(e,t){if(!await this.promptExists(e))throw new Error("Prompt does not exist, you must create it first.");const[r,a]=De(e);if(!await this._currentTenantIsOwner(r))throw await this._ownerConflictError("update a prompt",r);const s={};if(t?.description!==void 0&&(s.description=t.description),t?.readme!==void 0&&(s.readme=t.readme),t?.tags!==void 0&&(s.tags=t.tags),t?.isPublic!==void 0&&(s.is_public=t.isPublic),t?.isArchived!==void 0&&(s.is_archived=t.isArchived),Object.keys(s).length===0)throw new Error("No valid update options provided");const i=await this.caller.call(k(),`${this.apiUrl}/repos/${r}/${a}`,{method:"PATCH",body:JSON.stringify(s),headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await L(i,"update prompt"),i.json()}async deletePrompt(e){if(!await this.promptExists(e))throw new Error("Prompt does not exist, you must create it first.");const[t,r,a]=De(e);if(!await this._currentTenantIsOwner(t))throw await this._ownerConflictError("delete a prompt",t);return await(await this.caller.call(k(),`${this.apiUrl}/repos/${t}/${r}`,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions})).json()}async pullPromptCommit(e,t){const[r,a,s]=De(e),i=await this.caller.call(k(),`${this.apiUrl}/commits/${r}/${a}/${s}${t?.includeModel?"?include_model=true":""}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await L(i,"pull prompt commit");const o=await i.json();return{owner:r,repo:a,commit_hash:o.commit_hash,manifest:o.manifest,examples:o.examples}}async _pullPrompt(e,t){const r=await this.pullPromptCommit(e,{includeModel:t?.includeModel});return JSON.stringify(r.manifest)}async pushPrompt(e,t){return await this.promptExists(e)?t&&Object.keys(t).some(a=>a!=="object")&&await this.updatePrompt(e,{description:t?.description,readme:t?.readme,tags:t?.tags,isPublic:t?.isPublic}):await this.createPrompt(e,{description:t?.description,readme:t?.readme,tags:t?.tags,isPublic:t?.isPublic}),t?.object?await this.createCommit(e,t?.object,{parentCommitHash:t?.parentCommitHash}):await this._getPromptUrl(e)}async clonePublicDataset(e,t={}){const{sourceApiUrl:r=this.apiUrl,datasetName:a}=t,[s,i]=this.parseTokenOrUrl(e,r),o=new Zt({apiUrl:s,apiKey:"placeholder"}),u=await o.readSharedDataset(i),c=a||u.name;try{if(await this.hasDataset({datasetId:c})){console.log(`Dataset ${c} already exists in your tenant. Skipping.`);return}}catch{}const l=await o.listSharedExamples(i),d=await this.createDataset(c,{description:u.description,dataType:u.data_type||"kv",inputsSchema:u.inputs_schema_definition??void 0,outputsSchema:u.outputs_schema_definition??void 0});try{await this.createExamples({inputs:l.map(h=>h.inputs),outputs:l.flatMap(h=>h.outputs?[h.outputs]:[]),datasetId:d.id})}catch(h){throw console.error(`An error occurred while creating dataset ${c}. You should delete it manually.`),h}}parseTokenOrUrl(e,t,r=2,a="dataset"){try{return D(e),[t,e]}catch{}try{const i=new URL(e).pathname.split("/").filter(o=>o!=="");if(i.length>=r){const o=i[i.length-r];return[t,o]}else throw new Error(`Invalid public ${a} URL: ${e}`)}catch{throw new Error(`Invalid public ${a} URL or token: ${e}`)}}awaitPendingTraceBatches(){return this.manualFlushMode?(console.warn("[WARNING]: When tracing in manual flush mode, you must call `await client.flush()` manually to submit trace batches."),Promise.resolve()):Promise.all([...this.autoBatchQueue.items.map(({itemPromise:e})=>e),this.batchIngestCaller.queue.onIdle()])}}const ns="0.2.15";var un={};let Ce;const ul=()=>typeof window<"u"&&typeof window.document<"u",cl=()=>typeof globalThis=="object"&&globalThis.constructor&&globalThis.constructor.name==="DedicatedWorkerGlobalScope",ll=()=>typeof window<"u"&&window.name==="nodejs"||typeof navigator<"u"&&(navigator.userAgent.includes("Node.js")||navigator.userAgent.includes("jsdom")),as=()=>typeof Deno<"u",dl=()=>typeof process<"u"&&typeof process.versions<"u"&&typeof process.versions.node<"u"&&!as(),hl=()=>Ce||(ul()?Ce="browser":dl()?Ce="node":cl()?Ce="webworker":ll()?Ce="jsdom":as()?Ce="deno":Ce="other",Ce);let Hr;function ss(){if(Hr===void 0){const n=hl(),e=ml();Hr={library:"langsmith",runtime:n,sdk:"langsmith-js",sdk_version:ns,...e}}return Hr}function fl(){const n=pl()||{},e={},t=["LANGCHAIN_API_KEY","LANGCHAIN_ENDPOINT","LANGCHAIN_TRACING_V2","LANGCHAIN_PROJECT","LANGCHAIN_SESSION","LANGSMITH_API_KEY","LANGSMITH_ENDPOINT","LANGSMITH_TRACING_V2","LANGSMITH_PROJECT","LANGSMITH_SESSION"];for(const[r,a]of Object.entries(n))(r.startsWith("LANGCHAIN_")||r.startsWith("LANGSMITH_"))&&typeof a=="string"&&!t.includes(r)&&!r.toLowerCase().includes("key")&&!r.toLowerCase().includes("secret")&&!r.toLowerCase().includes("token")&&(r==="LANGCHAIN_REVISION_ID"?e.revision_id=a:e[r]=a);return e}function pl(){try{return typeof process<"u"&&un?Object.entries(un).reduce((n,[e,t])=>(n[e]=String(t),n),{}):void 0}catch{return}}function Be(n){try{return typeof process<"u"?un?.[n]:void 0}catch{return}}function Je(n){return Be(`LANGSMITH_${n}`)||Be(`LANGCHAIN_${n}`)}let Gr;function ml(){if(Gr!==void 0)return Gr;const n=["VERCEL_GIT_COMMIT_SHA","NEXT_PUBLIC_VERCEL_GIT_COMMIT_SHA","COMMIT_REF","RENDER_GIT_COMMIT","CI_COMMIT_SHA","CIRCLE_SHA1","CF_PAGES_COMMIT_SHA","REACT_APP_GIT_SHA","SOURCE_VERSION","GITHUB_SHA","TRAVIS_COMMIT","GIT_COMMIT","BUILD_VCS_NUMBER","bamboo_planRepository_revision","Build.SourceVersion","BITBUCKET_COMMIT","DRONE_COMMIT_SHA","SEMAPHORE_GIT_SHA","BUILDKITE_COMMIT"],e={};for(const t of n){const r=Be(t);r!==void 0&&(e[t]=r)}return Gr=e,e}const gl=n=>!!["TRACING_V2","TRACING"].find(t=>Je(t)==="true"),zr=Symbol.for("lc:context_variables");function yl(n){return n.replace(/[-:.]/g,"")}function _l(n,e,t=1){const r=t.toFixed(0).slice(0,3).padStart(3,"0");return yl(`${new Date(n).toISOString().slice(0,-1)}${r}Z`)+e}class hr{constructor(e,t){Object.defineProperty(this,"metadata",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.metadata=e,this.tags=t}static fromHeader(e){const t=e.split(",");let r={},a=[];for(const s of t){const[i,o]=s.split("="),u=decodeURIComponent(o);i==="langsmith-metadata"?r=JSON.parse(u):i==="langsmith-tags"&&(a=u.split(","))}return new hr(r,a)}toHeader(){const e=[];return this.metadata&&Object.keys(this.metadata).length>0&&e.push(`langsmith-metadata=${encodeURIComponent(JSON.stringify(this.metadata))}`),this.tags&&this.tags.length>0&&e.push(`langsmith-tags=${encodeURIComponent(this.tags.join(","))}`),e.join(",")}}class de{constructor(e){if(Object.defineProperty(this,"id",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"run_type",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"project_name",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"parent_run",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"child_runs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"start_time",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"end_time",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"extra",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"error",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"serialized",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"inputs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"outputs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"reference_example_id",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"client",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"events",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"trace_id",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"dotted_order",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tracingEnabled",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"execution_order",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"child_execution_order",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"attachments",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),is(e)){Object.assign(this,{...e});return}const t=de.getDefaultConfig(),{metadata:r,...a}=e,s=a.client??de.getSharedClient(),i={...r,...a?.extra?.metadata};if(a.extra={...a.extra,metadata:i},Object.assign(this,{...t,...a,client:s}),this.trace_id||(this.parent_run?this.trace_id=this.parent_run.trace_id??this.id:this.trace_id=this.id),this.execution_order??=1,this.child_execution_order??=1,!this.dotted_order){const o=_l(this.start_time,this.id,this.execution_order);this.parent_run?this.dotted_order=this.parent_run.dotted_order+"."+o:this.dotted_order=o}}static getDefaultConfig(){return{id:ue(),run_type:"chain",project_name:Be("LANGCHAIN_PROJECT")??Be("LANGCHAIN_SESSION")??"default",child_runs:[],api_url:Be("LANGCHAIN_ENDPOINT")??"http://localhost:1984",api_key:Be("LANGCHAIN_API_KEY"),caller_options:{},start_time:Date.now(),serialized:{},inputs:{},extra:{}}}static getSharedClient(){return de.sharedClient||(de.sharedClient=new Zt),de.sharedClient}createChild(e){const t=this.child_execution_order+1,r=new de({...e,parent_run:this,project_name:this.project_name,client:this.client,tracingEnabled:this.tracingEnabled,execution_order:t,child_execution_order:t});zr in this&&(r[zr]=this[zr]);const a=Symbol.for("lc:child_config"),s=e.extra?.[a]??this.extra[a];if(wl(s)){const u={...s},c=bl(u.callbacks)?u.callbacks.copy?.():void 0;c&&(Object.assign(c,{_parentRunId:r.id}),c.handlers?.find(os)?.updateFromRunTree?.(r),u.callbacks=c),r.extra[a]=u}const i=new Set;let o=this;for(;o!=null&&!i.has(o.id);)i.add(o.id),o.child_execution_order=Math.max(o.child_execution_order,t),o=o.parent_run;return this.child_runs.push(r),r}async end(e,t,r=Date.now(),a){this.outputs=this.outputs??e,this.error=this.error??t,this.end_time=this.end_time??r,a&&Object.keys(a).length>0&&(this.extra=this.extra?{...this.extra,metadata:{...this.extra.metadata,...a}}:{metadata:a})}_convertToCreate(e,t,r=!0){const a=e.extra??{};if(a.runtime||(a.runtime={}),t)for(const[u,c]of Object.entries(t))a.runtime[u]||(a.runtime[u]=c);let s,i;return r?(i=e.parent_run?.id,s=[]):(s=e.child_runs.map(u=>this._convertToCreate(u,t,r)),i=void 0),{id:e.id,name:e.name,start_time:e.start_time,end_time:e.end_time,run_type:e.run_type,reference_example_id:e.reference_example_id,extra:a,serialized:e.serialized,error:e.error,inputs:e.inputs,outputs:e.outputs,session_name:e.project_name,child_runs:s,parent_run_id:i,trace_id:e.trace_id,dotted_order:e.dotted_order,tags:e.tags,attachments:e.attachments}}async postRun(e=!0){try{const t=ss(),r=await this._convertToCreate(this,t,!0);if(await this.client.createRun(r),!e){Ja("Posting with excludeChildRuns=false is deprecated and will be removed in a future version.");for(const a of this.child_runs)await a.postRun(!1)}}catch(t){console.error(`Error in postRun for run ${this.id}:`,t)}}async patchRun(){try{const e={end_time:this.end_time,error:this.error,inputs:this.inputs,outputs:this.outputs,parent_run_id:this.parent_run?.id,reference_example_id:this.reference_example_id,extra:this.extra,events:this.events,dotted_order:this.dotted_order,trace_id:this.trace_id,tags:this.tags,attachments:this.attachments};await this.client.updateRun(this.id,e)}catch(e){console.error(`Error in patchRun for run ${this.id}`,e)}}toJSON(){return this._convertToCreate(this,void 0,!1)}static fromRunnableConfig(e,t){const r=e?.callbacks;let a,s,i,o=gl();if(r){const c=r?.getParentRunId?.()??"",l=r?.handlers?.find(d=>d?.name=="langchain_tracer");a=l?.getRun?.(c),s=l?.projectName,i=l?.client,o=o||!!l}return a?new de({name:a.name,id:a.id,trace_id:a.trace_id,dotted_order:a.dotted_order,client:i,tracingEnabled:o,project_name:s,tags:[...new Set((a?.tags??[]).concat(e?.tags??[]))],extra:{metadata:{...a?.extra?.metadata,...e?.metadata}}}).createChild(t):new de({...t,client:i,tracingEnabled:o,project_name:s})}static fromDottedOrder(e){return this.fromHeaders({"langsmith-trace":e})}static fromHeaders(e,t){const r="get"in e&&typeof e.get=="function"?{"langsmith-trace":e.get("langsmith-trace"),baggage:e.get("baggage")}:e,a=r["langsmith-trace"];if(!a||typeof a!="string")return;const s=a.trim(),i=s.split(".").map(c=>{const[l,d]=c.split("Z");return{strTime:l,time:Date.parse(l+"Z"),uuid:d}}),o=i[0].uuid,u={...t,name:t?.name??"parent",run_type:t?.run_type??"chain",start_time:t?.start_time??Date.now(),id:i.at(-1)?.uuid,trace_id:o,dotted_order:s};if(r.baggage&&typeof r.baggage=="string"){const c=hr.fromHeader(r.baggage);u.metadata=c.metadata,u.tags=c.tags}return new de(u)}toHeaders(e){const t={"langsmith-trace":this.dotted_order,baggage:new hr(this.extra?.metadata,this.tags).toHeader()};if(e)for(const[r,a]of Object.entries(t))e.set(r,a);return t}}Object.defineProperty(de,"sharedClient",{enumerable:!0,configurable:!0,writable:!0,value:null});function is(n){return n!==void 0&&typeof n.createChild=="function"&&typeof n.postRun=="function"}function os(n){return typeof n=="object"&&n!=null&&typeof n.name=="string"&&n.name==="langchain_tracer"}function ca(n){return Array.isArray(n)&&n.some(e=>os(e))}function bl(n){return typeof n=="object"&&n!=null&&Array.isArray(n.handlers)}function wl(n){return n!==void 0&&typeof n.callbacks=="object"&&(ca(n.callbacks?.handlers)||ca(n.callbacks))}let vl=class{getStore(){}run(e,t){return t()}};const Vr=Symbol.for("ls:tracing_async_local_storage"),El=new vl;let Ol=class{getInstance(){return globalThis[Vr]??El}initializeGlobalInstance(e){globalThis[Vr]===void 0&&(globalThis[Vr]=e)}};const Sl=new Ol,Tl=()=>{const n=Sl.getInstance().getStore();if(!is(n))throw new Error(["Could not get the current run tree.","","Please make sure you are calling this method within a traceable function or the tracing is enabled."].join(`
`));return n};function $n(n){return typeof n=="function"&&"langsmith:traceable"in n}/*!
 * https://github.com/Starcounter-Jack/JSON-Patch
 * (c) 2017-2022 Joachim Wester
 * MIT licensed
 */const kl=Object.prototype.hasOwnProperty;function Il(n,e){return kl.call(n,e)}function $l(n){if(Array.isArray(n)){const t=new Array(n.length);for(let r=0;r<t.length;r++)t[r]=""+r;return t}if(Object.keys)return Object.keys(n);let e=[];for(let t in n)Il(n,t)&&e.push(t);return e}function pt(n){switch(typeof n){case"object":return JSON.parse(JSON.stringify(n));case"undefined":return null;default:return n}}function cn(n){let e=0;const t=n.length;let r;for(;e<t;){if(r=n.charCodeAt(e),r>=48&&r<=57){e++;continue}return!1}return!0}function Al(n){return n.replace(/~1/g,"/").replace(/~0/g,"~")}function ln(n){if(n===void 0)return!0;if(n){if(Array.isArray(n)){for(let t=0,r=n.length;t<r;t++)if(ln(n[t]))return!0}else if(typeof n=="object"){const t=$l(n),r=t.length;for(var e=0;e<r;e++)if(ln(n[t[e]]))return!0}}return!1}function la(n,e){const t=[n];for(const r in e){const a=typeof e[r]=="object"?JSON.stringify(e[r],null,2):e[r];typeof a<"u"&&t.push(`${r}: ${a}`)}return t.join(`
`)}class Rl extends Error{constructor(e,t,r,a,s){super(la(e,{name:t,index:r,operation:a,tree:s})),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:t}),Object.defineProperty(this,"index",{enumerable:!0,configurable:!0,writable:!0,value:r}),Object.defineProperty(this,"operation",{enumerable:!0,configurable:!0,writable:!0,value:a}),Object.defineProperty(this,"tree",{enumerable:!0,configurable:!0,writable:!0,value:s}),Object.setPrototypeOf(this,new.target.prototype),this.message=la(e,{name:t,index:r,operation:a,tree:s})}}const K=Rl,ct={add:function(n,e,t){return n[e]=this.value,{newDocument:t}},remove:function(n,e,t){var r=n[e];return delete n[e],{newDocument:t,removed:r}},replace:function(n,e,t){var r=n[e];return n[e]=this.value,{newDocument:t,removed:r}},move:function(n,e,t){let r=dn(t,this.path);r&&(r=pt(r));const a=kt(t,{op:"remove",path:this.from}).removed;return kt(t,{op:"add",path:this.path,value:a}),{newDocument:t,removed:r}},copy:function(n,e,t){const r=dn(t,this.from);return kt(t,{op:"add",path:this.path,value:pt(r)}),{newDocument:t}},test:function(n,e,t){return{newDocument:t,test:pr(n[e],this.value)}},_get:function(n,e,t){return this.value=n[e],{newDocument:t}}};var xl={add:function(n,e,t){return cn(e)?n.splice(e,0,this.value):n[e]=this.value,{newDocument:t,index:e}},remove:function(n,e,t){var r=n.splice(e,1);return{newDocument:t,removed:r[0]}},replace:function(n,e,t){var r=n[e];return n[e]=this.value,{newDocument:t,removed:r}},move:ct.move,copy:ct.copy,test:ct.test,_get:ct._get};function dn(n,e){if(e=="")return n;var t={op:"_get",path:e};return kt(n,t),t.value}function kt(n,e,t=!1,r=!0,a=!0,s=0){if(t&&(typeof t=="function"?t(e,0,n,e.path):hn(e,0)),e.path===""){let i={newDocument:n};if(e.op==="add")return i.newDocument=e.value,i;if(e.op==="replace")return i.newDocument=e.value,i.removed=n,i;if(e.op==="move"||e.op==="copy")return i.newDocument=dn(n,e.from),e.op==="move"&&(i.removed=n),i;if(e.op==="test"){if(i.test=pr(n,e.value),i.test===!1)throw new K("Test operation failed","TEST_OPERATION_FAILED",s,e,n);return i.newDocument=n,i}else{if(e.op==="remove")return i.removed=n,i.newDocument=null,i;if(e.op==="_get")return e.value=n,i;if(t)throw new K("Operation `op` property is not one of operations defined in RFC-6902","OPERATION_OP_INVALID",s,e,n);return i}}else{r||(n=pt(n));const o=(e.path||"").split("/");let u=n,c=1,l=o.length,d,h,f;for(typeof t=="function"?f=t:f=hn;;){if(h=o[c],h&&h.indexOf("~")!=-1&&(h=Al(h)),a&&(h=="__proto__"||h=="prototype"&&c>0&&o[c-1]=="constructor"))throw new TypeError("JSON-Patch: modifying `__proto__` or `constructor/prototype` prop is banned for security reasons, if this was on purpose, please set `banPrototypeModifications` flag false and pass it to this function. More info in fast-json-patch README");if(t&&d===void 0&&(u[h]===void 0?d=o.slice(0,c).join("/"):c==l-1&&(d=e.path),d!==void 0&&f(e,0,n,d)),c++,Array.isArray(u)){if(h==="-")h=u.length;else{if(t&&!cn(h))throw new K("Expected an unsigned base-10 integer value, making the new referenced value the array element with the zero-based index","OPERATION_PATH_ILLEGAL_ARRAY_INDEX",s,e,n);cn(h)&&(h=~~h)}if(c>=l){if(t&&e.op==="add"&&h>u.length)throw new K("The specified index MUST NOT be greater than the number of elements in the array","OPERATION_VALUE_OUT_OF_BOUNDS",s,e,n);const p=xl[e.op].call(e,u,h,n);if(p.test===!1)throw new K("Test operation failed","TEST_OPERATION_FAILED",s,e,n);return p}}else if(c>=l){const p=ct[e.op].call(e,u,h,n);if(p.test===!1)throw new K("Test operation failed","TEST_OPERATION_FAILED",s,e,n);return p}if(u=u[h],t&&c<l&&(!u||typeof u!="object"))throw new K("Cannot perform operation at the desired path","OPERATION_PATH_UNRESOLVABLE",s,e,n)}}}function fr(n,e,t,r=!0,a=!0){if(t&&!Array.isArray(e))throw new K("Patch sequence must be an array","SEQUENCE_NOT_AN_ARRAY");r||(n=pt(n));const s=new Array(e.length);for(let i=0,o=e.length;i<o;i++)s[i]=kt(n,e[i],t,!0,a,i),n=s[i].newDocument;return s.newDocument=n,s}function hn(n,e,t,r){if(typeof n!="object"||n===null||Array.isArray(n))throw new K("Operation is not an object","OPERATION_NOT_AN_OBJECT",e,n,t);if(ct[n.op]){if(typeof n.path!="string")throw new K("Operation `path` property is not a string","OPERATION_PATH_INVALID",e,n,t);if(n.path.indexOf("/")!==0&&n.path.length>0)throw new K('Operation `path` property must start with "/"',"OPERATION_PATH_INVALID",e,n,t);if((n.op==="move"||n.op==="copy")&&typeof n.from!="string")throw new K("Operation `from` property is not present (applicable in `move` and `copy` operations)","OPERATION_FROM_REQUIRED",e,n,t);if((n.op==="add"||n.op==="replace"||n.op==="test")&&n.value===void 0)throw new K("Operation `value` property is not present (applicable in `add`, `replace` and `test` operations)","OPERATION_VALUE_REQUIRED",e,n,t);if((n.op==="add"||n.op==="replace"||n.op==="test")&&ln(n.value))throw new K("Operation `value` property is not present (applicable in `add`, `replace` and `test` operations)","OPERATION_VALUE_CANNOT_CONTAIN_UNDEFINED",e,n,t);if(t){if(n.op=="add"){var a=n.path.split("/").length,s=r.split("/").length;if(a!==s+1&&a!==s)throw new K("Cannot perform an `add` operation at the desired path","OPERATION_PATH_CANNOT_ADD",e,n,t)}else if(n.op==="replace"||n.op==="remove"||n.op==="_get"){if(n.path!==r)throw new K("Cannot perform the operation at a path that does not exist","OPERATION_PATH_UNRESOLVABLE",e,n,t)}else if(n.op==="move"||n.op==="copy"){var i={op:"_get",path:n.from,value:void 0},o=Cl([i],t);if(o&&o.name==="OPERATION_PATH_UNRESOLVABLE")throw new K("Cannot perform the operation from a path that does not exist","OPERATION_FROM_UNRESOLVABLE",e,n,t)}}}else throw new K("Operation `op` property is not one of operations defined in RFC-6902","OPERATION_OP_INVALID",e,n,t)}function Cl(n,e,t){try{if(!Array.isArray(n))throw new K("Patch sequence must be an array","SEQUENCE_NOT_AN_ARRAY");if(e)fr(pt(e),pt(n),t||!0);else{t=t||hn;for(var r=0;r<n.length;r++)t(n[r],r,e,void 0)}}catch(a){if(a instanceof K)return a;throw a}}function pr(n,e){if(n===e)return!0;if(n&&e&&typeof n=="object"&&typeof e=="object"){var t=Array.isArray(n),r=Array.isArray(e),a,s,i;if(t&&r){if(s=n.length,s!=e.length)return!1;for(a=s;a--!==0;)if(!pr(n[a],e[a]))return!1;return!0}if(t!=r)return!1;var o=Object.keys(n);if(s=o.length,s!==Object.keys(e).length)return!1;for(a=s;a--!==0;)if(!e.hasOwnProperty(o[a]))return!1;for(a=s;a--!==0;)if(i=o[a],!pr(n[i],e[i]))return!1;return!0}return n!==n&&e!==e}var Pl=function(n,e){if(typeof n!="string")throw new TypeError("Expected a string");return e=typeof e>"u"?"_":e,n.replace(/([a-z\d])([A-Z])/g,"$1"+e+"$2").replace(/([A-Z]+)([A-Z][a-z\d]+)/g,"$1"+e+"$2").toLowerCase()};const Nl=yn(Pl);var us={exports:{}};const jl=/[\p{Lu}]/u,Ll=/[\p{Ll}]/u,da=/^[\p{Lu}](?![\p{Lu}])/gu,cs=/([\p{Alpha}\p{N}_]|$)/u,ls=/[_.\- ]+/,Ml=new RegExp("^"+ls.source),ha=new RegExp(ls.source+cs.source,"gu"),fa=new RegExp("\\d+"+cs.source,"gu"),Dl=(n,e,t)=>{let r=!1,a=!1,s=!1;for(let i=0;i<n.length;i++){const o=n[i];r&&jl.test(o)?(n=n.slice(0,i)+"-"+n.slice(i),r=!1,s=a,a=!0,i++):a&&s&&Ll.test(o)?(n=n.slice(0,i-1)+"-"+n.slice(i-1),s=a,a=!1,r=!0):(r=e(o)===o&&t(o)!==o,s=a,a=t(o)===o&&e(o)!==o)}return n},Fl=(n,e)=>(da.lastIndex=0,n.replace(da,t=>e(t))),Ul=(n,e)=>(ha.lastIndex=0,fa.lastIndex=0,n.replace(ha,(t,r)=>e(r)).replace(fa,t=>e(t))),ds=(n,e)=>{if(!(typeof n=="string"||Array.isArray(n)))throw new TypeError("Expected the input to be `string | string[]`");if(e={pascalCase:!1,preserveConsecutiveUppercase:!1,...e},Array.isArray(n)?n=n.map(s=>s.trim()).filter(s=>s.length).join("-"):n=n.trim(),n.length===0)return"";const t=e.locale===!1?s=>s.toLowerCase():s=>s.toLocaleLowerCase(e.locale),r=e.locale===!1?s=>s.toUpperCase():s=>s.toLocaleUpperCase(e.locale);return n.length===1?e.pascalCase?r(n):t(n):(n!==t(n)&&(n=Dl(n,t,r)),n=n.replace(Ml,""),e.preserveConsecutiveUppercase?n=Fl(n,t):n=t(n),e.pascalCase&&(n=r(n.charAt(0))+n.slice(1)),Ul(n,r))};us.exports=ds;us.exports.default=ds;function Bl(n,e){return e?.[n]||Nl(n)}function Zl(n,e,t){const r={};for(const a in n)Object.hasOwn(n,a)&&(r[e(a,t)]=n[a]);return r}function pa(n){return Array.isArray(n)?[...n]:{...n}}function Hl(n,e){const t=pa(n);for(const[r,a]of Object.entries(e)){const[s,...i]=r.split(".").reverse();let o=t;for(const u of i.reverse()){if(o[u]===void 0)break;o[u]=pa(o[u]),o=o[u]}o[s]!==void 0&&(o[s]={lc:1,type:"secret",id:[a]})}return t}function hs(n){const e=Object.getPrototypeOf(n);return typeof n.lc_name=="function"&&(typeof e.lc_name!="function"||n.lc_name()!==e.lc_name())?n.lc_name():n.name}class mt{static lc_name(){return this.name}get lc_id(){return[...this.lc_namespace,hs(this.constructor)]}get lc_secrets(){}get lc_attributes(){}get lc_aliases(){}constructor(e,...t){Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"lc_kwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.lc_kwargs=e||{}}toJSON(){if(!this.lc_serializable)return this.toJSONNotImplemented();if(this.lc_kwargs instanceof mt||typeof this.lc_kwargs!="object"||Array.isArray(this.lc_kwargs))return this.toJSONNotImplemented();const e={},t={},r=Object.keys(this.lc_kwargs).reduce((a,s)=>(a[s]=s in this?this[s]:this.lc_kwargs[s],a),{});for(let a=Object.getPrototypeOf(this);a;a=Object.getPrototypeOf(a))Object.assign(e,Reflect.get(a,"lc_aliases",this)),Object.assign(t,Reflect.get(a,"lc_secrets",this)),Object.assign(r,Reflect.get(a,"lc_attributes",this));return Object.keys(t).forEach(a=>{let s=this,i=r;const[o,...u]=a.split(".").reverse();for(const c of u.reverse()){if(!(c in s)||s[c]===void 0)return;(!(c in i)||i[c]===void 0)&&(typeof s[c]=="object"&&s[c]!=null?i[c]={}:Array.isArray(s[c])&&(i[c]=[])),s=s[c],i=i[c]}o in s&&s[o]!==void 0&&(i[o]=i[o]||s[o])}),{lc:1,type:"constructor",id:this.lc_id,kwargs:Zl(Object.keys(t).length?Hl(r,t):r,Bl,e)}}toJSONNotImplemented(){return{lc:1,type:"not_implemented",id:this.lc_id}}}var Gl={};const zl=()=>typeof window<"u"&&typeof window.document<"u",Vl=()=>typeof globalThis=="object"&&globalThis.constructor&&globalThis.constructor.name==="DedicatedWorkerGlobalScope",ql=()=>typeof window<"u"&&window.name==="nodejs"||typeof navigator<"u"&&(navigator.userAgent.includes("Node.js")||navigator.userAgent.includes("jsdom")),An=()=>typeof Deno<"u",Wl=()=>typeof process<"u"&&typeof process.versions<"u"&&typeof process.versions.node<"u"&&!An(),Jl=()=>{let n;return zl()?n="browser":Wl()?n="node":Vl()?n="webworker":ql()?n="jsdom":An()?n="deno":n="other",n};let qr;async function Xl(){return qr===void 0&&(qr={library:"langchain-js",runtime:Jl()}),qr}function Ze(n){try{return typeof process<"u"?Gl?.[n]:An()?Deno?.env.get(n):void 0}catch{return}}class Kl{}class qt extends Kl{get lc_namespace(){return["langchain_core","callbacks",this.name]}get lc_secrets(){}get lc_attributes(){}get lc_aliases(){}static lc_name(){return this.name}get lc_id(){return[...this.lc_namespace,hs(this.constructor)]}constructor(e){super(),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"lc_kwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"ignoreLLM",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"ignoreChain",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"ignoreAgent",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"ignoreRetriever",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"ignoreCustomEvent",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"raiseError",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"awaitHandlers",{enumerable:!0,configurable:!0,writable:!0,value:Ze("LANGCHAIN_CALLBACKS_BACKGROUND")==="false"}),this.lc_kwargs=e||{},e&&(this.ignoreLLM=e.ignoreLLM??this.ignoreLLM,this.ignoreChain=e.ignoreChain??this.ignoreChain,this.ignoreAgent=e.ignoreAgent??this.ignoreAgent,this.ignoreRetriever=e.ignoreRetriever??this.ignoreRetriever,this.ignoreCustomEvent=e.ignoreCustomEvent??this.ignoreCustomEvent,this.raiseError=e.raiseError??this.raiseError,this.awaitHandlers=this.raiseError||(e._awaitHandler??this.awaitHandlers))}copy(){return new this.constructor(this)}toJSON(){return mt.prototype.toJSON.call(this)}toJSONNotImplemented(){return mt.prototype.toJSONNotImplemented.call(this)}static fromMethods(e){class t extends qt{constructor(){super(),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:ue()}),Object.assign(this,e)}}return new t}}const Yl=n=>{const e=n;return e!==void 0&&typeof e.copy=="function"&&typeof e.name=="string"&&typeof e.awaitHandlers=="boolean"};function Wr(n,e){return n&&!Array.isArray(n)&&typeof n=="object"?n:{[e]:n}}function Ql(n){return n.replace(/[-:.]/g,"")}function ed(n,e,t){const r=t.toFixed(0).slice(0,3).padStart(3,"0");return Ql(`${new Date(n).toISOString().slice(0,-1)}${r}Z`)+e}function vt(n){return typeof n._addRunToRunMap=="function"}class Wt extends qt{constructor(e){super(...arguments),Object.defineProperty(this,"runMap",{enumerable:!0,configurable:!0,writable:!0,value:new Map})}copy(){return this}stringifyError(e){return e instanceof Error?e.message+(e?.stack?`

${e.stack}`:""):typeof e=="string"?e:`${e}`}_addChildRun(e,t){e.child_runs.push(t)}_addRunToRunMap(e){const t=ed(e.start_time,e.id,e.execution_order),r={...e};if(r.parent_run_id!==void 0){const a=this.runMap.get(r.parent_run_id);a&&(this._addChildRun(a,r),a.child_execution_order=Math.max(a.child_execution_order,r.child_execution_order),r.trace_id=a.trace_id,a.dotted_order!==void 0&&(r.dotted_order=[a.dotted_order,t].join(".")))}else r.trace_id=r.id,r.dotted_order=t;return this.runMap.set(r.id,r),r}async _endTrace(e){const t=e.parent_run_id!==void 0&&this.runMap.get(e.parent_run_id);t?t.child_execution_order=Math.max(t.child_execution_order,e.child_execution_order):await this.persistRun(e),this.runMap.delete(e.id),await this.onRunUpdate?.(e)}_getExecutionOrder(e){const t=e!==void 0&&this.runMap.get(e);return t?t.child_execution_order+1:1}_createRunForLLMStart(e,t,r,a,s,i,o,u){const c=this._getExecutionOrder(a),l=Date.now(),d=o?{...s,metadata:o}:s,h={id:r,name:u??e.id[e.id.length-1],parent_run_id:a,start_time:l,serialized:e,events:[{name:"start",time:new Date(l).toISOString()}],inputs:{prompts:t},execution_order:c,child_runs:[],child_execution_order:c,run_type:"llm",extra:d??{},tags:i||[]};return this._addRunToRunMap(h)}async handleLLMStart(e,t,r,a,s,i,o,u){const c=this.runMap.get(r)??this._createRunForLLMStart(e,t,r,a,s,i,o,u);return await this.onRunCreate?.(c),await this.onLLMStart?.(c),c}_createRunForChatModelStart(e,t,r,a,s,i,o,u){const c=this._getExecutionOrder(a),l=Date.now(),d=o?{...s,metadata:o}:s,h={id:r,name:u??e.id[e.id.length-1],parent_run_id:a,start_time:l,serialized:e,events:[{name:"start",time:new Date(l).toISOString()}],inputs:{messages:t},execution_order:c,child_runs:[],child_execution_order:c,run_type:"llm",extra:d??{},tags:i||[]};return this._addRunToRunMap(h)}async handleChatModelStart(e,t,r,a,s,i,o,u){const c=this.runMap.get(r)??this._createRunForChatModelStart(e,t,r,a,s,i,o,u);return await this.onRunCreate?.(c),await this.onLLMStart?.(c),c}async handleLLMEnd(e,t){const r=this.runMap.get(t);if(!r||r?.run_type!=="llm")throw new Error("No LLM run to end.");return r.end_time=Date.now(),r.outputs=e,r.events.push({name:"end",time:new Date(r.end_time).toISOString()}),await this.onLLMEnd?.(r),await this._endTrace(r),r}async handleLLMError(e,t){const r=this.runMap.get(t);if(!r||r?.run_type!=="llm")throw new Error("No LLM run to end.");return r.end_time=Date.now(),r.error=this.stringifyError(e),r.events.push({name:"error",time:new Date(r.end_time).toISOString()}),await this.onLLMError?.(r),await this._endTrace(r),r}_createRunForChainStart(e,t,r,a,s,i,o,u){const c=this._getExecutionOrder(a),l=Date.now(),d={id:r,name:u??e.id[e.id.length-1],parent_run_id:a,start_time:l,serialized:e,events:[{name:"start",time:new Date(l).toISOString()}],inputs:t,execution_order:c,child_execution_order:c,run_type:o??"chain",child_runs:[],extra:i?{metadata:i}:{},tags:s||[]};return this._addRunToRunMap(d)}async handleChainStart(e,t,r,a,s,i,o,u){const c=this.runMap.get(r)??this._createRunForChainStart(e,t,r,a,s,i,o,u);return await this.onRunCreate?.(c),await this.onChainStart?.(c),c}async handleChainEnd(e,t,r,a,s){const i=this.runMap.get(t);if(!i)throw new Error("No chain run to end.");return i.end_time=Date.now(),i.outputs=Wr(e,"output"),i.events.push({name:"end",time:new Date(i.end_time).toISOString()}),s?.inputs!==void 0&&(i.inputs=Wr(s.inputs,"input")),await this.onChainEnd?.(i),await this._endTrace(i),i}async handleChainError(e,t,r,a,s){const i=this.runMap.get(t);if(!i)throw new Error("No chain run to end.");return i.end_time=Date.now(),i.error=this.stringifyError(e),i.events.push({name:"error",time:new Date(i.end_time).toISOString()}),s?.inputs!==void 0&&(i.inputs=Wr(s.inputs,"input")),await this.onChainError?.(i),await this._endTrace(i),i}_createRunForToolStart(e,t,r,a,s,i,o){const u=this._getExecutionOrder(a),c=Date.now(),l={id:r,name:o??e.id[e.id.length-1],parent_run_id:a,start_time:c,serialized:e,events:[{name:"start",time:new Date(c).toISOString()}],inputs:{input:t},execution_order:u,child_execution_order:u,run_type:"tool",child_runs:[],extra:i?{metadata:i}:{},tags:s||[]};return this._addRunToRunMap(l)}async handleToolStart(e,t,r,a,s,i,o){const u=this.runMap.get(r)??this._createRunForToolStart(e,t,r,a,s,i,o);return await this.onRunCreate?.(u),await this.onToolStart?.(u),u}async handleToolEnd(e,t){const r=this.runMap.get(t);if(!r||r?.run_type!=="tool")throw new Error("No tool run to end");return r.end_time=Date.now(),r.outputs={output:e},r.events.push({name:"end",time:new Date(r.end_time).toISOString()}),await this.onToolEnd?.(r),await this._endTrace(r),r}async handleToolError(e,t){const r=this.runMap.get(t);if(!r||r?.run_type!=="tool")throw new Error("No tool run to end");return r.end_time=Date.now(),r.error=this.stringifyError(e),r.events.push({name:"error",time:new Date(r.end_time).toISOString()}),await this.onToolError?.(r),await this._endTrace(r),r}async handleAgentAction(e,t){const r=this.runMap.get(t);if(!r||r?.run_type!=="chain")return;const a=r;a.actions=a.actions||[],a.actions.push(e),a.events.push({name:"agent_action",time:new Date().toISOString(),kwargs:{action:e}}),await this.onAgentAction?.(r)}async handleAgentEnd(e,t){const r=this.runMap.get(t);!r||r?.run_type!=="chain"||(r.events.push({name:"agent_end",time:new Date().toISOString(),kwargs:{action:e}}),await this.onAgentEnd?.(r))}_createRunForRetrieverStart(e,t,r,a,s,i,o){const u=this._getExecutionOrder(a),c=Date.now(),l={id:r,name:o??e.id[e.id.length-1],parent_run_id:a,start_time:c,serialized:e,events:[{name:"start",time:new Date(c).toISOString()}],inputs:{query:t},execution_order:u,child_execution_order:u,run_type:"retriever",child_runs:[],extra:i?{metadata:i}:{},tags:s||[]};return this._addRunToRunMap(l)}async handleRetrieverStart(e,t,r,a,s,i,o){const u=this.runMap.get(r)??this._createRunForRetrieverStart(e,t,r,a,s,i,o);return await this.onRunCreate?.(u),await this.onRetrieverStart?.(u),u}async handleRetrieverEnd(e,t){const r=this.runMap.get(t);if(!r||r?.run_type!=="retriever")throw new Error("No retriever run to end");return r.end_time=Date.now(),r.outputs={documents:e},r.events.push({name:"end",time:new Date(r.end_time).toISOString()}),await this.onRetrieverEnd?.(r),await this._endTrace(r),r}async handleRetrieverError(e,t){const r=this.runMap.get(t);if(!r||r?.run_type!=="retriever")throw new Error("No retriever run to end");return r.end_time=Date.now(),r.error=this.stringifyError(e),r.events.push({name:"error",time:new Date(r.end_time).toISOString()}),await this.onRetrieverError?.(r),await this._endTrace(r),r}async handleText(e,t){const r=this.runMap.get(t);!r||r?.run_type!=="chain"||(r.events.push({name:"text",time:new Date().toISOString(),kwargs:{text:e}}),await this.onText?.(r))}async handleLLMNewToken(e,t,r,a,s,i){const o=this.runMap.get(r);if(!o||o?.run_type!=="llm")throw new Error('Invalid "runId" provided to "handleLLMNewToken" callback.');return o.events.push({name:"new_token",time:new Date().toISOString(),kwargs:{token:e,idx:t,chunk:i?.chunk}}),await this.onLLMNewToken?.(o,e,{chunk:i?.chunk}),o}}var Rn={exports:{}};Rn.exports;(function(n){const t=(s=0)=>i=>`\x1B[${38+s};5;${i}m`,r=(s=0)=>(i,o,u)=>`\x1B[${38+s};2;${i};${o};${u}m`;function a(){const s=new Map,i={modifier:{reset:[0,0],bold:[1,22],dim:[2,22],italic:[3,23],underline:[4,24],overline:[53,55],inverse:[7,27],hidden:[8,28],strikethrough:[9,29]},color:{black:[30,39],red:[31,39],green:[32,39],yellow:[33,39],blue:[34,39],magenta:[35,39],cyan:[36,39],white:[37,39],blackBright:[90,39],redBright:[91,39],greenBright:[92,39],yellowBright:[93,39],blueBright:[94,39],magentaBright:[95,39],cyanBright:[96,39],whiteBright:[97,39]},bgColor:{bgBlack:[40,49],bgRed:[41,49],bgGreen:[42,49],bgYellow:[43,49],bgBlue:[44,49],bgMagenta:[45,49],bgCyan:[46,49],bgWhite:[47,49],bgBlackBright:[100,49],bgRedBright:[101,49],bgGreenBright:[102,49],bgYellowBright:[103,49],bgBlueBright:[104,49],bgMagentaBright:[105,49],bgCyanBright:[106,49],bgWhiteBright:[107,49]}};i.color.gray=i.color.blackBright,i.bgColor.bgGray=i.bgColor.bgBlackBright,i.color.grey=i.color.blackBright,i.bgColor.bgGrey=i.bgColor.bgBlackBright;for(const[o,u]of Object.entries(i)){for(const[c,l]of Object.entries(u))i[c]={open:`\x1B[${l[0]}m`,close:`\x1B[${l[1]}m`},u[c]=i[c],s.set(l[0],l[1]);Object.defineProperty(i,o,{value:u,enumerable:!1})}return Object.defineProperty(i,"codes",{value:s,enumerable:!1}),i.color.close="\x1B[39m",i.bgColor.close="\x1B[49m",i.color.ansi256=t(),i.color.ansi16m=r(),i.bgColor.ansi256=t(10),i.bgColor.ansi16m=r(10),Object.defineProperties(i,{rgbToAnsi256:{value:(o,u,c)=>o===u&&u===c?o<8?16:o>248?231:Math.round((o-8)/247*24)+232:16+36*Math.round(o/255*5)+6*Math.round(u/255*5)+Math.round(c/255*5),enumerable:!1},hexToRgb:{value:o=>{const u=/(?<colorString>[a-f\d]{6}|[a-f\d]{3})/i.exec(o.toString(16));if(!u)return[0,0,0];let{colorString:c}=u.groups;c.length===3&&(c=c.split("").map(d=>d+d).join(""));const l=Number.parseInt(c,16);return[l>>16&255,l>>8&255,l&255]},enumerable:!1},hexToAnsi256:{value:o=>i.rgbToAnsi256(...i.hexToRgb(o)),enumerable:!1}}),i}Object.defineProperty(n,"exports",{enumerable:!0,get:a})})(Rn);var td=Rn.exports;const fs=yn(td);function re(n,e){return`${n.open}${e}${n.close}`}function me(n,e){try{return JSON.stringify(n,null,2)}catch{return e}}function ma(n){return typeof n=="string"?n.trim():n==null?n:me(n,n.toString())}function Fe(n){if(!n.end_time)return"";const e=n.end_time-n.start_time;return e<1e3?`${e}ms`:`${(e/1e3).toFixed(2)}s`}const{color:oe}=fs;class ga extends Wt{constructor(){super(...arguments),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"console_callback_handler"})}persistRun(e){return Promise.resolve()}getParents(e){const t=[];let r=e;for(;r.parent_run_id;){const a=this.runMap.get(r.parent_run_id);if(a)t.push(a),r=a;else break}return t}getBreadcrumbs(e){const r=[...this.getParents(e).reverse(),e].map((a,s,i)=>{const o=`${a.execution_order}:${a.run_type}:${a.name}`;return s===i.length-1?re(fs.bold,o):o}).join(" > ");return re(oe.grey,r)}onChainStart(e){const t=this.getBreadcrumbs(e);console.log(`${re(oe.green,"[chain/start]")} [${t}] Entering Chain run with input: ${me(e.inputs,"[inputs]")}`)}onChainEnd(e){const t=this.getBreadcrumbs(e);console.log(`${re(oe.cyan,"[chain/end]")} [${t}] [${Fe(e)}] Exiting Chain run with output: ${me(e.outputs,"[outputs]")}`)}onChainError(e){const t=this.getBreadcrumbs(e);console.log(`${re(oe.red,"[chain/error]")} [${t}] [${Fe(e)}] Chain run errored with error: ${me(e.error,"[error]")}`)}onLLMStart(e){const t=this.getBreadcrumbs(e),r="prompts"in e.inputs?{prompts:e.inputs.prompts.map(a=>a.trim())}:e.inputs;console.log(`${re(oe.green,"[llm/start]")} [${t}] Entering LLM run with input: ${me(r,"[inputs]")}`)}onLLMEnd(e){const t=this.getBreadcrumbs(e);console.log(`${re(oe.cyan,"[llm/end]")} [${t}] [${Fe(e)}] Exiting LLM run with output: ${me(e.outputs,"[response]")}`)}onLLMError(e){const t=this.getBreadcrumbs(e);console.log(`${re(oe.red,"[llm/error]")} [${t}] [${Fe(e)}] LLM run errored with error: ${me(e.error,"[error]")}`)}onToolStart(e){const t=this.getBreadcrumbs(e);console.log(`${re(oe.green,"[tool/start]")} [${t}] Entering Tool run with input: "${ma(e.inputs.input)}"`)}onToolEnd(e){const t=this.getBreadcrumbs(e);console.log(`${re(oe.cyan,"[tool/end]")} [${t}] [${Fe(e)}] Exiting Tool run with output: "${ma(e.outputs?.output)}"`)}onToolError(e){const t=this.getBreadcrumbs(e);console.log(`${re(oe.red,"[tool/error]")} [${t}] [${Fe(e)}] Tool run errored with error: ${me(e.error,"[error]")}`)}onRetrieverStart(e){const t=this.getBreadcrumbs(e);console.log(`${re(oe.green,"[retriever/start]")} [${t}] Entering Retriever run with input: ${me(e.inputs,"[inputs]")}`)}onRetrieverEnd(e){const t=this.getBreadcrumbs(e);console.log(`${re(oe.cyan,"[retriever/end]")} [${t}] [${Fe(e)}] Exiting Retriever run with output: ${me(e.outputs,"[outputs]")}`)}onRetrieverError(e){const t=this.getBreadcrumbs(e);console.log(`${re(oe.red,"[retriever/error]")} [${t}] [${Fe(e)}] Retriever run errored with error: ${me(e.error,"[error]")}`)}onAgentAction(e){const t=e,r=this.getBreadcrumbs(e);console.log(`${re(oe.blue,"[agent/action]")} [${r}] Agent selected action: ${me(t.actions[t.actions.length-1],"[action]")}`)}}function rd(n){return!!(n&&typeof n=="object"&&"type"in n&&n.type==="tool_call")}class nd extends Error{constructor(e,t){super(e),Object.defineProperty(this,"output",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.output=t}}function ad(n){if(typeof n>"u")return null;try{return JSON.parse(n)}catch{}let e="";const t=[];let r=!1,a=!1;for(let s of n){if(r)s==='"'&&!a?r=!1:s===`
`&&!a?s="\\n":s==="\\"?a=!a:a=!1;else if(s==='"')r=!0,a=!1;else if(s==="{")t.push("}");else if(s==="[")t.push("]");else if(s==="}"||s==="]")if(t&&t[t.length-1]===s)t.pop();else return null;e+=s}r&&(e+='"');for(let s=t.length-1;s>=0;s-=1)e+=t[s];try{return JSON.parse(e)}catch{return null}}function sd(n,e){return typeof n=="string"?typeof e=="string"?n+e:[{type:"text",text:n},...e]:Array.isArray(e)?xn(n,e)??[...n,...e]:[...n,{type:"text",text:e}]}function id(n,e){function t(r,a){if(typeof r!="object"||r===null||r===void 0)return r;if(a>=e)return Array.isArray(r)?"[Array]":"[Object]";if(Array.isArray(r))return r.map(i=>t(i,a+1));const s={};for(const i of Object.keys(r))s[i]=t(r[i],a+1);return s}return JSON.stringify(t(n,0),null,2)}class od extends mt{get lc_aliases(){return{additional_kwargs:"additional_kwargs",response_metadata:"response_metadata"}}get text(){return typeof this.content=="string"?this.content:""}getType(){return this._getType()}constructor(e,t){typeof e=="string"&&(e={content:e,additional_kwargs:t,response_metadata:{}}),e.additional_kwargs||(e.additional_kwargs={}),e.response_metadata||(e.response_metadata={}),super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","messages"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"content",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"additional_kwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"response_metadata",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"id",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.name=e.name,this.content=e.content,this.additional_kwargs=e.additional_kwargs,this.response_metadata=e.response_metadata,this.id=e.id}toDict(){return{type:this._getType(),data:this.toJSON().kwargs}}static lc_name(){return"BaseMessage"}get _printableFields(){return{id:this.id,content:this.content,name:this.name,additional_kwargs:this.additional_kwargs,response_metadata:this.response_metadata}}_updateId(e){this.id=e,this.lc_kwargs.id=e}get[Symbol.toStringTag](){return this.constructor.lc_name()}[Symbol.for("nodejs.util.inspect.custom")](e){if(e===null)return this;const t=id(this._printableFields,Math.max(4,e));return`${this.constructor.lc_name()} ${t}`}}function mr(n,e){const t={...n};for(const[r,a]of Object.entries(e))if(t[r]==null)t[r]=a;else{if(a==null)continue;if(typeof t[r]!=typeof a||Array.isArray(t[r])!==Array.isArray(a))throw new Error(`field[${r}] already exists in the message chunk, but with a different type.`);if(typeof t[r]=="string"){if(r==="type")continue;t[r]+=a}else if(typeof t[r]=="object"&&!Array.isArray(t[r]))t[r]=mr(t[r],a);else if(Array.isArray(t[r]))t[r]=xn(t[r],a);else{if(t[r]===a)continue;console.warn(`field[${r}] already exists in this message chunk and value has unsupported type.`)}}return t}function xn(n,e){if(!(n===void 0&&e===void 0)){if(n===void 0||e===void 0)return n||e;{const t=[...n];for(const r of e)if(typeof r=="object"&&"index"in r&&typeof r.index=="number"){const a=t.findIndex(s=>s.index===r.index);a!==-1?t[a]=mr(t[a],r):t.push(r)}else{if(typeof r=="object"&&"text"in r&&r.text==="")continue;t.push(r)}return t}}}class ud extends od{}class $r extends ud{constructor(e){let t;if(typeof e=="string")t={content:e,tool_calls:[],invalid_tool_calls:[],tool_call_chunks:[]};else if(e.tool_call_chunks===void 0)t={...e,tool_calls:e.tool_calls??[],invalid_tool_calls:[],tool_call_chunks:[],usage_metadata:e.usage_metadata!==void 0?e.usage_metadata:void 0};else{const r=[],a=[];for(const s of e.tool_call_chunks){let i={};try{if(i=ad(s.args||"{}"),i===null||typeof i!="object"||Array.isArray(i))throw new Error("Malformed tool call chunk args.");r.push({name:s.name??"",args:i,id:s.id,type:"tool_call"})}catch{a.push({name:s.name,args:s.args,id:s.id,error:"Malformed args.",type:"invalid_tool_call"})}}t={...e,tool_calls:r,invalid_tool_calls:a,usage_metadata:e.usage_metadata!==void 0?e.usage_metadata:void 0}}super(t),Object.defineProperty(this,"tool_calls",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"invalid_tool_calls",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"tool_call_chunks",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"usage_metadata",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.tool_call_chunks=t.tool_call_chunks??this.tool_call_chunks,this.tool_calls=t.tool_calls??this.tool_calls,this.invalid_tool_calls=t.invalid_tool_calls??this.invalid_tool_calls,this.usage_metadata=t.usage_metadata}get lc_aliases(){return{...super.lc_aliases,tool_calls:"tool_calls",invalid_tool_calls:"invalid_tool_calls",tool_call_chunks:"tool_call_chunks"}}static lc_name(){return"AIMessageChunk"}_getType(){return"ai"}get _printableFields(){return{...super._printableFields,tool_calls:this.tool_calls,tool_call_chunks:this.tool_call_chunks,invalid_tool_calls:this.invalid_tool_calls,usage_metadata:this.usage_metadata}}concat(e){const t={content:sd(this.content,e.content),additional_kwargs:mr(this.additional_kwargs,e.additional_kwargs),response_metadata:mr(this.response_metadata,e.response_metadata),tool_call_chunks:[],id:this.id??e.id};if(this.tool_call_chunks!==void 0||e.tool_call_chunks!==void 0){const r=xn(this.tool_call_chunks,e.tool_call_chunks);r!==void 0&&r.length>0&&(t.tool_call_chunks=r)}if(this.usage_metadata!==void 0||e.usage_metadata!==void 0){const r={...(this.usage_metadata?.input_token_details?.audio!==void 0||e.usage_metadata?.input_token_details?.audio!==void 0)&&{audio:(this.usage_metadata?.input_token_details?.audio??0)+(e.usage_metadata?.input_token_details?.audio??0)},...(this.usage_metadata?.input_token_details?.cache_read!==void 0||e.usage_metadata?.input_token_details?.cache_read!==void 0)&&{cache_read:(this.usage_metadata?.input_token_details?.cache_read??0)+(e.usage_metadata?.input_token_details?.cache_read??0)},...(this.usage_metadata?.input_token_details?.cache_creation!==void 0||e.usage_metadata?.input_token_details?.cache_creation!==void 0)&&{cache_creation:(this.usage_metadata?.input_token_details?.cache_creation??0)+(e.usage_metadata?.input_token_details?.cache_creation??0)}},a={...(this.usage_metadata?.output_token_details?.audio!==void 0||e.usage_metadata?.output_token_details?.audio!==void 0)&&{audio:(this.usage_metadata?.output_token_details?.audio??0)+(e.usage_metadata?.output_token_details?.audio??0)},...(this.usage_metadata?.output_token_details?.reasoning!==void 0||e.usage_metadata?.output_token_details?.reasoning!==void 0)&&{reasoning:(this.usage_metadata?.output_token_details?.reasoning??0)+(e.usage_metadata?.output_token_details?.reasoning??0)}},s=this.usage_metadata??{input_tokens:0,output_tokens:0,total_tokens:0},i=e.usage_metadata??{input_tokens:0,output_tokens:0,total_tokens:0},o={input_tokens:s.input_tokens+i.input_tokens,output_tokens:s.output_tokens+i.output_tokens,total_tokens:s.total_tokens+i.total_tokens,...Object.keys(r).length>0&&{input_token_details:r},...Object.keys(a).length>0&&{output_token_details:a}};t.usage_metadata=o}return new $r(t)}}function cd(n,e="Human",t="AI"){const r=[];for(const a of n){let s;if(a._getType()==="human")s=e;else if(a._getType()==="ai")s=t;else if(a._getType()==="system")s="System";else if(a._getType()==="function")s="Function";else if(a._getType()==="tool")s="Tool";else if(a._getType()==="generic")s=a.role;else throw new Error(`Got unsupported message type: ${a._getType()}`);const i=a.name?`${a.name}, `:"",o=typeof a.content=="string"?a.content:JSON.stringify(a.content,null,2);r.push(`${s}: ${i}${o}`)}return r.join(`
`)}let Jr;const ld=()=>{if(Jr===void 0){const n=Ze("LANGCHAIN_CALLBACKS_BACKGROUND")==="false"?{blockOnRootRunFinalization:!0}:{};Jr=new Zt(n)}return Jr};class It extends Wt{constructor(e={}){super(e),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"langchain_tracer"}),Object.defineProperty(this,"projectName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"exampleId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"client",{enumerable:!0,configurable:!0,writable:!0,value:void 0});const{exampleId:t,projectName:r,client:a}=e;this.projectName=r??Ze("LANGCHAIN_PROJECT")??Ze("LANGCHAIN_SESSION"),this.exampleId=t,this.client=a??ld();const s=It.getTraceableRunTree();s&&this.updateFromRunTree(s)}async _convertToCreate(e,t=void 0){return{...e,extra:{...e.extra,runtime:await Xl()},child_runs:void 0,session_name:this.projectName,reference_example_id:e.parent_run_id?void 0:t}}async persistRun(e){}async onRunCreate(e){const t=await this._convertToCreate(e,this.exampleId);await this.client.createRun(t)}async onRunUpdate(e){const t={end_time:e.end_time,error:e.error,outputs:e.outputs,events:e.events,inputs:e.inputs,trace_id:e.trace_id,dotted_order:e.dotted_order,parent_run_id:e.parent_run_id};await this.client.updateRun(e.id,t)}getRun(e){return this.runMap.get(e)}updateFromRunTree(e){let t=e;const r=new Set;for(;t.parent_run&&!(r.has(t.id)||(r.add(t.id),!t.parent_run));)t=t.parent_run;r.clear();const a=[t];for(;a.length>0;){const s=a.shift();!s||r.has(s.id)||(r.add(s.id),this.runMap.set(s.id,s),s.child_runs&&a.push(...s.child_runs))}this.client=e.client??this.client,this.projectName=e.project_name??this.projectName,this.exampleId=e.reference_example_id??this.exampleId}convertToRunTree(e){const t={},r=[];for(const[a,s]of this.runMap){const i=new de({...s,child_runs:[],parent_run:void 0,client:this.client,project_name:this.projectName,reference_example_id:this.exampleId,tracingEnabled:!0});t[a]=i,r.push([a,s.dotted_order])}r.sort((a,s)=>!a[1]||!s[1]?0:a[1].localeCompare(s[1]));for(const[a]of r){const s=this.runMap.get(a),i=t[a];if(!(!s||!i)&&s.parent_run_id){const o=t[s.parent_run_id];o&&(o.child_runs.push(i),i.parent_run=o)}}return t[e]}static getTraceableRunTree(){try{return Tl()}catch{return}}}const ps=Symbol.for("ls:tracing_async_local_storage"),rr=Symbol.for("lc:context_variables"),dd=n=>{globalThis[ps]=n},Ht=()=>globalThis[ps];let $t;function hd(){const n="default"in je?je.default:je;return new n({autoStart:!0,concurrency:1})}function fd(){return typeof $t>"u"&&($t=hd()),$t}async function Y(n,e){if(e===!0){const t=Ht();t!==void 0?await t.run(void 0,async()=>n()):await n()}else $t=fd(),$t.add(async()=>{const t=Ht();t!==void 0?await t.run(void 0,async()=>n()):await n()})}const pd=n=>!!["LANGSMITH_TRACING_V2","LANGCHAIN_TRACING_V2","LANGSMITH_TRACING","LANGCHAIN_TRACING"].find(t=>Ze(t)==="true");function ms(n){const e=Ht();return e===void 0?void 0:e.getStore()?.[rr]?.[n]}const md=Symbol("lc:configure_hooks"),gd=()=>ms(md)||[];class yd{setHandler(e){return this.setHandlers([e])}}class Ar{constructor(e,t,r,a,s,i,o,u){Object.defineProperty(this,"runId",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"handlers",{enumerable:!0,configurable:!0,writable:!0,value:t}),Object.defineProperty(this,"inheritableHandlers",{enumerable:!0,configurable:!0,writable:!0,value:r}),Object.defineProperty(this,"tags",{enumerable:!0,configurable:!0,writable:!0,value:a}),Object.defineProperty(this,"inheritableTags",{enumerable:!0,configurable:!0,writable:!0,value:s}),Object.defineProperty(this,"metadata",{enumerable:!0,configurable:!0,writable:!0,value:i}),Object.defineProperty(this,"inheritableMetadata",{enumerable:!0,configurable:!0,writable:!0,value:o}),Object.defineProperty(this,"_parentRunId",{enumerable:!0,configurable:!0,writable:!0,value:u})}get parentRunId(){return this._parentRunId}async handleText(e){await Promise.all(this.handlers.map(t=>Y(async()=>{try{await t.handleText?.(e,this.runId,this._parentRunId,this.tags)}catch(r){if((t.raiseError?console.error:console.warn)(`Error in handler ${t.constructor.name}, handleText: ${r}`),t.raiseError)throw r}},t.awaitHandlers)))}async handleCustomEvent(e,t,r,a,s){await Promise.all(this.handlers.map(i=>Y(async()=>{try{await i.handleCustomEvent?.(e,t,this.runId,this.tags,this.metadata)}catch(o){if((i.raiseError?console.error:console.warn)(`Error in handler ${i.constructor.name}, handleCustomEvent: ${o}`),i.raiseError)throw o}},i.awaitHandlers)))}}class _d extends Ar{getChild(e){const t=new ve(this.runId);return t.setHandlers(this.inheritableHandlers),t.addTags(this.inheritableTags),t.addMetadata(this.inheritableMetadata),e&&t.addTags([e],!1),t}async handleRetrieverEnd(e){await Promise.all(this.handlers.map(t=>Y(async()=>{if(!t.ignoreRetriever)try{await t.handleRetrieverEnd?.(e,this.runId,this._parentRunId,this.tags)}catch(r){if((t.raiseError?console.error:console.warn)(`Error in handler ${t.constructor.name}, handleRetriever`),t.raiseError)throw r}},t.awaitHandlers)))}async handleRetrieverError(e){await Promise.all(this.handlers.map(t=>Y(async()=>{if(!t.ignoreRetriever)try{await t.handleRetrieverError?.(e,this.runId,this._parentRunId,this.tags)}catch(r){if((t.raiseError?console.error:console.warn)(`Error in handler ${t.constructor.name}, handleRetrieverError: ${r}`),t.raiseError)throw e}},t.awaitHandlers)))}}class ya extends Ar{async handleLLMNewToken(e,t,r,a,s,i){await Promise.all(this.handlers.map(o=>Y(async()=>{if(!o.ignoreLLM)try{await o.handleLLMNewToken?.(e,t??{prompt:0,completion:0},this.runId,this._parentRunId,this.tags,i)}catch(u){if((o.raiseError?console.error:console.warn)(`Error in handler ${o.constructor.name}, handleLLMNewToken: ${u}`),o.raiseError)throw u}},o.awaitHandlers)))}async handleLLMError(e){await Promise.all(this.handlers.map(t=>Y(async()=>{if(!t.ignoreLLM)try{await t.handleLLMError?.(e,this.runId,this._parentRunId,this.tags)}catch(r){if((t.raiseError?console.error:console.warn)(`Error in handler ${t.constructor.name}, handleLLMError: ${r}`),t.raiseError)throw r}},t.awaitHandlers)))}async handleLLMEnd(e){await Promise.all(this.handlers.map(t=>Y(async()=>{if(!t.ignoreLLM)try{await t.handleLLMEnd?.(e,this.runId,this._parentRunId,this.tags)}catch(r){if((t.raiseError?console.error:console.warn)(`Error in handler ${t.constructor.name}, handleLLMEnd: ${r}`),t.raiseError)throw r}},t.awaitHandlers)))}}class bd extends Ar{getChild(e){const t=new ve(this.runId);return t.setHandlers(this.inheritableHandlers),t.addTags(this.inheritableTags),t.addMetadata(this.inheritableMetadata),e&&t.addTags([e],!1),t}async handleChainError(e,t,r,a,s){await Promise.all(this.handlers.map(i=>Y(async()=>{if(!i.ignoreChain)try{await i.handleChainError?.(e,this.runId,this._parentRunId,this.tags,s)}catch(o){if((i.raiseError?console.error:console.warn)(`Error in handler ${i.constructor.name}, handleChainError: ${o}`),i.raiseError)throw o}},i.awaitHandlers)))}async handleChainEnd(e,t,r,a,s){await Promise.all(this.handlers.map(i=>Y(async()=>{if(!i.ignoreChain)try{await i.handleChainEnd?.(e,this.runId,this._parentRunId,this.tags,s)}catch(o){if((i.raiseError?console.error:console.warn)(`Error in handler ${i.constructor.name}, handleChainEnd: ${o}`),i.raiseError)throw o}},i.awaitHandlers)))}async handleAgentAction(e){await Promise.all(this.handlers.map(t=>Y(async()=>{if(!t.ignoreAgent)try{await t.handleAgentAction?.(e,this.runId,this._parentRunId,this.tags)}catch(r){if((t.raiseError?console.error:console.warn)(`Error in handler ${t.constructor.name}, handleAgentAction: ${r}`),t.raiseError)throw r}},t.awaitHandlers)))}async handleAgentEnd(e){await Promise.all(this.handlers.map(t=>Y(async()=>{if(!t.ignoreAgent)try{await t.handleAgentEnd?.(e,this.runId,this._parentRunId,this.tags)}catch(r){if((t.raiseError?console.error:console.warn)(`Error in handler ${t.constructor.name}, handleAgentEnd: ${r}`),t.raiseError)throw r}},t.awaitHandlers)))}}class wd extends Ar{getChild(e){const t=new ve(this.runId);return t.setHandlers(this.inheritableHandlers),t.addTags(this.inheritableTags),t.addMetadata(this.inheritableMetadata),e&&t.addTags([e],!1),t}async handleToolError(e){await Promise.all(this.handlers.map(t=>Y(async()=>{if(!t.ignoreAgent)try{await t.handleToolError?.(e,this.runId,this._parentRunId,this.tags)}catch(r){if((t.raiseError?console.error:console.warn)(`Error in handler ${t.constructor.name}, handleToolError: ${r}`),t.raiseError)throw r}},t.awaitHandlers)))}async handleToolEnd(e){await Promise.all(this.handlers.map(t=>Y(async()=>{if(!t.ignoreAgent)try{await t.handleToolEnd?.(e,this.runId,this._parentRunId,this.tags)}catch(r){if((t.raiseError?console.error:console.warn)(`Error in handler ${t.constructor.name}, handleToolEnd: ${r}`),t.raiseError)throw r}},t.awaitHandlers)))}}class ve extends yd{constructor(e,t){super(),Object.defineProperty(this,"handlers",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"inheritableHandlers",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"tags",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"inheritableTags",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"metadata",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"inheritableMetadata",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"callback_manager"}),Object.defineProperty(this,"_parentRunId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.handlers=t?.handlers??this.handlers,this.inheritableHandlers=t?.inheritableHandlers??this.inheritableHandlers,this.tags=t?.tags??this.tags,this.inheritableTags=t?.inheritableTags??this.inheritableTags,this.metadata=t?.metadata??this.metadata,this.inheritableMetadata=t?.inheritableMetadata??this.inheritableMetadata,this._parentRunId=e}getParentRunId(){return this._parentRunId}async handleLLMStart(e,t,r=void 0,a=void 0,s=void 0,i=void 0,o=void 0,u=void 0){return Promise.all(t.map(async(c,l)=>{const d=l===0&&r?r:ue();return await Promise.all(this.handlers.map(h=>{if(!h.ignoreLLM)return vt(h)&&h._createRunForLLMStart(e,[c],d,this._parentRunId,s,this.tags,this.metadata,u),Y(async()=>{try{await h.handleLLMStart?.(e,[c],d,this._parentRunId,s,this.tags,this.metadata,u)}catch(f){if((h.raiseError?console.error:console.warn)(`Error in handler ${h.constructor.name}, handleLLMStart: ${f}`),h.raiseError)throw f}},h.awaitHandlers)})),new ya(d,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}))}async handleChatModelStart(e,t,r=void 0,a=void 0,s=void 0,i=void 0,o=void 0,u=void 0){return Promise.all(t.map(async(c,l)=>{const d=l===0&&r?r:ue();return await Promise.all(this.handlers.map(h=>{if(!h.ignoreLLM)return vt(h)&&h._createRunForChatModelStart(e,[c],d,this._parentRunId,s,this.tags,this.metadata,u),Y(async()=>{try{if(h.handleChatModelStart)await h.handleChatModelStart?.(e,[c],d,this._parentRunId,s,this.tags,this.metadata,u);else if(h.handleLLMStart){const f=cd(c);await h.handleLLMStart?.(e,[f],d,this._parentRunId,s,this.tags,this.metadata,u)}}catch(f){if((h.raiseError?console.error:console.warn)(`Error in handler ${h.constructor.name}, handleLLMStart: ${f}`),h.raiseError)throw f}},h.awaitHandlers)})),new ya(d,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}))}async handleChainStart(e,t,r=ue(),a=void 0,s=void 0,i=void 0,o=void 0){return await Promise.all(this.handlers.map(u=>{if(!u.ignoreChain)return vt(u)&&u._createRunForChainStart(e,t,r,this._parentRunId,this.tags,this.metadata,a,o),Y(async()=>{try{await u.handleChainStart?.(e,t,r,this._parentRunId,this.tags,this.metadata,a,o)}catch(c){if((u.raiseError?console.error:console.warn)(`Error in handler ${u.constructor.name}, handleChainStart: ${c}`),u.raiseError)throw c}},u.awaitHandlers)})),new bd(r,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}async handleToolStart(e,t,r=ue(),a=void 0,s=void 0,i=void 0,o=void 0){return await Promise.all(this.handlers.map(u=>{if(!u.ignoreAgent)return vt(u)&&u._createRunForToolStart(e,t,r,this._parentRunId,this.tags,this.metadata,o),Y(async()=>{try{await u.handleToolStart?.(e,t,r,this._parentRunId,this.tags,this.metadata,o)}catch(c){if((u.raiseError?console.error:console.warn)(`Error in handler ${u.constructor.name}, handleToolStart: ${c}`),u.raiseError)throw c}},u.awaitHandlers)})),new wd(r,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}async handleRetrieverStart(e,t,r=ue(),a=void 0,s=void 0,i=void 0,o=void 0){return await Promise.all(this.handlers.map(u=>{if(!u.ignoreRetriever)return vt(u)&&u._createRunForRetrieverStart(e,t,r,this._parentRunId,this.tags,this.metadata,o),Y(async()=>{try{await u.handleRetrieverStart?.(e,t,r,this._parentRunId,this.tags,this.metadata,o)}catch(c){if((u.raiseError?console.error:console.warn)(`Error in handler ${u.constructor.name}, handleRetrieverStart: ${c}`),u.raiseError)throw c}},u.awaitHandlers)})),new _d(r,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}async handleCustomEvent(e,t,r,a,s){await Promise.all(this.handlers.map(i=>Y(async()=>{if(!i.ignoreCustomEvent)try{await i.handleCustomEvent?.(e,t,r,this.tags,this.metadata)}catch(o){if((i.raiseError?console.error:console.warn)(`Error in handler ${i.constructor.name}, handleCustomEvent: ${o}`),i.raiseError)throw o}},i.awaitHandlers)))}addHandler(e,t=!0){this.handlers.push(e),t&&this.inheritableHandlers.push(e)}removeHandler(e){this.handlers=this.handlers.filter(t=>t!==e),this.inheritableHandlers=this.inheritableHandlers.filter(t=>t!==e)}setHandlers(e,t=!0){this.handlers=[],this.inheritableHandlers=[];for(const r of e)this.addHandler(r,t)}addTags(e,t=!0){this.removeTags(e),this.tags.push(...e),t&&this.inheritableTags.push(...e)}removeTags(e){this.tags=this.tags.filter(t=>!e.includes(t)),this.inheritableTags=this.inheritableTags.filter(t=>!e.includes(t))}addMetadata(e,t=!0){this.metadata={...this.metadata,...e},t&&(this.inheritableMetadata={...this.inheritableMetadata,...e})}removeMetadata(e){for(const t of Object.keys(e))delete this.metadata[t],delete this.inheritableMetadata[t]}copy(e=[],t=!0){const r=new ve(this._parentRunId);for(const a of this.handlers){const s=this.inheritableHandlers.includes(a);r.addHandler(a,s)}for(const a of this.tags){const s=this.inheritableTags.includes(a);r.addTags([a],s)}for(const a of Object.keys(this.metadata)){const s=Object.keys(this.inheritableMetadata).includes(a);r.addMetadata({[a]:this.metadata[a]},s)}for(const a of e)r.handlers.filter(s=>s.name==="console_callback_handler").some(s=>s.name===a.name)||r.addHandler(a,t);return r}static fromHandlers(e){class t extends qt{constructor(){super(),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:ue()}),Object.assign(this,e)}}const r=new this;return r.addHandler(new t),r}static configure(e,t,r,a,s,i,o){return this._configureSync(e,t,r,a,s,i,o)}static _configureSync(e,t,r,a,s,i,o){let u;(e||t)&&(Array.isArray(e)||!e?(u=new ve,u.setHandlers(e?.map(gr)??[],!0)):u=e,u=u.copy(Array.isArray(t)?t.map(gr):t?.handlers,!1));const c=Ze("LANGCHAIN_VERBOSE")==="true"||o?.verbose,l=It.getTraceableRunTree()?.tracingEnabled||pd(),d=l||(Ze("LANGCHAIN_TRACING")??!1);if(c||d){if(u||(u=new ve),c&&!u.handlers.some(h=>h.name===ga.prototype.name)){const h=new ga;u.addHandler(h,!0)}if(d&&!u.handlers.some(h=>h.name==="langchain_tracer")&&l){const h=new It;u.addHandler(h,!0),u._parentRunId=It.getTraceableRunTree()?.id??u._parentRunId}}for(const{contextVar:h,inheritable:f=!0,handlerClass:p,envVar:S}of gd()){const m=S&&Ze(S)==="true"&&p;let _;const P=h!==void 0?ms(h):void 0;P&&Yl(P)?_=P:m&&(_=new p({})),_!==void 0&&(u||(u=new ve),u.handlers.some(b=>b.name===_.name)||u.addHandler(_,f))}return(r||a)&&u&&(u.addTags(r??[]),u.addTags(a??[],!1)),(s||i)&&u&&(u.addMetadata(s??{}),u.addMetadata(i??{},!1)),u}}function gr(n){return"name"in n?n:qt.fromMethods(n)}class vd{getStore(){}run(e,t){return t()}enterWith(e){}}const Ed=new vd,_a=Symbol.for("lc:child_config");class Od{getInstance(){return Ht()??Ed}getRunnableConfig(){return this.getInstance().getStore()?.extra?.[_a]}runWithConfig(e,t,r){const a=ve._configureSync(e?.callbacks,void 0,e?.tags,void 0,e?.metadata),s=this.getInstance(),i=s.getStore(),o=a?.getParentRunId(),u=a?.handlers?.find(l=>l?.name==="langchain_tracer");let c;return u&&o?c=u.convertToRunTree(o):r||(c=new de({name:"<runnable_lambda>",tracingEnabled:!1})),c&&(c.extra={...c.extra,[_a]:e}),i!==void 0&&i[rr]!==void 0&&(c[rr]=i[rr]),s.run(c,t)}initializeGlobalInstance(e){Ht()===void 0&&dd(e)}}const qe=new Od,Xr=25;async function Se(n){return ve._configureSync(n?.callbacks,void 0,n?.tags,void 0,n?.metadata)}function ba(...n){const e={};for(const t of n.filter(r=>!!r))for(const r of Object.keys(t))if(r==="metadata")e[r]={...e[r],...t[r]};else if(r==="tags"){const a=e[r]??[];e[r]=[...new Set(a.concat(t[r]??[]))]}else if(r==="configurable")e[r]={...e[r],...t[r]};else if(r==="timeout")e.timeout===void 0?e.timeout=t.timeout:t.timeout!==void 0&&(e.timeout=Math.min(e.timeout,t.timeout));else if(r==="signal")e.signal===void 0?e.signal=t.signal:t.signal!==void 0&&("any"in AbortSignal?e.signal=AbortSignal.any([e.signal,t.signal]):e.signal=t.signal);else if(r==="callbacks"){const a=e.callbacks,s=t.callbacks;if(Array.isArray(s))if(!a)e.callbacks=s;else if(Array.isArray(a))e.callbacks=a.concat(s);else{const i=a.copy();for(const o of s)i.addHandler(gr(o),!0);e.callbacks=i}else if(s)if(!a)e.callbacks=s;else if(Array.isArray(a)){const i=s.copy();for(const o of a)i.addHandler(gr(o),!0);e.callbacks=i}else e.callbacks=new ve(s._parentRunId,{handlers:a.handlers.concat(s.handlers),inheritableHandlers:a.inheritableHandlers.concat(s.inheritableHandlers),tags:Array.from(new Set(a.tags.concat(s.tags))),inheritableTags:Array.from(new Set(a.inheritableTags.concat(s.inheritableTags))),metadata:{...a.metadata,...s.metadata}})}else{const a=r;e[a]=t[a]??e[a]}return e}const Sd=new Set(["string","number","boolean"]);function V(n){const e=qe.getRunnableConfig();let t={tags:[],metadata:{},recursionLimit:25,runId:void 0};if(e){const{runId:r,runName:a,...s}=e;t=Object.entries(s).reduce((i,[o,u])=>(u!==void 0&&(i[o]=u),i),t)}if(n&&(t=Object.entries(n).reduce((r,[a,s])=>(s!==void 0&&(r[a]=s),r),t)),t?.configurable)for(const r of Object.keys(t.configurable))Sd.has(typeof t.configurable[r])&&!t.metadata?.[r]&&(t.metadata||(t.metadata={}),t.metadata[r]=t.configurable[r]);if(t.timeout!==void 0){if(t.timeout<=0)throw new Error("Timeout must be a positive number");const r=AbortSignal.timeout(t.timeout);t.signal!==void 0?"any"in AbortSignal&&(t.signal=AbortSignal.any([t.signal,r])):t.signal=r,delete t.timeout}return t}function ee(n={},{callbacks:e,maxConcurrency:t,recursionLimit:r,runName:a,configurable:s,runId:i}={}){const o=V(n);return e!==void 0&&(delete o.runName,o.callbacks=e),r!==void 0&&(o.recursionLimit=r),t!==void 0&&(o.maxConcurrency=t),a!==void 0&&(o.runName=a),s!==void 0&&(o.configurable={...o.configurable,...s}),i!==void 0&&delete o.runId,o}function gt(n){return n?{configurable:n.configurable,recursionLimit:n.recursionLimit,callbacks:n.callbacks,tags:n.tags,metadata:n.metadata,maxConcurrency:n.maxConcurrency,timeout:n.timeout,signal:n.signal}:void 0}async function We(n,e){if(e===void 0)return n;let t;return Promise.race([n.catch(r=>{if(!e?.aborted)throw r}),new Promise((r,a)=>{t=()=>{a(new Error("Aborted"))},e.addEventListener("abort",t),e.aborted&&a(new Error("Aborted"))})]).finally(()=>e.removeEventListener("abort",t))}class fe extends ReadableStream{constructor(){super(...arguments),Object.defineProperty(this,"reader",{enumerable:!0,configurable:!0,writable:!0,value:void 0})}ensureReader(){this.reader||(this.reader=this.getReader())}async next(){this.ensureReader();try{const e=await this.reader.read();return e.done?(this.reader.releaseLock(),{done:!0,value:void 0}):{done:!1,value:e.value}}catch(e){throw this.reader.releaseLock(),e}}async return(){if(this.ensureReader(),this.locked){const e=this.reader.cancel();this.reader.releaseLock(),await e}return{done:!0,value:void 0}}async throw(e){if(this.ensureReader(),this.locked){const t=this.reader.cancel();this.reader.releaseLock(),await t}throw e}[Symbol.asyncIterator](){return this}async[Symbol.asyncDispose](){await this.return()}static fromReadableStream(e){const t=e.getReader();return new fe({start(r){return a();function a(){return t.read().then(({done:s,value:i})=>{if(s){r.close();return}return r.enqueue(i),a()})}},cancel(){t.releaseLock()}})}static fromAsyncGenerator(e){return new fe({async pull(t){const{value:r,done:a}=await e.next();a&&t.close(),t.enqueue(r)},async cancel(t){await e.return(t)}})}}function gs(n,e=2){const t=Array.from({length:e},()=>[]);return t.map(async function*(a){for(;;)if(a.length===0){const s=await n.next();for(const i of t)i.push(s)}else{if(a[0].done)return;yield a.shift().value}})}function Le(n,e){if(Array.isArray(n)&&Array.isArray(e))return n.concat(e);if(typeof n=="string"&&typeof e=="string")return n+e;if(typeof n=="number"&&typeof e=="number")return n+e;if("concat"in n&&typeof n.concat=="function")return n.concat(e);if(typeof n=="object"&&typeof e=="object"){const t={...n};for(const[r,a]of Object.entries(e))r in t&&!Array.isArray(t[r])?t[r]=Le(t[r],a):t[r]=a;return t}else throw new Error(`Cannot concat ${typeof n} and ${typeof e}`)}class _t{constructor(e){Object.defineProperty(this,"generator",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"setup",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"config",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"signal",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"firstResult",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"firstResultUsed",{enumerable:!0,configurable:!0,writable:!0,value:!1}),this.generator=e.generator,this.config=e.config,this.signal=e.signal??this.config?.signal,this.setup=new Promise((t,r)=>{qe.runWithConfig(gt(e.config),async()=>{this.firstResult=e.generator.next(),e.startSetup?this.firstResult.then(e.startSetup).then(t,r):this.firstResult.then(a=>t(void 0),r)},!0)})}async next(...e){return this.signal?.throwIfAborted(),this.firstResultUsed?qe.runWithConfig(gt(this.config),this.signal?async()=>We(this.generator.next(...e),this.signal):async()=>this.generator.next(...e),!0):(this.firstResultUsed=!0,this.firstResult)}async return(e){return this.generator.return(e)}async throw(e){return this.generator.throw(e)}[Symbol.asyncIterator](){return this}async[Symbol.asyncDispose](){await this.return()}}async function Td(n,e,t,r,...a){const s=new _t({generator:e,startSetup:t,signal:r}),i=await s.setup;return{output:n(s,i,...a),setup:i}}class Ue{constructor(e){Object.defineProperty(this,"ops",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.ops=e.ops??[]}concat(e){const t=this.ops.concat(e.ops),r=fr({},t);return new Gt({ops:t,state:r[r.length-1].newDocument})}}class Gt extends Ue{constructor(e){super(e),Object.defineProperty(this,"state",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.state=e.state}concat(e){const t=this.ops.concat(e.ops),r=fr(this.state,e.ops);return new Gt({ops:t,state:r[r.length-1].newDocument})}static fromRunLogPatch(e){const t=fr({},e.ops);return new Gt({ops:e.ops,state:t[t.length-1].newDocument})}}const kd=n=>n.name==="log_stream_tracer";async function wa(n,e){if(e==="original")throw new Error("Do not assign inputs with original schema drop the key for now. When inputs are added to streamLog they should be added with standardized schema for streaming events.");const{inputs:t}=n;if(["retriever","llm","prompt"].includes(n.run_type))return t;if(!(Object.keys(t).length===1&&t?.input===""))return t.input}async function va(n,e){const{outputs:t}=n;return e==="original"||["retriever","llm","prompt"].includes(n.run_type)?t:t!==void 0&&Object.keys(t).length===1&&t?.output!==void 0?t.output:t}function Id(n){return n!==void 0&&n.message!==void 0}class Ea extends Wt{constructor(e){super({_awaitHandler:!0,...e}),Object.defineProperty(this,"autoClose",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"includeNames",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"includeTypes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"includeTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeNames",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeTypes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_schemaFormat",{enumerable:!0,configurable:!0,writable:!0,value:"original"}),Object.defineProperty(this,"rootId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"keyMapByRunId",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"counterMapByRunName",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"transformStream",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"writer",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"receiveStream",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"log_stream_tracer"}),Object.defineProperty(this,"lc_prefer_streaming",{enumerable:!0,configurable:!0,writable:!0,value:!0}),this.autoClose=e?.autoClose??!0,this.includeNames=e?.includeNames,this.includeTypes=e?.includeTypes,this.includeTags=e?.includeTags,this.excludeNames=e?.excludeNames,this.excludeTypes=e?.excludeTypes,this.excludeTags=e?.excludeTags,this._schemaFormat=e?._schemaFormat??this._schemaFormat,this.transformStream=new TransformStream,this.writer=this.transformStream.writable.getWriter(),this.receiveStream=fe.fromReadableStream(this.transformStream.readable)}[Symbol.asyncIterator](){return this.receiveStream}async persistRun(e){}_includeRun(e){if(e.id===this.rootId)return!1;const t=e.tags??[];let r=this.includeNames===void 0&&this.includeTags===void 0&&this.includeTypes===void 0;return this.includeNames!==void 0&&(r=r||this.includeNames.includes(e.name)),this.includeTypes!==void 0&&(r=r||this.includeTypes.includes(e.run_type)),this.includeTags!==void 0&&(r=r||t.find(a=>this.includeTags?.includes(a))!==void 0),this.excludeNames!==void 0&&(r=r&&!this.excludeNames.includes(e.name)),this.excludeTypes!==void 0&&(r=r&&!this.excludeTypes.includes(e.run_type)),this.excludeTags!==void 0&&(r=r&&t.every(a=>!this.excludeTags?.includes(a))),r}async*tapOutputIterable(e,t){for await(const r of t){if(e!==this.rootId){const a=this.keyMapByRunId[e];a&&await this.writer.write(new Ue({ops:[{op:"add",path:`/logs/${a}/streamed_output/-`,value:r}]}))}yield r}}async onRunCreate(e){if(this.rootId===void 0&&(this.rootId=e.id,await this.writer.write(new Ue({ops:[{op:"replace",path:"",value:{id:e.id,name:e.name,type:e.run_type,streamed_output:[],final_output:void 0,logs:{}}}]}))),!this._includeRun(e))return;this.counterMapByRunName[e.name]===void 0&&(this.counterMapByRunName[e.name]=0),this.counterMapByRunName[e.name]+=1;const t=this.counterMapByRunName[e.name];this.keyMapByRunId[e.id]=t===1?e.name:`${e.name}:${t}`;const r={id:e.id,name:e.name,type:e.run_type,tags:e.tags??[],metadata:e.extra?.metadata??{},start_time:new Date(e.start_time).toISOString(),streamed_output:[],streamed_output_str:[],final_output:void 0,end_time:void 0};this._schemaFormat==="streaming_events"&&(r.inputs=await wa(e,this._schemaFormat)),await this.writer.write(new Ue({ops:[{op:"add",path:`/logs/${this.keyMapByRunId[e.id]}`,value:r}]}))}async onRunUpdate(e){try{const t=this.keyMapByRunId[e.id];if(t===void 0)return;const r=[];this._schemaFormat==="streaming_events"&&r.push({op:"replace",path:`/logs/${t}/inputs`,value:await wa(e,this._schemaFormat)}),r.push({op:"add",path:`/logs/${t}/final_output`,value:await va(e,this._schemaFormat)}),e.end_time!==void 0&&r.push({op:"add",path:`/logs/${t}/end_time`,value:new Date(e.end_time).toISOString()});const a=new Ue({ops:r});await this.writer.write(a)}finally{if(e.id===this.rootId){const t=new Ue({ops:[{op:"replace",path:"/final_output",value:await va(e,this._schemaFormat)}]});await this.writer.write(t),this.autoClose&&await this.writer.close()}}}async onLLMNewToken(e,t,r){const a=this.keyMapByRunId[e.id];if(a===void 0)return;const s=e.inputs.messages!==void 0;let i;s?Id(r?.chunk)?i=r?.chunk:i=new $r({id:`run-${e.id}`,content:t}):i=t;const o=new Ue({ops:[{op:"add",path:`/logs/${a}/streamed_output_str/-`,value:t},{op:"add",path:`/logs/${a}/streamed_output/-`,value:i}]});await this.writer.write(o)}}class yr{constructor(e){Object.defineProperty(this,"text",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"generationInfo",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.text=e.text,this.generationInfo=e.generationInfo}concat(e){return new yr({text:this.text+e.text,generationInfo:{...this.generationInfo,...e.generationInfo}})}}function tr({name:n,serialized:e}){return n!==void 0?n:e?.name!==void 0?e.name:e?.id!==void 0&&Array.isArray(e?.id)?e.id[e.id.length-1]:"Unnamed"}const $d=n=>n.name==="event_stream_tracer";class Ad extends Wt{constructor(e){super({_awaitHandler:!0,...e}),Object.defineProperty(this,"autoClose",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"includeNames",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"includeTypes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"includeTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeNames",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeTypes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"runInfoMap",{enumerable:!0,configurable:!0,writable:!0,value:new Map}),Object.defineProperty(this,"tappedPromises",{enumerable:!0,configurable:!0,writable:!0,value:new Map}),Object.defineProperty(this,"transformStream",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"writer",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"receiveStream",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"event_stream_tracer"}),Object.defineProperty(this,"lc_prefer_streaming",{enumerable:!0,configurable:!0,writable:!0,value:!0}),this.autoClose=e?.autoClose??!0,this.includeNames=e?.includeNames,this.includeTypes=e?.includeTypes,this.includeTags=e?.includeTags,this.excludeNames=e?.excludeNames,this.excludeTypes=e?.excludeTypes,this.excludeTags=e?.excludeTags,this.transformStream=new TransformStream,this.writer=this.transformStream.writable.getWriter(),this.receiveStream=fe.fromReadableStream(this.transformStream.readable)}[Symbol.asyncIterator](){return this.receiveStream}async persistRun(e){}_includeRun(e){const t=e.tags??[];let r=this.includeNames===void 0&&this.includeTags===void 0&&this.includeTypes===void 0;return this.includeNames!==void 0&&(r=r||this.includeNames.includes(e.name)),this.includeTypes!==void 0&&(r=r||this.includeTypes.includes(e.runType)),this.includeTags!==void 0&&(r=r||t.find(a=>this.includeTags?.includes(a))!==void 0),this.excludeNames!==void 0&&(r=r&&!this.excludeNames.includes(e.name)),this.excludeTypes!==void 0&&(r=r&&!this.excludeTypes.includes(e.runType)),this.excludeTags!==void 0&&(r=r&&t.every(a=>!this.excludeTags?.includes(a))),r}async*tapOutputIterable(e,t){const r=await t.next();if(r.done)return;const a=this.runInfoMap.get(e);if(a===void 0){yield r.value;return}function s(o,u){return o==="llm"&&typeof u=="string"?new yr({text:u}):u}let i=this.tappedPromises.get(e);if(i===void 0){let o;i=new Promise(u=>{o=u}),this.tappedPromises.set(e,i);try{const u={event:`on_${a.runType}_stream`,run_id:e,name:a.name,tags:a.tags,metadata:a.metadata,data:{}};await this.send({...u,data:{chunk:s(a.runType,r.value)}},a),yield r.value;for await(const c of t)a.runType!=="tool"&&a.runType!=="retriever"&&await this.send({...u,data:{chunk:s(a.runType,c)}},a),yield c}finally{o()}}else{yield r.value;for await(const o of t)yield o}}async send(e,t){this._includeRun(t)&&await this.writer.write(e)}async sendEndEvent(e,t){const r=this.tappedPromises.get(e.run_id);r!==void 0?r.then(()=>{this.send(e,t)}):await this.send(e,t)}async onLLMStart(e){const t=tr(e),r=e.inputs.messages!==void 0?"chat_model":"llm",a={tags:e.tags??[],metadata:e.extra?.metadata??{},name:t,runType:r,inputs:e.inputs};this.runInfoMap.set(e.id,a);const s=`on_${r}_start`;await this.send({event:s,data:{input:e.inputs},name:t,tags:e.tags??[],run_id:e.id,metadata:e.extra?.metadata??{}},a)}async onLLMNewToken(e,t,r){const a=this.runInfoMap.get(e.id);let s,i;if(a===void 0)throw new Error(`onLLMNewToken: Run ID ${e.id} not found in run map.`);if(this.runInfoMap.size!==1){if(a.runType==="chat_model")i="on_chat_model_stream",r?.chunk===void 0?s=new $r({content:t,id:`run-${e.id}`}):s=r.chunk.message;else if(a.runType==="llm")i="on_llm_stream",r?.chunk===void 0?s=new yr({text:t}):s=r.chunk;else throw new Error(`Unexpected run type ${a.runType}`);await this.send({event:i,data:{chunk:s},run_id:e.id,name:a.name,tags:a.tags,metadata:a.metadata},a)}}async onLLMEnd(e){const t=this.runInfoMap.get(e.id);this.runInfoMap.delete(e.id);let r;if(t===void 0)throw new Error(`onLLMEnd: Run ID ${e.id} not found in run map.`);const a=e.outputs?.generations;let s;if(t.runType==="chat_model"){for(const i of a??[]){if(s!==void 0)break;s=i[0]?.message}r="on_chat_model_end"}else if(t.runType==="llm")s={generations:a?.map(i=>i.map(o=>({text:o.text,generationInfo:o.generationInfo}))),llmOutput:e.outputs?.llmOutput??{}},r="on_llm_end";else throw new Error(`onLLMEnd: Unexpected run type: ${t.runType}`);await this.sendEndEvent({event:r,data:{output:s,input:t.inputs},run_id:e.id,name:t.name,tags:t.tags,metadata:t.metadata},t)}async onChainStart(e){const t=tr(e),r=e.run_type??"chain",a={tags:e.tags??[],metadata:e.extra?.metadata??{},name:t,runType:e.run_type};let s={};e.inputs.input===""&&Object.keys(e.inputs).length===1?(s={},a.inputs={}):e.inputs.input!==void 0?(s.input=e.inputs.input,a.inputs=e.inputs.input):(s.input=e.inputs,a.inputs=e.inputs),this.runInfoMap.set(e.id,a),await this.send({event:`on_${r}_start`,data:s,name:t,tags:e.tags??[],run_id:e.id,metadata:e.extra?.metadata??{}},a)}async onChainEnd(e){const t=this.runInfoMap.get(e.id);if(this.runInfoMap.delete(e.id),t===void 0)throw new Error(`onChainEnd: Run ID ${e.id} not found in run map.`);const r=`on_${e.run_type}_end`,a=e.inputs??t.inputs??{},i={output:e.outputs?.output??e.outputs,input:a};a.input&&Object.keys(a).length===1&&(i.input=a.input,t.inputs=a.input),await this.sendEndEvent({event:r,data:i,run_id:e.id,name:t.name,tags:t.tags,metadata:t.metadata??{}},t)}async onToolStart(e){const t=tr(e),r={tags:e.tags??[],metadata:e.extra?.metadata??{},name:t,runType:"tool",inputs:e.inputs??{}};this.runInfoMap.set(e.id,r),await this.send({event:"on_tool_start",data:{input:e.inputs??{}},name:t,run_id:e.id,tags:e.tags??[],metadata:e.extra?.metadata??{}},r)}async onToolEnd(e){const t=this.runInfoMap.get(e.id);if(this.runInfoMap.delete(e.id),t===void 0)throw new Error(`onToolEnd: Run ID ${e.id} not found in run map.`);if(t.inputs===void 0)throw new Error(`onToolEnd: Run ID ${e.id} is a tool call, and is expected to have traced inputs.`);const r=e.outputs?.output===void 0?e.outputs:e.outputs.output;await this.sendEndEvent({event:"on_tool_end",data:{output:r,input:t.inputs},run_id:e.id,name:t.name,tags:t.tags,metadata:t.metadata},t)}async onRetrieverStart(e){const t=tr(e),a={tags:e.tags??[],metadata:e.extra?.metadata??{},name:t,runType:"retriever",inputs:{query:e.inputs.query}};this.runInfoMap.set(e.id,a),await this.send({event:"on_retriever_start",data:{input:{query:e.inputs.query}},name:t,tags:e.tags??[],run_id:e.id,metadata:e.extra?.metadata??{}},a)}async onRetrieverEnd(e){const t=this.runInfoMap.get(e.id);if(this.runInfoMap.delete(e.id),t===void 0)throw new Error(`onRetrieverEnd: Run ID ${e.id} not found in run map.`);await this.sendEndEvent({event:"on_retriever_end",data:{output:e.outputs?.documents??e.outputs,input:t.inputs},run_id:e.id,name:t.name,tags:t.tags,metadata:t.metadata},t)}async handleCustomEvent(e,t,r){const a=this.runInfoMap.get(r);if(a===void 0)throw new Error(`handleCustomEvent: Run ID ${r} not found in run map.`);await this.send({event:"on_custom_event",run_id:r,name:e,tags:a.tags,metadata:a.metadata,data:t},a)}async finish(){const e=[...this.tappedPromises.values()];Promise.all(e).finally(()=>{this.writer.close()})}}const Rd=[400,401,402,403,404,405,406,407,409],xd=n=>{if(n.message.startsWith("Cancel")||n.message.startsWith("AbortError")||n.name==="AbortError"||n?.code==="ECONNABORTED")throw n;const e=n?.response?.status??n?.status;if(e&&Rd.includes(+e))throw n;if(n?.error?.code==="insufficient_quota"){const t=new Error(n?.message);throw t.name="InsufficientQuotaError",t}};class Cd{constructor(e){Object.defineProperty(this,"maxConcurrency",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"maxRetries",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"onFailedAttempt",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"queue",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.maxConcurrency=e.maxConcurrency??1/0,this.maxRetries=e.maxRetries??6,this.onFailedAttempt=e.onFailedAttempt??xd;const t="default"in je?je.default:je;this.queue=new t({concurrency:this.maxConcurrency})}call(e,...t){return this.queue.add(()=>lr(()=>e(...t).catch(r=>{throw r instanceof Error?r:new Error(r)}),{onFailedAttempt:this.onFailedAttempt,retries:this.maxRetries,randomize:!0}),{throwOnTimeout:!0})}callWithOptions(e,t,...r){return e.signal?Promise.race([this.call(t,...r),new Promise((a,s)=>{e.signal?.addEventListener("abort",()=>{s(new Error("AbortError"))})})]):this.call(t,...r)}fetch(...e){return this.call(()=>fetch(...e).then(t=>t.ok?t:Promise.reject(t)))}}class ys extends Wt{constructor({config:e,onStart:t,onEnd:r,onError:a}){super({_awaitHandler:!0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"RootListenersTracer"}),Object.defineProperty(this,"rootId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"config",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"argOnStart",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"argOnEnd",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"argOnError",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.config=e,this.argOnStart=t,this.argOnEnd=r,this.argOnError=a}persistRun(e){return Promise.resolve()}async onRunCreate(e){this.rootId||(this.rootId=e.id,this.argOnStart&&await this.argOnStart(e,this.config))}async onRunUpdate(e){e.id===this.rootId&&(e.error?this.argOnError&&await this.argOnError(e,this.config):this.argOnEnd&&await this.argOnEnd(e,this.config))}}function Cn(n){return n?n.lc_runnable:!1}class Pd{constructor(e){Object.defineProperty(this,"includeNames",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"includeTypes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"includeTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeNames",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeTypes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.includeNames=e.includeNames,this.includeTypes=e.includeTypes,this.includeTags=e.includeTags,this.excludeNames=e.excludeNames,this.excludeTypes=e.excludeTypes,this.excludeTags=e.excludeTags}includeEvent(e,t){let r=this.includeNames===void 0&&this.includeTypes===void 0&&this.includeTags===void 0;const a=e.tags??[];return this.includeNames!==void 0&&(r=r||this.includeNames.includes(e.name)),this.includeTypes!==void 0&&(r=r||this.includeTypes.includes(t)),this.includeTags!==void 0&&(r=r||a.some(s=>this.includeTags?.includes(s))),this.excludeNames!==void 0&&(r=r&&!this.excludeNames.includes(e.name)),this.excludeTypes!==void 0&&(r=r&&!this.excludeTypes.includes(t)),this.excludeTags!==void 0&&(r=r&&a.every(s=>!this.excludeTags?.includes(s))),r}}const Nd=Symbol("Let zodToJsonSchema decide on which parser to use"),Oa={name:void 0,$refStrategy:"root",basePath:["#"],effectStrategy:"input",pipeStrategy:"all",dateStrategy:"format:date-time",mapStrategy:"entries",removeAdditionalStrategy:"passthrough",definitionPath:"definitions",target:"jsonSchema7",strictUnions:!1,definitions:{},errorMessages:!1,markdownDescription:!1,patternStrategy:"escape",applyRegexFlags:!1,emailStrategy:"format:email",base64Strategy:"contentEncoding:base64",nameStrategy:"ref"},jd=n=>typeof n=="string"?{...Oa,name:n}:{...Oa,...n},Ld=n=>{const e=jd(n),t=e.name!==void 0?[...e.basePath,e.definitionPath,e.name]:e.basePath;return{...e,currentPath:t,propertyPath:void 0,seen:new Map(Object.entries(e.definitions).map(([r,a])=>[a._def,{def:a._def,path:[...e.basePath,e.definitionPath,r],jsonSchema:void 0}]))}};function _s(n,e,t,r){r?.errorMessages&&t&&(n.errorMessage={...n.errorMessage,[e]:t})}function G(n,e,t,r,a){n[e]=t,_s(n,e,r,a)}function Md(){return{}}function Dd(n,e){const t={type:"array"};return n.type?._def&&n.type?._def?.typeName!==y.ZodAny&&(t.items=Z(n.type._def,{...e,currentPath:[...e.currentPath,"items"]})),n.minLength&&G(t,"minItems",n.minLength.value,n.minLength.message,e),n.maxLength&&G(t,"maxItems",n.maxLength.value,n.maxLength.message,e),n.exactLength&&(G(t,"minItems",n.exactLength.value,n.exactLength.message,e),G(t,"maxItems",n.exactLength.value,n.exactLength.message,e)),t}function Fd(n,e){const t={type:"integer",format:"int64"};if(!n.checks)return t;for(const r of n.checks)switch(r.kind){case"min":e.target==="jsonSchema7"?r.inclusive?G(t,"minimum",r.value,r.message,e):G(t,"exclusiveMinimum",r.value,r.message,e):(r.inclusive||(t.exclusiveMinimum=!0),G(t,"minimum",r.value,r.message,e));break;case"max":e.target==="jsonSchema7"?r.inclusive?G(t,"maximum",r.value,r.message,e):G(t,"exclusiveMaximum",r.value,r.message,e):(r.inclusive||(t.exclusiveMaximum=!0),G(t,"maximum",r.value,r.message,e));break;case"multipleOf":G(t,"multipleOf",r.value,r.message,e);break}return t}function Ud(){return{type:"boolean"}}function bs(n,e){return Z(n.type._def,e)}const Bd=(n,e)=>Z(n.innerType._def,e);function ws(n,e,t){const r=t??e.dateStrategy;if(Array.isArray(r))return{anyOf:r.map((a,s)=>ws(n,e,a))};switch(r){case"string":case"format:date-time":return{type:"string",format:"date-time"};case"format:date":return{type:"string",format:"date"};case"integer":return Zd(n,e)}}const Zd=(n,e)=>{const t={type:"integer",format:"unix-time"};if(e.target==="openApi3")return t;for(const r of n.checks)switch(r.kind){case"min":G(t,"minimum",r.value,r.message,e);break;case"max":G(t,"maximum",r.value,r.message,e);break}return t};function Hd(n,e){return{...Z(n.innerType._def,e),default:n.defaultValue()}}function Gd(n,e){return e.effectStrategy==="input"?Z(n.schema._def,e):{}}function zd(n){return{type:"string",enum:Array.from(n.values)}}const Vd=n=>"type"in n&&n.type==="string"?!1:"allOf"in n;function qd(n,e){const t=[Z(n.left._def,{...e,currentPath:[...e.currentPath,"allOf","0"]}),Z(n.right._def,{...e,currentPath:[...e.currentPath,"allOf","1"]})].filter(s=>!!s);let r=e.target==="jsonSchema2019-09"?{unevaluatedProperties:!1}:void 0;const a=[];return t.forEach(s=>{if(Vd(s))a.push(...s.allOf),s.unevaluatedProperties===void 0&&(r=void 0);else{let i=s;if("additionalProperties"in s&&s.additionalProperties===!1){const{additionalProperties:o,...u}=s;i=u}else r=void 0;a.push(i)}}),a.length?{allOf:a,...r}:void 0}function Wd(n,e){const t=typeof n.value;return t!=="bigint"&&t!=="number"&&t!=="boolean"&&t!=="string"?{type:Array.isArray(n.value)?"array":"object"}:e.target==="openApi3"?{type:t==="bigint"?"integer":t,enum:[n.value]}:{type:t==="bigint"?"integer":t,const:n.value}}let Kr;const _e={cuid:/^[cC][^\s-]{8,}$/,cuid2:/^[0-9a-z]+$/,ulid:/^[0-9A-HJKMNP-TV-Z]{26}$/,email:/^(?!\.)(?!.*\.\.)([a-zA-Z0-9_'+\-\.]*)[a-zA-Z0-9_+-]@([a-zA-Z0-9][a-zA-Z0-9\-]*\.)+[a-zA-Z]{2,}$/,emoji:()=>(Kr===void 0&&(Kr=RegExp("^(\\p{Extended_Pictographic}|\\p{Emoji_Component})+$","u")),Kr),uuid:/^[0-9a-fA-F]{8}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{12}$/,ipv4:/^(?:(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])$/,ipv4Cidr:/^(?:(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\/(3[0-2]|[12]?[0-9])$/,ipv6:/^(([a-f0-9]{1,4}:){7}|::([a-f0-9]{1,4}:){0,6}|([a-f0-9]{1,4}:){1}:([a-f0-9]{1,4}:){0,5}|([a-f0-9]{1,4}:){2}:([a-f0-9]{1,4}:){0,4}|([a-f0-9]{1,4}:){3}:([a-f0-9]{1,4}:){0,3}|([a-f0-9]{1,4}:){4}:([a-f0-9]{1,4}:){0,2}|([a-f0-9]{1,4}:){5}:([a-f0-9]{1,4}:){0,1})([a-f0-9]{1,4}|(((25[0-5])|(2[0-4][0-9])|(1[0-9]{2})|([0-9]{1,2}))\.){3}((25[0-5])|(2[0-4][0-9])|(1[0-9]{2})|([0-9]{1,2})))$/,ipv6Cidr:/^(([0-9a-fA-F]{1,4}:){7,7}[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,7}:|([0-9a-fA-F]{1,4}:){1,6}:[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,5}(:[0-9a-fA-F]{1,4}){1,2}|([0-9a-fA-F]{1,4}:){1,4}(:[0-9a-fA-F]{1,4}){1,3}|([0-9a-fA-F]{1,4}:){1,3}(:[0-9a-fA-F]{1,4}){1,4}|([0-9a-fA-F]{1,4}:){1,2}(:[0-9a-fA-F]{1,4}){1,5}|[0-9a-fA-F]{1,4}:((:[0-9a-fA-F]{1,4}){1,6})|:((:[0-9a-fA-F]{1,4}){1,7}|:)|fe80:(:[0-9a-fA-F]{0,4}){0,4}%[0-9a-zA-Z]{1,}|::(ffff(:0{1,4}){0,1}:){0,1}((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])|([0-9a-fA-F]{1,4}:){1,4}:((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9]))\/(12[0-8]|1[01][0-9]|[1-9]?[0-9])$/,base64:/^([0-9a-zA-Z+/]{4})*(([0-9a-zA-Z+/]{2}==)|([0-9a-zA-Z+/]{3}=))?$/,base64url:/^([0-9a-zA-Z-_]{4})*(([0-9a-zA-Z-_]{2}(==)?)|([0-9a-zA-Z-_]{3}(=)?))?$/,nanoid:/^[a-zA-Z0-9_-]{21}$/,jwt:/^[A-Za-z0-9-_]+\.[A-Za-z0-9-_]+\.[A-Za-z0-9-_]*$/};function vs(n,e){const t={type:"string"};if(n.checks)for(const r of n.checks)switch(r.kind){case"min":G(t,"minLength",typeof t.minLength=="number"?Math.max(t.minLength,r.value):r.value,r.message,e);break;case"max":G(t,"maxLength",typeof t.maxLength=="number"?Math.min(t.maxLength,r.value):r.value,r.message,e);break;case"email":switch(e.emailStrategy){case"format:email":be(t,"email",r.message,e);break;case"format:idn-email":be(t,"idn-email",r.message,e);break;case"pattern:zod":ne(t,_e.email,r.message,e);break}break;case"url":be(t,"uri",r.message,e);break;case"uuid":be(t,"uuid",r.message,e);break;case"regex":ne(t,r.regex,r.message,e);break;case"cuid":ne(t,_e.cuid,r.message,e);break;case"cuid2":ne(t,_e.cuid2,r.message,e);break;case"startsWith":ne(t,RegExp(`^${Yr(r.value,e)}`),r.message,e);break;case"endsWith":ne(t,RegExp(`${Yr(r.value,e)}$`),r.message,e);break;case"datetime":be(t,"date-time",r.message,e);break;case"date":be(t,"date",r.message,e);break;case"time":be(t,"time",r.message,e);break;case"duration":be(t,"duration",r.message,e);break;case"length":G(t,"minLength",typeof t.minLength=="number"?Math.max(t.minLength,r.value):r.value,r.message,e),G(t,"maxLength",typeof t.maxLength=="number"?Math.min(t.maxLength,r.value):r.value,r.message,e);break;case"includes":{ne(t,RegExp(Yr(r.value,e)),r.message,e);break}case"ip":{r.version!=="v6"&&be(t,"ipv4",r.message,e),r.version!=="v4"&&be(t,"ipv6",r.message,e);break}case"base64url":ne(t,_e.base64url,r.message,e);break;case"jwt":ne(t,_e.jwt,r.message,e);break;case"cidr":{r.version!=="v6"&&ne(t,_e.ipv4Cidr,r.message,e),r.version!=="v4"&&ne(t,_e.ipv6Cidr,r.message,e);break}case"emoji":ne(t,_e.emoji(),r.message,e);break;case"ulid":{ne(t,_e.ulid,r.message,e);break}case"base64":{switch(e.base64Strategy){case"format:binary":{be(t,"binary",r.message,e);break}case"contentEncoding:base64":{G(t,"contentEncoding","base64",r.message,e);break}case"pattern:zod":{ne(t,_e.base64,r.message,e);break}}break}case"nanoid":ne(t,_e.nanoid,r.message,e)}return t}function Yr(n,e){return e.patternStrategy==="escape"?Xd(n):n}const Jd=new Set("ABCDEFGHIJKLMNOPQRSTUVXYZabcdefghijklmnopqrstuvxyz0123456789");function Xd(n){let e="";for(let t=0;t<n.length;t++)Jd.has(n[t])||(e+="\\"),e+=n[t];return e}function be(n,e,t,r){n.format||n.anyOf?.some(a=>a.format)?(n.anyOf||(n.anyOf=[]),n.format&&(n.anyOf.push({format:n.format,...n.errorMessage&&r.errorMessages&&{errorMessage:{format:n.errorMessage.format}}}),delete n.format,n.errorMessage&&(delete n.errorMessage.format,Object.keys(n.errorMessage).length===0&&delete n.errorMessage)),n.anyOf.push({format:e,...t&&r.errorMessages&&{errorMessage:{format:t}}})):G(n,"format",e,t,r)}function ne(n,e,t,r){n.pattern||n.allOf?.some(a=>a.pattern)?(n.allOf||(n.allOf=[]),n.pattern&&(n.allOf.push({pattern:n.pattern,...n.errorMessage&&r.errorMessages&&{errorMessage:{pattern:n.errorMessage.pattern}}}),delete n.pattern,n.errorMessage&&(delete n.errorMessage.pattern,Object.keys(n.errorMessage).length===0&&delete n.errorMessage)),n.allOf.push({pattern:Sa(e,r),...t&&r.errorMessages&&{errorMessage:{pattern:t}}})):G(n,"pattern",Sa(e,r),t,r)}function Sa(n,e){if(!e.applyRegexFlags||!n.flags)return n.source;const t={i:n.flags.includes("i"),m:n.flags.includes("m"),s:n.flags.includes("s")},r=t.i?n.source.toLowerCase():n.source;let a="",s=!1,i=!1,o=!1;for(let u=0;u<r.length;u++){if(s){a+=r[u],s=!1;continue}if(t.i){if(i){if(r[u].match(/[a-z]/)){o?(a+=r[u],a+=`${r[u-2]}-${r[u]}`.toUpperCase(),o=!1):r[u+1]==="-"&&r[u+2]?.match(/[a-z]/)?(a+=r[u],o=!0):a+=`${r[u]}${r[u].toUpperCase()}`;continue}}else if(r[u].match(/[a-z]/)){a+=`[${r[u]}${r[u].toUpperCase()}]`;continue}}if(t.m){if(r[u]==="^"){a+=`(^|(?<=[\r
]))`;continue}else if(r[u]==="$"){a+=`($|(?=[\r
]))`;continue}}if(t.s&&r[u]==="."){a+=i?`${r[u]}\r
`:`[${r[u]}\r
]`;continue}a+=r[u],r[u]==="\\"?s=!0:i&&r[u]==="]"?i=!1:!i&&r[u]==="["&&(i=!0)}try{new RegExp(a)}catch{return console.warn(`Could not convert regex pattern at ${e.currentPath.join("/")} to a flag-independent form! Falling back to the flag-ignorant source`),n.source}return a}function Es(n,e){if(e.target==="openAi"&&console.warn("Warning: OpenAI may not support records in schemas! Try an array of key-value pairs instead."),e.target==="openApi3"&&n.keyType?._def.typeName===y.ZodEnum)return{type:"object",required:n.keyType._def.values,properties:n.keyType._def.values.reduce((r,a)=>({...r,[a]:Z(n.valueType._def,{...e,currentPath:[...e.currentPath,"properties",a]})??{}}),{}),additionalProperties:!1};const t={type:"object",additionalProperties:Z(n.valueType._def,{...e,currentPath:[...e.currentPath,"additionalProperties"]})??{}};if(e.target==="openApi3")return t;if(n.keyType?._def.typeName===y.ZodString&&n.keyType._def.checks?.length){const{type:r,...a}=vs(n.keyType._def,e);return{...t,propertyNames:a}}else{if(n.keyType?._def.typeName===y.ZodEnum)return{...t,propertyNames:{enum:n.keyType._def.values}};if(n.keyType?._def.typeName===y.ZodBranded&&n.keyType._def.type._def.typeName===y.ZodString&&n.keyType._def.type._def.checks?.length){const{type:r,...a}=bs(n.keyType._def,e);return{...t,propertyNames:a}}}return t}function Kd(n,e){if(e.mapStrategy==="record")return Es(n,e);const t=Z(n.keyType._def,{...e,currentPath:[...e.currentPath,"items","items","0"]})||{},r=Z(n.valueType._def,{...e,currentPath:[...e.currentPath,"items","items","1"]})||{};return{type:"array",maxItems:125,items:{type:"array",items:[t,r],minItems:2,maxItems:2}}}function Yd(n){const e=n.values,r=Object.keys(n.values).filter(s=>typeof e[e[s]]!="number").map(s=>e[s]),a=Array.from(new Set(r.map(s=>typeof s)));return{type:a.length===1?a[0]==="string"?"string":"number":["string","number"],enum:r}}function Qd(){return{not:{}}}function eh(n){return n.target==="openApi3"?{enum:["null"],nullable:!0}:{type:"null"}}const _r={ZodString:"string",ZodNumber:"number",ZodBigInt:"integer",ZodBoolean:"boolean",ZodNull:"null"};function th(n,e){if(e.target==="openApi3")return Ta(n,e);const t=n.options instanceof Map?Array.from(n.options.values()):n.options;if(t.every(r=>r._def.typeName in _r&&(!r._def.checks||!r._def.checks.length))){const r=t.reduce((a,s)=>{const i=_r[s._def.typeName];return i&&!a.includes(i)?[...a,i]:a},[]);return{type:r.length>1?r:r[0]}}else if(t.every(r=>r._def.typeName==="ZodLiteral"&&!r.description)){const r=t.reduce((a,s)=>{const i=typeof s._def.value;switch(i){case"string":case"number":case"boolean":return[...a,i];case"bigint":return[...a,"integer"];case"object":if(s._def.value===null)return[...a,"null"];case"symbol":case"undefined":case"function":default:return a}},[]);if(r.length===t.length){const a=r.filter((s,i,o)=>o.indexOf(s)===i);return{type:a.length>1?a:a[0],enum:t.reduce((s,i)=>s.includes(i._def.value)?s:[...s,i._def.value],[])}}}else if(t.every(r=>r._def.typeName==="ZodEnum"))return{type:"string",enum:t.reduce((r,a)=>[...r,...a._def.values.filter(s=>!r.includes(s))],[])};return Ta(n,e)}const Ta=(n,e)=>{const t=(n.options instanceof Map?Array.from(n.options.values()):n.options).map((r,a)=>Z(r._def,{...e,currentPath:[...e.currentPath,"anyOf",`${a}`]})).filter(r=>!!r&&(!e.strictUnions||typeof r=="object"&&Object.keys(r).length>0));return t.length?{anyOf:t}:void 0};function rh(n,e){if(["ZodString","ZodNumber","ZodBigInt","ZodBoolean","ZodNull"].includes(n.innerType._def.typeName)&&(!n.innerType._def.checks||!n.innerType._def.checks.length))return e.target==="openApi3"?{type:_r[n.innerType._def.typeName],nullable:!0}:{type:[_r[n.innerType._def.typeName],"null"]};if(e.target==="openApi3"){const r=Z(n.innerType._def,{...e,currentPath:[...e.currentPath]});return r&&"$ref"in r?{allOf:[r],nullable:!0}:r&&{...r,nullable:!0}}const t=Z(n.innerType._def,{...e,currentPath:[...e.currentPath,"anyOf","0"]});return t&&{anyOf:[t,{type:"null"}]}}function nh(n,e){const t={type:"number"};if(!n.checks)return t;for(const r of n.checks)switch(r.kind){case"int":t.type="integer",_s(t,"type",r.message,e);break;case"min":e.target==="jsonSchema7"?r.inclusive?G(t,"minimum",r.value,r.message,e):G(t,"exclusiveMinimum",r.value,r.message,e):(r.inclusive||(t.exclusiveMinimum=!0),G(t,"minimum",r.value,r.message,e));break;case"max":e.target==="jsonSchema7"?r.inclusive?G(t,"maximum",r.value,r.message,e):G(t,"exclusiveMaximum",r.value,r.message,e):(r.inclusive||(t.exclusiveMaximum=!0),G(t,"maximum",r.value,r.message,e));break;case"multipleOf":G(t,"multipleOf",r.value,r.message,e);break}return t}function ah(n,e){return e.removeAdditionalStrategy==="strict"?n.catchall._def.typeName==="ZodNever"?n.unknownKeys!=="strict":Z(n.catchall._def,{...e,currentPath:[...e.currentPath,"additionalProperties"]})??!0:n.catchall._def.typeName==="ZodNever"?n.unknownKeys==="passthrough":Z(n.catchall._def,{...e,currentPath:[...e.currentPath,"additionalProperties"]})??!0}function sh(n,e){const t=e.target==="openAi",r={type:"object",...Object.entries(n.shape()).reduce((a,[s,i])=>{if(i===void 0||i._def===void 0)return a;let o=i.isOptional();o&&t&&(i instanceof Oe&&(i=i._def.innerType),i.isNullable()||(i=i.nullable()),o=!1);const u=Z(i._def,{...e,currentPath:[...e.currentPath,"properties",s],propertyPath:[...e.currentPath,"properties",s]});return u===void 0?a:{properties:{...a.properties,[s]:u},required:o?a.required:[...a.required,s]}},{properties:{},required:[]}),additionalProperties:ah(n,e)};return r.required.length||delete r.required,r}const ih=(n,e)=>{if(e.currentPath.toString()===e.propertyPath?.toString())return Z(n.innerType._def,e);const t=Z(n.innerType._def,{...e,currentPath:[...e.currentPath,"anyOf","1"]});return t?{anyOf:[{not:{}},t]}:{}},oh=(n,e)=>{if(e.pipeStrategy==="input")return Z(n.in._def,e);if(e.pipeStrategy==="output")return Z(n.out._def,e);const t=Z(n.in._def,{...e,currentPath:[...e.currentPath,"allOf","0"]}),r=Z(n.out._def,{...e,currentPath:[...e.currentPath,"allOf",t?"1":"0"]});return{allOf:[t,r].filter(a=>a!==void 0)}};function uh(n,e){return Z(n.type._def,e)}function ch(n,e){const r={type:"array",uniqueItems:!0,items:Z(n.valueType._def,{...e,currentPath:[...e.currentPath,"items"]})};return n.minSize&&G(r,"minItems",n.minSize.value,n.minSize.message,e),n.maxSize&&G(r,"maxItems",n.maxSize.value,n.maxSize.message,e),r}function lh(n,e){return n.rest?{type:"array",minItems:n.items.length,items:n.items.map((t,r)=>Z(t._def,{...e,currentPath:[...e.currentPath,"items",`${r}`]})).reduce((t,r)=>r===void 0?t:[...t,r],[]),additionalItems:Z(n.rest._def,{...e,currentPath:[...e.currentPath,"additionalItems"]})}:{type:"array",minItems:n.items.length,maxItems:n.items.length,items:n.items.map((t,r)=>Z(t._def,{...e,currentPath:[...e.currentPath,"items",`${r}`]})).reduce((t,r)=>r===void 0?t:[...t,r],[])}}function dh(){return{not:{}}}function hh(){return{}}const fh=(n,e)=>Z(n.innerType._def,e);function Z(n,e,t=!1){const r=e.seen.get(n);if(e.override){const i=e.override?.(n,e,r,t);if(i!==Nd)return i}if(r&&!t){const i=ph(r,e);if(i!==void 0)return i}const a={def:n,path:e.currentPath,jsonSchema:void 0};e.seen.set(n,a);const s=gh(n,n.typeName,e);return s&&yh(n,e,s),a.jsonSchema=s,s}const ph=(n,e)=>{switch(e.$refStrategy){case"root":return{$ref:n.path.join("/")};case"relative":return{$ref:mh(e.currentPath,n.path)};case"none":case"seen":return n.path.length<e.currentPath.length&&n.path.every((t,r)=>e.currentPath[r]===t)?(console.warn(`Recursive reference detected at ${e.currentPath.join("/")}! Defaulting to any`),{}):e.$refStrategy==="seen"?{}:void 0}},mh=(n,e)=>{let t=0;for(;t<n.length&&t<e.length&&n[t]===e[t];t++);return[(n.length-t).toString(),...e.slice(t)].join("/")},gh=(n,e,t)=>{switch(e){case y.ZodString:return vs(n,t);case y.ZodNumber:return nh(n,t);case y.ZodObject:return sh(n,t);case y.ZodBigInt:return Fd(n,t);case y.ZodBoolean:return Ud();case y.ZodDate:return ws(n,t);case y.ZodUndefined:return dh();case y.ZodNull:return eh(t);case y.ZodArray:return Dd(n,t);case y.ZodUnion:case y.ZodDiscriminatedUnion:return th(n,t);case y.ZodIntersection:return qd(n,t);case y.ZodTuple:return lh(n,t);case y.ZodRecord:return Es(n,t);case y.ZodLiteral:return Wd(n,t);case y.ZodEnum:return zd(n);case y.ZodNativeEnum:return Yd(n);case y.ZodNullable:return rh(n,t);case y.ZodOptional:return ih(n,t);case y.ZodMap:return Kd(n,t);case y.ZodSet:return ch(n,t);case y.ZodLazy:return Z(n.getter()._def,t);case y.ZodPromise:return uh(n,t);case y.ZodNaN:case y.ZodNever:return Qd();case y.ZodEffects:return Gd(n,t);case y.ZodAny:return Md();case y.ZodUnknown:return hh();case y.ZodDefault:return Hd(n,t);case y.ZodBranded:return bs(n,t);case y.ZodReadonly:return fh(n,t);case y.ZodCatch:return Bd(n,t);case y.ZodPipeline:return oh(n,t);case y.ZodFunction:case y.ZodVoid:case y.ZodSymbol:return;default:return(r=>{})()}},yh=(n,e,t)=>(n.description&&(t.description=n.description,e.markdownDescription&&(t.markdownDescription=n.description)),t),_h=(n,e)=>{const t=Ld(e),r=typeof e=="object"&&e.definitions?Object.entries(e.definitions).reduce((u,[c,l])=>({...u,[c]:Z(l._def,{...t,currentPath:[...t.basePath,t.definitionPath,c]},!0)??{}}),{}):void 0,a=typeof e=="string"?e:e?.nameStrategy==="title"?void 0:e?.name,s=Z(n._def,a===void 0?t:{...t,currentPath:[...t.basePath,t.definitionPath,a]},!1)??{},i=typeof e=="object"&&e.name!==void 0&&e.nameStrategy==="title"?e.name:void 0;i!==void 0&&(s.title=i);const o=a===void 0?r?{...s,[t.definitionPath]:r}:s:{$ref:[...t.$refStrategy==="relative"?[]:t.basePath,t.definitionPath,a].join("/"),[t.definitionPath]:{...r,[a]:s}};return t.target==="jsonSchema7"?o.$schema="http://json-schema.org/draft-07/schema#":(t.target==="jsonSchema2019-09"||t.target==="openAi")&&(o.$schema="https://json-schema.org/draft/2019-09/schema#"),t.target==="openAi"&&("anyOf"in o||"oneOf"in o||"allOf"in o||"type"in o&&Array.isArray(o.type))&&console.warn("Warning: OpenAI may not support schemas with unions as roots! Try wrapping it in an object property."),o};function Qr(n){return n.replace(/[^a-zA-Z-_0-9]/g,"_")}const bh=["*","_","`"];function wh(n){let e="";for(const[t,r]of Object.entries(n))e+=`	classDef ${t} ${r};
`;return e}function vh(n,e,t){const{firstNode:r,lastNode:a,nodeColors:s,withStyles:i=!0,curveStyle:o="linear",wrapLabelNWords:u=9}=t??{};let c=i?`%%{init: {'flowchart': {'curve': '${o}'}}}%%
graph TD;
`:`graph TD;
`;if(i){const f="default",p={[f]:"{0}({1})"};r!==void 0&&(p[r]="{0}([{1}]):::first"),a!==void 0&&(p[a]="{0}([{1}]):::last");for(const[S,m]of Object.entries(n)){const _=m.name.split(":").pop()??"";let b=bh.some(A=>_.startsWith(A)&&_.endsWith(A))?`<p>${_}</p>`:_;Object.keys(m.metadata??{}).length&&(b+=`<hr/><small><em>${Object.entries(m.metadata??{}).map(([A,H])=>`${A} = ${H}`).join(`
`)}</em></small>`);const U=(p[S]??p[f]).replace("{0}",Qr(S)).replace("{1}",b);c+=`	${U}
`}}const l={};for(const f of e){const p=f.source.split(":"),S=f.target.split(":"),m=p.filter((_,P)=>_===S[P]).join(":");l[m]||(l[m]=[]),l[m].push(f)}const d=new Set;function h(f,p){const S=f.length===1&&f[0].source===f[0].target;if(p&&!S){const m=p.split(":").pop();if(d.has(m))throw new Error(`Found duplicate subgraph '${m}' -- this likely means that you're reusing a subgraph node with the same name. Please adjust your graph to have subgraph nodes with unique names.`);d.add(m),c+=`	subgraph ${m}
`}for(const m of f){const{source:_,target:P,data:b,conditional:U}=m;let A="";if(b!==void 0){let H=b;const q=H.split(" ");q.length>u&&(H=Array.from({length:Math.ceil(q.length/u)},(pe,nt)=>q.slice(nt*u,(nt+1)*u).join(" ")).join("&nbsp;<br>&nbsp;")),A=U?` -. &nbsp;${H}&nbsp; .-> `:` -- &nbsp;${H}&nbsp; --> `}else A=U?" -.-> ":" --> ";c+=`	${Qr(_)}${A}${Qr(P)};
`}for(const m in l)m.startsWith(`${p}:`)&&m!==p&&h(l[m],m);p&&!S&&(c+=`	end
`)}h(l[""]??[],"");for(const f in l)!f.includes(":")&&f!==""&&h(l[f],f);return i&&(c+=wh(s??{})),c}async function Eh(n,e){let{backgroundColor:t="white"}=e??{};const r=btoa(n);t!==void 0&&(/^#(?:[0-9a-fA-F]{3}){1,2}$/.test(t)||(t=`!${t}`));const a=`https://mermaid.ink/img/${r}?bgColor=${t}`,s=await fetch(a);if(!s.ok)throw new Error(["Failed to render the graph using the Mermaid.INK API.",`Status code: ${s.status}`,`Status text: ${s.statusText}`].join(`
`));return await s.blob()}function Oh(n,e){if(n!==void 0&&!St(n))return n;if(Cn(e))try{let t=e.getName();return t=t.startsWith("Runnable")?t.slice(8):t,t}catch{return e.getName()}else return e.name??"UnknownSchema"}function Sh(n){return Cn(n.data)?{type:"runnable",data:{id:n.data.lc_id,name:n.data.getName()}}:{type:"schema",data:{..._h(n.data.schema),title:n.data.name}}}class Rr{constructor(e){Object.defineProperty(this,"nodes",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"edges",{enumerable:!0,configurable:!0,writable:!0,value:[]}),this.nodes=e?.nodes??this.nodes,this.edges=e?.edges??this.edges}toJSON(){const e={};return Object.values(this.nodes).forEach((t,r)=>{e[t.id]=St(t.id)?r:t.id}),{nodes:Object.values(this.nodes).map(t=>({id:e[t.id],...Sh(t)})),edges:this.edges.map(t=>{const r={source:e[t.source],target:e[t.target]};return typeof t.data<"u"&&(r.data=t.data),typeof t.conditional<"u"&&(r.conditional=t.conditional),r})}}addNode(e,t,r){if(t!==void 0&&this.nodes[t]!==void 0)throw new Error(`Node with id ${t} already exists`);const a=t??ue(),s={id:a,data:e,name:Oh(t,e),metadata:r};return this.nodes[a]=s,s}removeNode(e){delete this.nodes[e.id],this.edges=this.edges.filter(t=>t.source!==e.id&&t.target!==e.id)}addEdge(e,t,r,a){if(this.nodes[e.id]===void 0)throw new Error(`Source node ${e.id} not in graph`);if(this.nodes[t.id]===void 0)throw new Error(`Target node ${t.id} not in graph`);const s={source:e.id,target:t.id,data:r,conditional:a};return this.edges.push(s),s}firstNode(){return ka(this)}lastNode(){return Ia(this)}extend(e,t=""){let r=t;Object.values(e.nodes).map(c=>c.id).every(St)&&(r="");const s=c=>r?`${r}:${c}`:c;Object.entries(e.nodes).forEach(([c,l])=>{this.nodes[s(c)]={...l,id:s(c)}});const i=e.edges.map(c=>({...c,source:s(c.source),target:s(c.target)}));this.edges=[...this.edges,...i];const o=e.firstNode(),u=e.lastNode();return[o?{id:s(o.id),data:o.data}:void 0,u?{id:s(u.id),data:u.data}:void 0]}trimFirstNode(){const e=this.firstNode();e&&ka(this,[e.id])&&this.removeNode(e)}trimLastNode(){const e=this.lastNode();e&&Ia(this,[e.id])&&this.removeNode(e)}reid(){const e=Object.fromEntries(Object.values(this.nodes).map(a=>[a.id,a.name])),t=new Map;Object.values(e).forEach(a=>{t.set(a,(t.get(a)||0)+1)});const r=a=>{const s=e[a];return St(a)&&t.get(s)===1?s:a};return new Rr({nodes:Object.fromEntries(Object.entries(this.nodes).map(([a,s])=>[r(a),{...s,id:r(a)}])),edges:this.edges.map(a=>({...a,source:r(a.source),target:r(a.target)}))})}drawMermaid(e){const{withStyles:t,curveStyle:r,nodeColors:a={default:"fill:#f2f0ff,line-height:1.2",first:"fill-opacity:0",last:"fill:#bfb6fc"},wrapLabelNWords:s}=e??{},i=this.reid(),o=i.firstNode(),u=i.lastNode();return vh(i.nodes,i.edges,{firstNode:o?.id,lastNode:u?.id,withStyles:t,curveStyle:r,nodeColors:a,wrapLabelNWords:s})}async drawMermaidPng(e){const t=this.drawMermaid(e);return Eh(t,{backgroundColor:e?.backgroundColor})}}function ka(n,e=[]){const t=new Set(n.edges.filter(a=>!e.includes(a.source)).map(a=>a.target)),r=[];for(const a of Object.values(n.nodes))!e.includes(a.id)&&!t.has(a.id)&&r.push(a);return r.length===1?r[0]:void 0}function Ia(n,e=[]){const t=new Set(n.edges.filter(a=>!e.includes(a.target)).map(a=>a.source)),r=[];for(const a of Object.values(n.nodes))!e.includes(a.id)&&!t.has(a.id)&&r.push(a);return r.length===1?r[0]:void 0}function Th(n){const e=new TextEncoder,t=new ReadableStream({async start(r){for await(const a of n)r.enqueue(e.encode(`event: data
data: ${JSON.stringify(a)}

`));r.enqueue(e.encode(`event: end

`)),r.close()}});return fe.fromReadableStream(t)}function $a(n){return typeof n=="object"&&n!==null&&typeof n[Symbol.iterator]=="function"&&typeof n.next=="function"}const kh=n=>n!=null&&typeof n=="object"&&"next"in n&&typeof n.next=="function";function fn(n){return typeof n=="object"&&n!==null&&typeof n[Symbol.asyncIterator]=="function"}function*Aa(n,e){for(;;){const{value:t,done:r}=qe.runWithConfig(gt(n),e.next.bind(e),!0);if(r)break;yield t}}async function*pn(n,e){const t=e[Symbol.asyncIterator]();for(;;){const{value:r,done:a}=await qe.runWithConfig(gt(n),t.next.bind(e),!0);if(a)break;yield r}}function Q(n,e){return n&&!Array.isArray(n)&&!(n instanceof Date)&&typeof n=="object"?n:{[e]:n}}class ae extends mt{constructor(){super(...arguments),Object.defineProperty(this,"lc_runnable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:void 0})}getName(e){const t=this.name??this.constructor.lc_name()??this.constructor.name;return e?`${t}${e}`:t}bind(e){return new Qe({bound:this,kwargs:e,config:{}})}map(){return new br({bound:this})}withRetry(e){return new Ih({bound:this,kwargs:{},config:{},maxAttemptNumber:e?.stopAfterAttempt,...e})}withConfig(e){return new Qe({bound:this,config:e,kwargs:{}})}withFallbacks(e){const t=Array.isArray(e)?e:e.fallbacks;return new Ah({runnable:this,fallbacks:t})}_getOptionsList(e,t=0){if(Array.isArray(e)&&e.length!==t)throw new Error(`Passed "options" must be an array with the same length as the inputs, but got ${e.length} options for ${t} inputs`);if(Array.isArray(e))return e.map(V);if(t>1&&!Array.isArray(e)&&e.runId){console.warn("Provided runId will be used only for the first element of the batch.");const r=Object.fromEntries(Object.entries(e).filter(([a])=>a!=="runId"));return Array.from({length:t},(a,s)=>V(s===0?e:r))}return Array.from({length:t},()=>V(e))}async batch(e,t,r){const a=this._getOptionsList(t??{},e.length),s=a[0]?.maxConcurrency??r?.maxConcurrency,i=new Cd({maxConcurrency:s,onFailedAttempt:u=>{throw u}}),o=e.map((u,c)=>i.call(async()=>{try{return await this.invoke(u,a[c])}catch(l){if(r?.returnExceptions)return l;throw l}}));return Promise.all(o)}async*_streamIterator(e,t){yield this.invoke(e,t)}async stream(e,t){const r=V(t),a=new _t({generator:this._streamIterator(e,r),config:r});return await a.setup,fe.fromAsyncGenerator(a)}_separateRunnableConfigFromCallOptions(e){let t;e===void 0?t=V(e):t=V({callbacks:e.callbacks,tags:e.tags,metadata:e.metadata,runName:e.runName,configurable:e.configurable,recursionLimit:e.recursionLimit,maxConcurrency:e.maxConcurrency,runId:e.runId,timeout:e.timeout,signal:e.signal});const r={...e};return delete r.callbacks,delete r.tags,delete r.metadata,delete r.runName,delete r.configurable,delete r.recursionLimit,delete r.maxConcurrency,delete r.runId,delete r.timeout,delete r.signal,[t,r]}async _callWithConfig(e,t,r){const a=V(r),i=await(await Se(a))?.handleChainStart(this.toJSON(),Q(t,"input"),a.runId,a?.runType,void 0,void 0,a?.runName??this.getName());delete a.runId;let o;try{const u=e.call(this,t,a,i);o=await We(u,r?.signal)}catch(u){throw await i?.handleChainError(u),u}return await i?.handleChainEnd(Q(o,"output")),o}async _batchWithConfig(e,t,r,a){const s=this._getOptionsList(r??{},t.length),i=await Promise.all(s.map(Se)),o=await Promise.all(i.map(async(c,l)=>{const d=await c?.handleChainStart(this.toJSON(),Q(t[l],"input"),s[l].runId,s[l].runType,void 0,void 0,s[l].runName??this.getName());return delete s[l].runId,d}));let u;try{const c=e.call(this,t,s,o,a);u=await We(c,s?.[0]?.signal)}catch(c){throw await Promise.all(o.map(l=>l?.handleChainError(c))),c}return await Promise.all(o.map(c=>c?.handleChainEnd(Q(u,"output")))),u}async*_transformStreamWithConfig(e,t,r){let a,s=!0,i,o=!0;const u=V(r),c=await Se(u);async function*l(){for await(const h of e){if(s)if(a===void 0)a=h;else try{a=Le(a,h)}catch{a=void 0,s=!1}yield h}}let d;try{const h=await Td(t.bind(this),l(),async()=>c?.handleChainStart(this.toJSON(),{input:""},u.runId,u.runType,void 0,void 0,u.runName??this.getName()),r?.signal,u);delete u.runId,d=h.setup;const f=d?.handlers.find($d);let p=h.output;f!==void 0&&d!==void 0&&(p=f.tapOutputIterable(d.runId,p));const S=d?.handlers.find(kd);S!==void 0&&d!==void 0&&(p=S.tapOutputIterable(d.runId,p));for await(const m of p)if(yield m,o)if(i===void 0)i=m;else try{i=Le(i,m)}catch{i=void 0,o=!1}}catch(h){throw await d?.handleChainError(h,void 0,void 0,void 0,{inputs:Q(a,"input")}),h}await d?.handleChainEnd(i??{},void 0,void 0,void 0,{inputs:Q(a,"input")})}getGraph(e){const t=new Rr,r=t.addNode({name:`${this.getName()}Input`,schema:Tt.any()}),a=t.addNode(this),s=t.addNode({name:`${this.getName()}Output`,schema:Tt.any()});return t.addEdge(r,a),t.addEdge(a,s),t}pipe(e){return new Xe({first:this,last:Ke(e)})}pick(e){return this.pipe(new xh(e))}assign(e){return this.pipe(new Rh(new Jt({steps:e})))}async*transform(e,t){let r;for await(const a of e)r===void 0?r=a:r=Le(r,a);yield*this._streamIterator(r,V(t))}async*streamLog(e,t,r){const a=new Ea({...r,autoClose:!1,_schemaFormat:"original"}),s=V(t);yield*this._streamLog(e,a,s)}async*_streamLog(e,t,r){const{callbacks:a}=r;if(a===void 0)r.callbacks=[t];else if(Array.isArray(a))r.callbacks=a.concat([t]);else{const u=a.copy();u.addHandler(t,!0),r.callbacks=u}const s=this.stream(e,r);async function i(){try{const u=await s;for await(const c of u){const l=new Ue({ops:[{op:"add",path:"/streamed_output/-",value:c}]});await t.writer.write(l)}}finally{await t.writer.close()}}const o=i();try{for await(const u of t)yield u}finally{await o}}streamEvents(e,t,r){let a;if(t.version==="v1")a=this._streamEventsV1(e,t,r);else if(t.version==="v2")a=this._streamEventsV2(e,t,r);else throw new Error('Only versions "v1" and "v2" of the schema are currently supported.');return t.encoding==="text/event-stream"?Th(a):fe.fromAsyncGenerator(a)}async*_streamEventsV2(e,t,r){const a=new Ad({...r,autoClose:!1}),s=V(t),i=s.runId??ue();s.runId=i;const o=s.callbacks;if(o===void 0)s.callbacks=[a];else if(Array.isArray(o))s.callbacks=o.concat(a);else{const f=o.copy();f.addHandler(a,!0),s.callbacks=f}const u=this;async function c(){try{const f=await u.stream(e,s),p=a.tapOutputIterable(i,f);for await(const S of p);}finally{await a.finish()}}const l=c();let d=!1,h;try{for await(const f of a){if(!d){f.data.input=e,d=!0,h=f.run_id,yield f;continue}f.run_id===h&&f.event.endsWith("_end")&&f.data?.input&&delete f.data.input,yield f}}finally{await l}}async*_streamEventsV1(e,t,r){let a,s=!1;const i=V(t),o=i.tags??[],u=i.metadata??{},c=i.runName??this.getName(),l=new Ea({...r,autoClose:!1,_schemaFormat:"streaming_events"}),d=new Pd({...r}),h=this._streamLog(e,l,i);for await(const p of h){if(a?a=a.concat(p):a=Gt.fromRunLogPatch(p),a.state===void 0)throw new Error('Internal error: "streamEvents" state is missing. Please open a bug report.');if(!s){s=!0;const P={...a.state},b={run_id:P.id,event:`on_${P.type}_start`,name:c,tags:o,metadata:u,data:{input:e}};d.includeEvent(b,P.type)&&(yield b)}const S=p.ops.filter(P=>P.path.startsWith("/logs/")).map(P=>P.path.split("/")[2]),m=[...new Set(S)];for(const P of m){let b,U={};const A=a.state.logs[P];if(A.end_time===void 0?A.streamed_output.length>0?b="stream":b="start":b="end",b==="start")A.inputs!==void 0&&(U.input=A.inputs);else if(b==="end")A.inputs!==void 0&&(U.input=A.inputs),U.output=A.final_output;else if(b==="stream"){const H=A.streamed_output.length;if(H!==1)throw new Error(`Expected exactly one chunk of streamed output, got ${H} instead. Encountered in: "${A.name}"`);U={chunk:A.streamed_output[0]},A.streamed_output=[]}yield{event:`on_${A.type}_${b}`,name:A.name,run_id:A.id,tags:A.tags,metadata:A.metadata,data:U}}const{state:_}=a;if(_.streamed_output.length>0){const P=_.streamed_output.length;if(P!==1)throw new Error(`Expected exactly one chunk of streamed output, got ${P} instead. Encountered in: "${_.name}"`);const b={chunk:_.streamed_output[0]};_.streamed_output=[];const U={event:`on_${_.type}_stream`,run_id:_.id,tags:o,metadata:u,name:c,data:b};d.includeEvent(U,_.type)&&(yield U)}}const f=a?.state;if(f!==void 0){const p={event:`on_${f.type}_end`,name:c,run_id:f.id,tags:o,metadata:u,data:{output:f.final_output}};d.includeEvent(p,f.type)&&(yield p)}}static isRunnable(e){return Cn(e)}withListeners({onStart:e,onEnd:t,onError:r}){return new Qe({bound:this,config:{},configFactories:[a=>({callbacks:[new ys({config:a,onStart:e,onEnd:t,onError:r})]})]})}asTool(e){return Ch(this,e)}}class Qe extends ae{static lc_name(){return"RunnableBinding"}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"bound",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"config",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"kwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"configFactories",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.bound=e.bound,this.kwargs=e.kwargs,this.config=e.config,this.configFactories=e.configFactories}getName(e){return this.bound.getName(e)}async _mergeConfig(...e){const t=ba(this.config,...e);return ba(t,...this.configFactories?await Promise.all(this.configFactories.map(async r=>await r(t))):[])}bind(e){return new this.constructor({bound:this.bound,kwargs:{...this.kwargs,...e},config:this.config})}withConfig(e){return new this.constructor({bound:this.bound,kwargs:this.kwargs,config:{...this.config,...e}})}withRetry(e){return new this.constructor({bound:this.bound.withRetry(e),kwargs:this.kwargs,config:this.config})}async invoke(e,t){return this.bound.invoke(e,await this._mergeConfig(V(t),this.kwargs))}async batch(e,t,r){const a=Array.isArray(t)?await Promise.all(t.map(async s=>this._mergeConfig(V(s),this.kwargs))):await this._mergeConfig(V(t),this.kwargs);return this.bound.batch(e,a,r)}async*_streamIterator(e,t){yield*this.bound._streamIterator(e,await this._mergeConfig(V(t),this.kwargs))}async stream(e,t){return this.bound.stream(e,await this._mergeConfig(V(t),this.kwargs))}async*transform(e,t){yield*this.bound.transform(e,await this._mergeConfig(V(t),this.kwargs))}streamEvents(e,t,r){const a=this,s=async function*(){yield*a.bound.streamEvents(e,{...await a._mergeConfig(V(t),a.kwargs),version:t.version},r)};return fe.fromAsyncGenerator(s())}static isRunnableBinding(e){return e.bound&&ae.isRunnable(e.bound)}withListeners({onStart:e,onEnd:t,onError:r}){return new Qe({bound:this.bound,kwargs:this.kwargs,config:this.config,configFactories:[a=>({callbacks:[new ys({config:a,onStart:e,onEnd:t,onError:r})]})]})}}class br extends ae{static lc_name(){return"RunnableEach"}constructor(e){super(e),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"bound",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.bound=e.bound}bind(e){return new br({bound:this.bound.bind(e)})}async invoke(e,t){return this._callWithConfig(this._invoke.bind(this),e,t)}async _invoke(e,t,r){return this.bound.batch(e,ee(t,{callbacks:r?.getChild()}))}withListeners({onStart:e,onEnd:t,onError:r}){return new br({bound:this.bound.withListeners({onStart:e,onEnd:t,onError:r})})}}class Ih extends Qe{static lc_name(){return"RunnableRetry"}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"maxAttemptNumber",{enumerable:!0,configurable:!0,writable:!0,value:3}),Object.defineProperty(this,"onFailedAttempt",{enumerable:!0,configurable:!0,writable:!0,value:()=>{}}),this.maxAttemptNumber=e.maxAttemptNumber??this.maxAttemptNumber,this.onFailedAttempt=e.onFailedAttempt??this.onFailedAttempt}_patchConfigForRetry(e,t,r){const a=e>1?`retry:attempt:${e}`:void 0;return ee(t,{callbacks:r?.getChild(a)})}async _invoke(e,t,r){return lr(a=>super.invoke(e,this._patchConfigForRetry(a,t,r)),{onFailedAttempt:a=>this.onFailedAttempt(a,e),retries:Math.max(this.maxAttemptNumber-1,0),randomize:!0})}async invoke(e,t){return this._callWithConfig(this._invoke.bind(this),e,t)}async _batch(e,t,r,a){const s={};try{await lr(async i=>{const o=e.map((h,f)=>f).filter(h=>s[h.toString()]===void 0||s[h.toString()]instanceof Error),u=o.map(h=>e[h]),c=o.map(h=>this._patchConfigForRetry(i,t?.[h],r?.[h])),l=await super.batch(u,c,{...a,returnExceptions:!0});let d;for(let h=0;h<l.length;h+=1){const f=l[h],p=o[h];f instanceof Error&&d===void 0&&(d=f,d.input=u[h]),s[p.toString()]=f}if(d)throw d;return l},{onFailedAttempt:i=>this.onFailedAttempt(i,i.input),retries:Math.max(this.maxAttemptNumber-1,0),randomize:!0})}catch(i){if(a?.returnExceptions!==!0)throw i}return Object.keys(s).sort((i,o)=>parseInt(i,10)-parseInt(o,10)).map(i=>s[parseInt(i,10)])}async batch(e,t,r){return this._batchWithConfig(this._batch.bind(this),e,t,r)}}class Xe extends ae{static lc_name(){return"RunnableSequence"}constructor(e){super(e),Object.defineProperty(this,"first",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"middle",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"last",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"omitSequenceTags",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),this.first=e.first,this.middle=e.middle??this.middle,this.last=e.last,this.name=e.name,this.omitSequenceTags=e.omitSequenceTags??this.omitSequenceTags}get steps(){return[this.first,...this.middle,this.last]}async invoke(e,t){const r=V(t),s=await(await Se(r))?.handleChainStart(this.toJSON(),Q(e,"input"),r.runId,void 0,void 0,void 0,r?.runName);delete r.runId;let i=e,o;try{const u=[this.first,...this.middle];for(let c=0;c<u.length;c+=1){const d=u[c].invoke(i,ee(r,{callbacks:s?.getChild(this.omitSequenceTags?void 0:`seq:step:${c+1}`)}));i=await We(d,t?.signal)}if(t?.signal?.aborted)throw new Error("Aborted");o=await this.last.invoke(i,ee(r,{callbacks:s?.getChild(this.omitSequenceTags?void 0:`seq:step:${this.steps.length}`)}))}catch(u){throw await s?.handleChainError(u),u}return await s?.handleChainEnd(Q(o,"output")),o}async batch(e,t,r){const a=this._getOptionsList(t??{},e.length),s=await Promise.all(a.map(Se)),i=await Promise.all(s.map(async(u,c)=>{const l=await u?.handleChainStart(this.toJSON(),Q(e[c],"input"),a[c].runId,void 0,void 0,void 0,a[c].runName);return delete a[c].runId,l}));let o=e;try{for(let u=0;u<this.steps.length;u+=1){const l=this.steps[u].batch(o,i.map((d,h)=>{const f=d?.getChild(this.omitSequenceTags?void 0:`seq:step:${u+1}`);return ee(a[h],{callbacks:f})}),r);o=await We(l,a[0]?.signal)}}catch(u){throw await Promise.all(i.map(c=>c?.handleChainError(u))),u}return await Promise.all(i.map(u=>u?.handleChainEnd(Q(o,"output")))),o}async*_streamIterator(e,t){const r=await Se(t),{runId:a,...s}=t??{},i=await r?.handleChainStart(this.toJSON(),Q(e,"input"),a,void 0,void 0,void 0,s?.runName),o=[this.first,...this.middle,this.last];let u=!0,c;async function*l(){yield e}try{let d=o[0].transform(l(),ee(s,{callbacks:i?.getChild(this.omitSequenceTags?void 0:"seq:step:1")}));for(let h=1;h<o.length;h+=1)d=await o[h].transform(d,ee(s,{callbacks:i?.getChild(this.omitSequenceTags?void 0:`seq:step:${h+1}`)}));for await(const h of d)if(t?.signal?.throwIfAborted(),yield h,u)if(c===void 0)c=h;else try{c=Le(c,h)}catch{c=void 0,u=!1}}catch(d){throw await i?.handleChainError(d),d}await i?.handleChainEnd(Q(c,"output"))}getGraph(e){const t=new Rr;let r=null;return this.steps.forEach((a,s)=>{const i=a.getGraph(e);s!==0&&i.trimFirstNode(),s!==this.steps.length-1&&i.trimLastNode(),t.extend(i);const o=i.firstNode();if(!o)throw new Error(`Runnable ${a} has no first node`);r&&t.addEdge(r,o),r=i.lastNode()}),t}pipe(e){return Xe.isRunnableSequence(e)?new Xe({first:this.first,middle:this.middle.concat([this.last,e.first,...e.middle]),last:e.last,name:this.name??e.name}):new Xe({first:this.first,middle:[...this.middle,this.last],last:Ke(e),name:this.name})}static isRunnableSequence(e){return Array.isArray(e.middle)&&ae.isRunnable(e)}static from([e,...t],r){let a={};return typeof r=="string"?a.name=r:r!==void 0&&(a=r),new Xe({...a,first:Ke(e),middle:t.slice(0,-1).map(Ke),last:Ke(t[t.length-1])})}}class Jt extends ae{static lc_name(){return"RunnableMap"}getStepsKeys(){return Object.keys(this.steps)}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"steps",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.steps={};for(const[t,r]of Object.entries(e.steps))this.steps[t]=Ke(r)}static from(e){return new Jt({steps:e})}async invoke(e,t){const r=V(t),s=await(await Se(r))?.handleChainStart(this.toJSON(),{input:e},r.runId,void 0,void 0,void 0,r?.runName);delete r.runId;const i={};try{const o=Object.entries(this.steps).map(async([u,c])=>{i[u]=await c.invoke(e,ee(r,{callbacks:s?.getChild(`map:key:${u}`)}))});await We(Promise.all(o),t?.signal)}catch(o){throw await s?.handleChainError(o),o}return await s?.handleChainEnd(i),i}async*_transform(e,t,r){const a={...this.steps},s=gs(e,Object.keys(a).length),i=new Map(Object.entries(a).map(([o,u],c)=>{const l=u.transform(s[c],ee(r,{callbacks:t?.getChild(`map:key:${o}`)}));return[o,l.next().then(d=>({key:o,gen:l,result:d}))]}));for(;i.size;){const o=Promise.race(i.values()),{key:u,result:c,gen:l}=await We(o,r?.signal);i.delete(u),c.done||(yield{[u]:c.value},i.set(u,l.next().then(d=>({key:u,gen:l,result:d}))))}}transform(e,t){return this._transformStreamWithConfig(e,this._transform.bind(this),t)}async stream(e,t){async function*r(){yield e}const a=V(t),s=new _t({generator:this.transform(r(),a),config:a});return await s.setup,fe.fromAsyncGenerator(s)}}class Pn extends ae{constructor(e){if(super(e),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"func",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),!$n(e.func))throw new Error("RunnableTraceable requires a function that is wrapped in traceable higher-order function");this.func=e.func}async invoke(e,t){const[r]=this._getOptionsList(t??{},1),a=await Se(r),s=this.func(ee(r,{callbacks:a}),e);return We(s,r?.signal)}async*_streamIterator(e,t){const[r]=this._getOptionsList(t??{},1),a=await this.invoke(e,t);if(fn(a)){for await(const s of a)r?.signal?.throwIfAborted(),yield s;return}if(kh(a)){for(;;){r?.signal?.throwIfAborted();const s=a.next();if(s.done)break;yield s.value}return}yield a}static from(e){return new Pn({func:e})}}function $h(n){if($n(n))throw new Error("RunnableLambda requires a function that is not wrapped in traceable higher-order function. This shouldn't happen.")}class xr extends ae{static lc_name(){return"RunnableLambda"}constructor(e){if($n(e.func))return Pn.from(e.func);super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"func",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),$h(e.func),this.func=e.func}static from(e){return new xr({func:e})}async _invoke(e,t,r){return new Promise((a,s)=>{const i=ee(t,{callbacks:r?.getChild(),recursionLimit:(t?.recursionLimit??Xr)-1});qe.runWithConfig(gt(i),async()=>{try{let o=await this.func(e,{...i});if(o&&ae.isRunnable(o)){if(t?.recursionLimit===0)throw new Error("Recursion limit reached.");o=await o.invoke(e,{...i,recursionLimit:(i.recursionLimit??Xr)-1})}else if(fn(o)){let u;for await(const c of pn(i,o))if(t?.signal?.throwIfAborted(),u===void 0)u=c;else try{u=Le(u,c)}catch{u=c}o=u}else if($a(o)){let u;for(const c of Aa(i,o))if(t?.signal?.throwIfAborted(),u===void 0)u=c;else try{u=Le(u,c)}catch{u=c}o=u}a(o)}catch(o){s(o)}})})}async invoke(e,t){return this._callWithConfig(this._invoke.bind(this),e,t)}async*_transform(e,t,r){let a;for await(const o of e)if(a===void 0)a=o;else try{a=Le(a,o)}catch{a=o}const s=ee(r,{callbacks:t?.getChild(),recursionLimit:(r?.recursionLimit??Xr)-1}),i=await new Promise((o,u)=>{qe.runWithConfig(gt(s),async()=>{try{const c=await this.func(a,{...s,config:s});o(c)}catch(c){u(c)}})});if(i&&ae.isRunnable(i)){if(r?.recursionLimit===0)throw new Error("Recursion limit reached.");const o=await i.stream(a,s);for await(const u of o)yield u}else if(fn(i))for await(const o of pn(s,i))r?.signal?.throwIfAborted(),yield o;else if($a(i))for(const o of Aa(s,i))r?.signal?.throwIfAborted(),yield o;else yield i}transform(e,t){return this._transformStreamWithConfig(e,this._transform.bind(this),t)}async stream(e,t){async function*r(){yield e}const a=V(t),s=new _t({generator:this.transform(r(),a),config:a});return await s.setup,fe.fromAsyncGenerator(s)}}class Ah extends ae{static lc_name(){return"RunnableWithFallbacks"}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"runnable",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"fallbacks",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.runnable=e.runnable,this.fallbacks=e.fallbacks}*runnables(){yield this.runnable;for(const e of this.fallbacks)yield e}async invoke(e,t){const r=V(t),a=await Se(r),{runId:s,...i}=r,o=await a?.handleChainStart(this.toJSON(),Q(e,"input"),s,void 0,void 0,void 0,i?.runName),u=ee(i,{callbacks:o?.getChild()});return await qe.runWithConfig(u,async()=>{let l;for(const d of this.runnables()){r?.signal?.throwIfAborted();try{const h=await d.invoke(e,u);return await o?.handleChainEnd(Q(h,"output")),h}catch(h){l===void 0&&(l=h)}}throw l===void 0?new Error("No error stored at end of fallback."):(await o?.handleChainError(l),l)})}async*_streamIterator(e,t){const r=V(t),a=await Se(r),{runId:s,...i}=r,o=await a?.handleChainStart(this.toJSON(),Q(e,"input"),s,void 0,void 0,void 0,i?.runName);let u,c;for(const d of this.runnables()){r?.signal?.throwIfAborted();const h=ee(i,{callbacks:o?.getChild()});try{const f=await d.stream(e,h);c=pn(h,f);break}catch(f){u===void 0&&(u=f)}}if(c===void 0){const d=u??new Error("No error stored at end of fallback.");throw await o?.handleChainError(d),d}let l;try{for await(const d of c){yield d;try{l=l===void 0?l:Le(l,d)}catch{l=void 0}}}catch(d){throw await o?.handleChainError(d),d}await o?.handleChainEnd(Q(l,"output"))}async batch(e,t,r){if(r?.returnExceptions)throw new Error("Not implemented.");const a=this._getOptionsList(t??{},e.length),s=await Promise.all(a.map(u=>Se(u))),i=await Promise.all(s.map(async(u,c)=>{const l=await u?.handleChainStart(this.toJSON(),Q(e[c],"input"),a[c].runId,void 0,void 0,void 0,a[c].runName);return delete a[c].runId,l}));let o;for(const u of this.runnables()){a[0].signal?.throwIfAborted();try{const c=await u.batch(e,i.map((l,d)=>ee(a[d],{callbacks:l?.getChild()})),r);return await Promise.all(i.map((l,d)=>l?.handleChainEnd(Q(c[d],"output")))),c}catch(c){o===void 0&&(o=c)}}throw o?(await Promise.all(i.map(u=>u?.handleChainError(o))),o):new Error("No error stored at end of fallbacks.")}}function Ke(n){if(typeof n=="function")return new xr({func:n});if(ae.isRunnable(n))return n;if(!Array.isArray(n)&&typeof n=="object"){const e={};for(const[t,r]of Object.entries(n))e[t]=Ke(r);return new Jt({steps:e})}else throw new Error(`Expected a Runnable, function or object.
Instead got an unsupported type.`)}class Rh extends ae{static lc_name(){return"RunnableAssign"}constructor(e){e instanceof Jt&&(e={mapper:e}),super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"mapper",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.mapper=e.mapper}async invoke(e,t){const r=await this.mapper.invoke(e,t);return{...e,...r}}async*_transform(e,t,r){const a=this.mapper.getStepsKeys(),[s,i]=gs(e),o=this.mapper.transform(i,ee(r,{callbacks:t?.getChild()})),u=o.next();for await(const c of s){if(typeof c!="object"||Array.isArray(c))throw new Error(`RunnableAssign can only be used with objects as input, got ${typeof c}`);const l=Object.fromEntries(Object.entries(c).filter(([d])=>!a.includes(d)));Object.keys(l).length>0&&(yield l)}yield(await u).value;for await(const c of o)yield c}transform(e,t){return this._transformStreamWithConfig(e,this._transform.bind(this),t)}async stream(e,t){async function*r(){yield e}const a=V(t),s=new _t({generator:this.transform(r(),a),config:a});return await s.setup,fe.fromAsyncGenerator(s)}}class xh extends ae{static lc_name(){return"RunnablePick"}constructor(e){(typeof e=="string"||Array.isArray(e))&&(e={keys:e}),super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"keys",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.keys=e.keys}async _pick(e){if(typeof this.keys=="string")return e[this.keys];{const t=this.keys.map(r=>[r,e[r]]).filter(r=>r[1]!==void 0);return t.length===0?void 0:Object.fromEntries(t)}}async invoke(e,t){return this._callWithConfig(this._pick.bind(this),e,t)}async*_transform(e){for await(const t of e){const r=await this._pick(t);r!==void 0&&(yield r)}}transform(e,t){return this._transformStreamWithConfig(e,this._transform.bind(this),t)}async stream(e,t){async function*r(){yield e}const a=V(t),s=new _t({generator:this.transform(r(),a),config:a});return await s.setup,fe.fromAsyncGenerator(s)}}class Ra extends Qe{constructor(e){const t=Xe.from([xr.from(async r=>{let a;if(rd(r))try{a=await this.schema.parseAsync(r.args)}catch{throw new nd("Received tool input did not match expected schema",JSON.stringify(r.args))}else a=r;return a}).withConfig({runName:`${e.name}:parse_input`}),e.bound]).withConfig({runName:e.name});super({bound:t,config:e.config??{}}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"description",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"schema",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.name=e.name,this.description=e.description,this.schema=e.schema}static lc_name(){return"RunnableToolLike"}}function Ch(n,e){const t=e.name??n.getName(),r=e.description??e.schema?.description;return e.schema.constructor===Tt.ZodString?new Ra({name:t,description:r,schema:Tt.object({input:Tt.string()}).transform(a=>a.input),bound:n}):new Ra({name:t,description:r,schema:e.schema,bound:n})}class Ph extends ae{constructor(){super(...arguments),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","documents","transformers"]})}invoke(e,t){return this.transformDocuments(e)}}var Cr={};Cr.byteLength=Lh;Cr.toByteArray=Dh;Cr.fromByteArray=Bh;var Ae=[],ge=[],Nh=typeof Uint8Array<"u"?Uint8Array:Array,en="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";for(var st=0,jh=en.length;st<jh;++st)Ae[st]=en[st],ge[en.charCodeAt(st)]=st;ge[45]=62;ge[95]=63;function Os(n){var e=n.length;if(e%4>0)throw new Error("Invalid string. Length must be a multiple of 4");var t=n.indexOf("=");t===-1&&(t=e);var r=t===e?0:4-t%4;return[t,r]}function Lh(n){var e=Os(n),t=e[0],r=e[1];return(t+r)*3/4-r}function Mh(n,e,t){return(e+t)*3/4-t}function Dh(n){var e,t=Os(n),r=t[0],a=t[1],s=new Nh(Mh(n,r,a)),i=0,o=a>0?r-4:r,u;for(u=0;u<o;u+=4)e=ge[n.charCodeAt(u)]<<18|ge[n.charCodeAt(u+1)]<<12|ge[n.charCodeAt(u+2)]<<6|ge[n.charCodeAt(u+3)],s[i++]=e>>16&255,s[i++]=e>>8&255,s[i++]=e&255;return a===2&&(e=ge[n.charCodeAt(u)]<<2|ge[n.charCodeAt(u+1)]>>4,s[i++]=e&255),a===1&&(e=ge[n.charCodeAt(u)]<<10|ge[n.charCodeAt(u+1)]<<4|ge[n.charCodeAt(u+2)]>>2,s[i++]=e>>8&255,s[i++]=e&255),s}function Fh(n){return Ae[n>>18&63]+Ae[n>>12&63]+Ae[n>>6&63]+Ae[n&63]}function Uh(n,e,t){for(var r,a=[],s=e;s<t;s+=3)r=(n[s]<<16&16711680)+(n[s+1]<<8&65280)+(n[s+2]&255),a.push(Fh(r));return a.join("")}function Bh(n){for(var e,t=n.length,r=t%3,a=[],s=16383,i=0,o=t-r;i<o;i+=s)a.push(Uh(n,i,i+s>o?o:i+s));return r===1?(e=n[t-1],a.push(Ae[e>>2]+Ae[e<<4&63]+"==")):r===2&&(e=(n[t-2]<<8)+n[t-1],a.push(Ae[e>>10]+Ae[e>>4&63]+Ae[e<<2&63]+"=")),a.join("")}var Zh=Object.defineProperty,Hh=(n,e,t)=>e in n?Zh(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t,Gh=(n,e,t)=>(Hh(n,e+"",t),t);function zh(n,e){let t=Array.from({length:n.length},(r,a)=>({start:a,end:a+1}));for(;t.length>1;){let r=null;for(let a=0;a<t.length-1;a++){const s=n.slice(t[a].start,t[a+1].end),i=e.get(s.join(","));i!=null&&(r==null||i<r[0])&&(r=[i,a])}if(r!=null){const a=r[1];t[a]={start:t[a].start,end:t[a+1].end},t.splice(a+1,1)}else break}return t}function Vh(n,e){return n.length===1?[e.get(n.join(","))]:zh(n,e).map(t=>e.get(n.slice(t.start,t.end).join(","))).filter(t=>t!=null)}function qh(n){return n.replace(/[\\^$*+?.()|[\]{}]/g,"\\$&")}var mn=class{specialTokens;inverseSpecialTokens;patStr;textEncoder=new TextEncoder;textDecoder=new TextDecoder("utf-8");rankMap=new Map;textMap=new Map;constructor(n,e){this.patStr=n.pat_str;const t=n.bpe_ranks.split(`
`).filter(Boolean).reduce((r,a)=>{const[s,i,...o]=a.split(" "),u=Number.parseInt(i,10);return o.forEach((c,l)=>r[c]=u+l),r},{});for(const[r,a]of Object.entries(t)){const s=Cr.toByteArray(r);this.rankMap.set(s.join(","),a),this.textMap.set(a,s)}this.specialTokens={...n.special_tokens,...e},this.inverseSpecialTokens=Object.entries(this.specialTokens).reduce((r,[a,s])=>(r[s]=this.textEncoder.encode(a),r),{})}encode(n,e=[],t="all"){const r=new RegExp(this.patStr,"ug"),a=mn.specialTokenRegex(Object.keys(this.specialTokens)),s=[],i=new Set(e==="all"?Object.keys(this.specialTokens):e),o=new Set(t==="all"?Object.keys(this.specialTokens).filter(c=>!i.has(c)):t);if(o.size>0){const c=mn.specialTokenRegex([...o]),l=n.match(c);if(l!=null)throw new Error(`The text contains a special token that is not allowed: ${l[0]}`)}let u=0;for(;;){let c=null,l=u;for(;a.lastIndex=l,c=a.exec(n),!(c==null||i.has(c[0]));)l=c.index+1;const d=c?.index??n.length;for(const f of n.substring(u,d).matchAll(r)){const p=this.textEncoder.encode(f[0]),S=this.rankMap.get(p.join(","));if(S!=null){s.push(S);continue}s.push(...Vh(p,this.rankMap))}if(c==null)break;let h=this.specialTokens[c[0]];s.push(h),u=c.index+c[0].length}return s}decode(n){const e=[];let t=0;for(let s=0;s<n.length;++s){const i=n[s],o=this.textMap.get(i)??this.inverseSpecialTokens[i];o!=null&&(e.push(o),t+=o.length)}const r=new Uint8Array(t);let a=0;for(const s of e)r.set(s,a),a+=s.length;return this.textDecoder.decode(r)}},Wh=mn;Gh(Wh,"specialTokenRegex",n=>new RegExp(n.map(e=>qh(e)).join("|"),"g"));class Jh extends Ph{constructor(e){if(super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain","document_transformers","text_splitters"]}),Object.defineProperty(this,"chunkSize",{enumerable:!0,configurable:!0,writable:!0,value:1e3}),Object.defineProperty(this,"chunkOverlap",{enumerable:!0,configurable:!0,writable:!0,value:200}),Object.defineProperty(this,"keepSeparator",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"lengthFunction",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.chunkSize=e?.chunkSize??this.chunkSize,this.chunkOverlap=e?.chunkOverlap??this.chunkOverlap,this.keepSeparator=e?.keepSeparator??this.keepSeparator,this.lengthFunction=e?.lengthFunction??(t=>t.length),this.chunkOverlap>=this.chunkSize)throw new Error("Cannot have chunkOverlap >= chunkSize")}async transformDocuments(e,t={}){return this.splitDocuments(e,t)}splitOnSeparator(e,t){let r;if(t)if(this.keepSeparator){const a=t.replace(/[/\-\\^$*+?.()|[\]{}]/g,"\\$&");r=e.split(new RegExp(`(?=${a})`))}else r=e.split(t);else r=e.split("");return r.filter(a=>a!=="")}async createDocuments(e,t=[],r={}){const a=t.length>0?t:[...Array(e.length)].map(()=>({})),{chunkHeader:s="",chunkOverlapHeader:i="(cont'd) ",appendChunkOverlapHeader:o=!1}=r,u=new Array;for(let c=0;c<e.length;c+=1){const l=e[c];let d=1,h=null,f=-1;for(const p of await this.splitText(l)){let S=s;const m=l.indexOf(p,f+1);if(h===null){const U=this.numberOfNewLines(l,0,m);d+=U}else{const U=f+await this.lengthFunction(h);if(U<m){const A=this.numberOfNewLines(l,U,m);d+=A}else if(U>m){const A=this.numberOfNewLines(l,m,U);d-=A}o&&(S+=i)}const _=this.numberOfNewLines(p),P=a[c].loc&&typeof a[c].loc=="object"?{...a[c].loc}:{};P.lines={from:d,to:d+_};const b={...a[c],loc:P};S+=p,u.push(new $s({pageContent:S,metadata:b})),d+=_,h=p,f=m}}return u}numberOfNewLines(e,t,r){return(e.slice(t,r).match(/\n/g)||[]).length}async splitDocuments(e,t={}){const r=e.filter(i=>i.pageContent!==void 0),a=r.map(i=>i.pageContent),s=r.map(i=>i.metadata);return this.createDocuments(a,s,t)}joinDocs(e,t){const r=e.join(t).trim();return r===""?null:r}async mergeSplits(e,t){const r=[],a=[];let s=0;for(const o of e){const u=await this.lengthFunction(o);if(s+u+a.length*t.length>this.chunkSize&&(s>this.chunkSize&&console.warn(`Created a chunk of size ${s}, +
which is longer than the specified ${this.chunkSize}`),a.length>0)){const c=this.joinDocs(a,t);for(c!==null&&r.push(c);s>this.chunkOverlap||s+u+a.length*t.length>this.chunkSize&&s>0;)s-=await this.lengthFunction(a[0]),a.shift()}a.push(o),s+=u}const i=this.joinDocs(a,t);return i!==null&&r.push(i),r}}class ef extends Jh{static lc_name(){return"CharacterTextSplitter"}constructor(e){super(e),Object.defineProperty(this,"separator",{enumerable:!0,configurable:!0,writable:!0,value:`

`}),this.separator=e?.separator??this.separator}async splitText(e){const t=this.splitOnSeparator(e,this.separator);return this.mergeSplits(t,this.keepSeparator?"":this.separator)}}export{ef as C};
