import{d as E,g as L,v as y,x as S,y as a,K as h,Q as d,S as v,z as W,r as f,o as O,ab as U,ac as P,h as M,ad as j,Z as R,a as Q,ae as K,J as Z,af as k,ag as X,A as b,L as p,i as B,V as A,W as Y,aa as q,O as _}from"./JqZd4KxG.js";import{u as g}from"./D-sMymdb.js";import{v as D}from"./DvF23Exx.js";const ee={class:"w-5 flex justify-center items-center py-1"},te={key:0},se=E({__name:"item-logo",props:{itemType:{type:String,default:"flow"},size:{type:String,default:"flow"},rounded:{type:Boolean,default:!1}},setup(e){return(t,i)=>{const s=L("font-awesome-icon");return y(),S("div",{class:d(["text-white font-bold flex justify-center items-center",[e.size==="small"?"text-xs ":"px-2",e.rounded?"rounded-md":"",e.itemType==="flow"?"bg-blue-600":"",e.itemType==="api"?"bg-red-600":"",e.itemType==="condition"?"bg-orange-600":"",e.itemType==="loop"?"bg-sky-600":"",e.itemType==="script"?"bg-purple-600":"",e.itemType==="end"?"bg-yellow-600":"",e.itemType==="wait"?"bg-lime-600":""]])},[a("div",ee,[e.itemType==="flow"?(y(),h(s,{key:0,icon:["fas","wind"],class:d(e.size==="small"?"":"mr-2")},null,8,["class"])):v("",!0),e.itemType==="api"?(y(),h(s,{key:1,icon:["fas","circle-nodes"],class:d(e.size==="small"?"":"mr-2")},null,8,["class"])):v("",!0),e.itemType==="condition"?(y(),h(s,{key:2,icon:["fas","diagram-project"],class:d(e.size==="small"?"":"mr-2")},null,8,["class"])):v("",!0),e.itemType==="loop"?(y(),h(s,{key:3,icon:["fas","arrows-spin"],class:d(e.size==="small"?"":"mr-2")},null,8,["class"])):v("",!0),e.itemType==="end"?(y(),h(s,{key:4,icon:["fas","flag-checkered"],class:d(e.size==="small"?"":"mr-2")},null,8,["class"])):v("",!0),e.itemType==="script"?(y(),h(s,{key:5,icon:["fas","code"],class:d(e.size==="small"?"":"mr-2")},null,8,["class"])):v("",!0),e.itemType==="wait"?(y(),h(s,{key:6,icon:["far","clock"],class:d(e.size==="small"?"":"mr-2")},null,8,["class"])):v("",!0)]),e.size!=="small"?(y(),S("p",te,W(e.itemType),1)):v("",!0)],2)}}}),ie=Symbol.for("nuxt:client-only"),ke=E({name:"ClientOnly",inheritAttrs:!1,props:["fallback","placeholder","placeholderTag","fallbackTag"],setup(e,{slots:t,attrs:i}){const s=f(!1);return O(()=>{s.value=!0}),U(ie,!0),c=>{if(s.value)return t.default?.();const l=t.fallback||t.placeholder;if(l)return l();const n=c.fallback||c.placeholder||"",o=c.fallbackTag||c.placeholderTag||"span";return S(o,i,n)}}}),$=new WeakMap;function Ee(e){if($.has(e))return $.get(e);const t={...e};return t.render?t.render=(i,s,c,l,n,o)=>{if(l.mounted$??i.mounted$){const r=e.render?.bind(i)(i,s,c,l,n,o);return r.children===null||typeof r.children=="string"?P(r):M(r)}else{const r=j(i._.vnode.el??null)??["<div></div>"];return R(r.join(""),r.length)}}:t.template&&(t.template=`
      <template v-if="mounted$">${e.template}</template>
      <template v-else><div></div></template>
    `),t.setup=(i,s)=>{const c=Q(),l=f(c.isHydrating===!1),n=Z();if(c.isHydrating){const r={...n.attrs},u=oe(n);for(const m in r)delete n.attrs[m];O(()=>{Object.assign(n.attrs,r),n.vnode.dirs=u})}O(()=>{l.value=!0});const o=e.setup?.(i,s)||{};return K(o)?Promise.resolve(o).then(r=>typeof r!="function"?(r=r||{},r.mounted$=l,r):(...u)=>{if(l.value||!c.isHydrating){const m=r(...u);return m.children===null||typeof m.children=="string"?P(m):M(m)}else{const m=j(n?.vnode.el??null)??["<div></div>"];return R(m.join(""),m.length)}}):typeof o=="function"?(...r)=>{if(l.value)return M(o(...r),s.attrs);const u=j(n?.vnode.el??null)??["<div></div>"];return R(u.join(""),u.length)}:Object.assign(o,{mounted$:l})},$.set(e,t),t}function oe(e){if(!e||!e.vnode.dirs)return null;const t=e.vnode.dirs;return e.vnode.dirs=null,t}const w=k("uiStore",{state:()=>({editMode:{},itemDisplayMode:{},methodColor:{GET:"#21ad7a",POST:"#f75c2f",DELETE:"#2f50f7",PUT:"#f72ff0"},focusedItemId:"",executionResults:{},isExecutedFlow:{},sideMenuStatus:"Flow List",viewMode:"Laboratory",isGenerating:{}}),actions:{getEditModeStatus(e){return this.editMode[e]||(this.editMode[e]="form"),this.editMode[e]},setEditModeStatus(e,t){this.editMode[e]=t},getItemDisplayMode(e){return this.itemDisplayMode[e.id]||this.setItemDisplayMode(e,"default"),this.itemDisplayMode[e.id]},setItemDisplayMode(e,t){this.itemDisplayMode[e.id]=t,e.flowItems.length>0&&e.flowItems.forEach(i=>{this.setItemDisplayMode(i,t)})},setFocusedItemId(e){this.focusedItemId=e},getExecutionResults(e){return this.executionResults[e]||(this.executionResults[e]=[]),this.executionResults[e]},setExecutionResults(e,t){this.executionResults[e].push(t)},getIsExecutedFlow(e){return this.isExecutedFlow[e]||(this.isExecutedFlow[e]="Not yet"),this.isExecutedFlow[e]},setIsExecutedFlow(e,t){this.isExecutedFlow[e]=t},clearIsExecutedFlow(){this.isExecutedFlow={}},getSideMenuStatus(){return this.sideMenuStatus},setSideMenuStatus(e){this.sideMenuStatus=e},getViewMode(){return this.viewMode},setViewMode(e){this.viewMode=e},getIsGenerating(e){return this.isGenerating[e]||(this.isGenerating[e]=!1),this.isGenerating[e]},setIsGenerating(e,t){this.isGenerating[e]=t}}}),le=k("loopStore",{state:()=>({}),actions:{addLoopItem(e,t={id:"",name:"",type:"loop",description:"",isItemActive:!0,variables:{},executionResults:[],flowItems:[],loopType:"while",condition:{id:D(),leftSide:{value:"",valueType:"string"},comparisonOperator:"=",rightSide:{value:"",valueType:"string"}}}){g().addFlowItem(e,t)}}}),ne=k("scriptStore",{state:()=>({}),actions:{addScriptItem(e,t={id:"",name:"",type:"script",description:"",isItemActive:!0,variables:{},executionResults:[],flowItems:[],script:""}){g().addFlowItem(e,t)}}}),re=k("endStore",{state:()=>({}),actions:{addEndItem(e,t={id:"",name:"",type:"end",description:"",isItemActive:!0,variables:{},executionResults:[],flowItems:[]}){g().addFlowItem(e,t)}}}),ae=k("waitStore",{state:()=>({}),actions:{addEndItem(e,t={id:"",name:"",type:"wait",description:"",isItemActive:!0,variables:{},executionResults:[],flowItems:[],waitTime:0}){g().addFlowItem(e,t)}}});function C(e,t="object"){let i=[];for(const s of Object.keys(e))z(e[s])==="array"?i.push({key:s,type:"array",value:null,children:C(e[s],"array")}):z(e[s])==="object"?t==="array"?e[s]?i.push({type:"object",value:null,children:C(e[s],"array")}):i.push({key:s,type:"object",value:null,children:[]}):e[s]?i.push({key:s,type:"object",value:null,children:C(e[s])}):i.push({key:s,type:"object",value:null,children:[]}):i.push({key:s,type:z(e[s]),value:e[s]});return i}function z(e){return Array.isArray(e)?"array":e===null?"object":typeof e}function F(e,t="object"){let i={};t==="array"&&(Array.isArray(i)||(i=[]));for(const s of e)s.key?s.children?t==="array"?i.push({[s.key]:F(s.children,s.type)}):s.children.length>0?i[s.key]=F(s.children,s.type):i[s.key]=null:t==="array"?i.push({[s.key]:s.value}):i[s.key]=s.value:s.children?s.children.length>0?i.push(F(s.children,s.type)):i=null:t==="array"?i.push(s.value):i=s.value;return i}async function ce(e){console.log("apiItem",e);try{const t=await fetch("/api/execute-flow",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({apiItem:e})});if(!t.ok)throw new Error(`Network response was not ok: ${t.statusText}`);return{result:await t.json(),error:""}}catch(t){return{result:{},error:t.message}}}function ue(e,t,i){try{const s=new Function("variables","result",e.script);e.isScriptEnabled&&s(t,i)}catch(s){console.error("スクリプト実行エラー:",s)}}function de(e,t){try{new Function("variables",e.script)(t)}catch(i){console.error("スクリプト実行エラー:",i)}}async function fe(e,t){const i=new TextDecoder("utf-8");let s="";for(;;){const{done:c,value:l}=await e.read();if(c)break;s+=i.decode(l,{stream:!0});let n=s.split(`
`);s=n.pop()||"";for(const o of n)if(o.trim()){const r=JSON.parse(o);t(r)}}}const ye=k("APIExecution",{state:()=>({isExecuting:!1,latestExecutedFlowItemId:""}),actions:{async executeStep(e){return ce(e)},executeScriptApiItem(e){const t=g(),i=w();ue(e,t.masterFlow.variables,i.executionResults[e.id].slice(-1)[0])},executeScript(e){const t=g();de(e,t.masterFlow.variables)},transformEntriesArray(e,t="object"){return C(e,t)},reverseTransformToRequestParameterArray(e,t="object"){return F(e,t)},async runFlow(e){const t=w();this.isExecuting=!0;try{t.clearIsExecutedFlow(),await this.callApi(e),t.executionResults[e.id]}catch(i){console.error(i)}finally{this.isExecuting=!1}},controller:null,async callApiByServer(e){const t=g(),i=w();this.controller=new AbortController;try{const s=await fetch("/api/execute/stream",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({flowItem:e,variables:t.masterFlow.variables}),signal:this.controller.signal});if(!s.body)throw new Error("No response body");const c=s.body.getReader();await fe(c,l=>{console.log("Received:",l),l.executionResult&&i.setExecutionResults(l.id,l.executionResult),l.variables&&(t.masterFlow.variables=l.variables),l.status&&(i.setIsExecutedFlow(l.id,l.status),this.latestExecutedFlowItemId=l.id)}),this.isExecuting=!1}catch(s){console.error("Streaming error:",s),this.isExecuting=!1}},stopFlowByServer(){const e=w();this.controller&&(this.controller.abort(),e.setIsExecutedFlow(this.latestExecutedFlowItemId,"Done"),this.isExecuting=!1)},async callApi(e){const t=g(),i=w(),s=l=>new Promise(n=>setTimeout(n,l)),c=Date.now();if(e.isItemActive&&this.isExecuting){i.setIsExecutedFlow(e.id,"In progress");try{if((e.type==="condition"||e.type==="loop")&&!t.evaluateCondition(e.condition)){i.setIsExecutedFlow(e.id,"Done");return}if(e.type==="api"){let l=JSON.parse(JSON.stringify(e));l.headers=t.applyFlowVariables(this.reverseTransformToRequestParameterArray(e.headers),e),l.endpoint=t.applyFlowVariablesOnString(e.endpoint,e),l.body=t.applyFlowVariables(this.reverseTransformToRequestParameterArray(e.body),e),console.log(l);const n=await this.executeStep(l);if(n&&n.result){const o={id:D(),success:n.result.success,data:n.result.data?n.result.data:{},error:n.result.error?n.result.error:null,executionDate:c,duration:Date.now()-c};i.setExecutionResults(e.id,o),this.executeScriptApiItem(e)}if(console.log("result : "),console.log(n),console.log(n.result.success),!n.result.success)throw X().addMessage("error",`ステップ ${e.name?e.name:"Untitled"} でエラーが発生しました: ${n.error}`),new Error(`ステップ ${e.name?e.name:"Untitled"} でエラーが発生しました: ${n.error}`)}if(e.type==="script"&&this.executeScript(e),e.flowItems.length>0)for(const l of e.flowItems)await this.callApi(l);e.type==="loop"&&(console.log("flowItem.loopType === 'while' && flowStore.evaluateCondition(flowItem.condition) : ",e.loopType==="while"&&t.evaluateCondition(e.condition)),e.loopType==="while"&&t.evaluateCondition(e.condition)&&(await s(200),await this.callApi(JSON.parse(JSON.stringify(e))))),e.type==="end"&&(this.isExecuting=!1),e.type==="wait"&&await s(e.waitTime),i.setIsExecutedFlow(e.id,"Done")}catch(l){throw console.log("error : "+l.message),i.setIsExecutedFlow(e.id,"Done"),l}}},stopFlow(){this.isExecuting=!1}}}),me={class:"flex flex-col items-center justify-center w-full"},Te=E({__name:"add-item-menu",props:{flowItem:{type:Object,required:!0}},setup(e){const t=g();w();const i=le(),s=ne(),c=re(),l=ae();return ye(),(n,o)=>{const r=se;return y(),S("div",me,[a("button",{onClick:o[0]||(o[0]=u=>p(t).addFlowItem(e.flowItem.flowItems)),class:"rounded-sm px-2 hover:bg-black hover:bg-opacity-10 w-full flex items-center justify-start py-1"},[b(r,{"item-type":"flow",size:"small",rounded:!0}),o[7]||(o[7]=a("p",{class:"ml-2"}," Flow ",-1))]),a("button",{onClick:o[1]||(o[1]=u=>p(t).addApiItem(e.flowItem.flowItems)),class:"rounded-sm px-2 hover:bg-black hover:bg-opacity-10 w-full flex items-center justify-start py-1"},[b(r,{"item-type":"api",size:"small",rounded:!0}),o[8]||(o[8]=a("p",{class:"ml-2"}," APIリクエスト ",-1))]),a("button",{onClick:o[2]||(o[2]=u=>p(t).addConditionItem(e.flowItem.flowItems)),class:"rounded-sm px-2 hover:bg-black hover:bg-opacity-10 w-full flex items-center justify-start py-1"},[b(r,{"item-type":"condition",size:"small",rounded:!0}),o[9]||(o[9]=a("p",{class:"ml-2"}," 条件 ",-1))]),a("button",{onClick:o[3]||(o[3]=u=>p(i).addLoopItem(e.flowItem.flowItems)),class:"rounded-sm px-2 hover:bg-black hover:bg-opacity-10 w-full flex items-center justify-start py-1"},[b(r,{"item-type":"loop",size:"small",rounded:!0}),o[10]||(o[10]=a("p",{class:"ml-2"}," ループ ",-1))]),a("button",{onClick:o[4]||(o[4]=u=>p(s).addScriptItem(e.flowItem.flowItems)),class:"rounded-sm px-2 hover:bg-black hover:bg-opacity-10 w-full flex items-center justify-start py-1"},[b(r,{"item-type":"script",size:"small",rounded:!0}),o[11]||(o[11]=a("p",{class:"ml-2"}," スクリプト ",-1))]),a("button",{onClick:o[5]||(o[5]=u=>p(c).addEndItem(e.flowItem.flowItems)),class:"rounded-sm px-2 hover:bg-black hover:bg-opacity-10 w-full flex items-center justify-start py-1"},[b(r,{"item-type":"end",size:"small",rounded:!0}),o[12]||(o[12]=a("p",{class:"ml-2"}," 終了 ",-1))]),a("button",{onClick:o[6]||(o[6]=u=>p(l).addEndItem(e.flowItem.flowItems)),class:"rounded-sm px-2 hover:bg-black hover:bg-opacity-10 w-full flex items-center justify-start py-1"},[b(r,{"item-type":"wait",size:"small",rounded:!0}),o[13]||(o[13]=a("p",{class:"ml-2"}," 待機 ",-1))])])}}}),Ce=E({__name:"modal-button",props:{modalPossition:{type:String,default:"bottom"},modalPossitionHorizonal:{type:String,default:"left"},bgColor:{type:String,default:"white"},bgOpacity:{type:String,default:"100"},buttonColor:{type:String,default:"[#842ff7]"},borderThickness:{type:String,default:null},borderColor:{type:String,default:null},closeOnClick:{type:Boolean,default:!0}},setup(e,{expose:t}){const i=e,s=f(null),c=f(null),l=f(null),n=f(!1),o=()=>{n.value=!n.value},r=()=>{i.closeOnClick&&(n.value=!n.value)},u=f(0),m=f(0);f(0);const I=f(0),N=f(0),V=f(0),H=()=>{try{const x=s.value.getBoundingClientRect(),T=l.value.getBoundingClientRect();N.value=c.value?.clientHeight,V.value=c.value?.clientWidth,u.value=x.top,m.value=x.left,I.value=T.right}catch(x){console.error(x)}},G=B(()=>{if(i.modalPossition==="bottom")return u.value;if(i.modalPossition==="top")return u.value-N.value}),J=B(()=>{if(i.modalPossitionHorizonal==="left")return m.value;if(i.modalPossitionHorizonal==="right"&&I.value)return I.value-V.value});return t({changeVisibility:o}),(x,T)=>(y(),S("div",{class:d(["flex items-start justify-center w-fit",e.modalPossition==="bottom"?"flex-col":"flex-col-reverse"])},[a("div",{onClick:T[0]||(T[0]=be=>{o(),H()}),class:"",ref_key:"button",ref:l},[A(x.$slots,"button")],512),a("div",{class:d([p(n)?"":"opacity-0 pointer-events-none","relative transition-all duration-200"]),ref_key:"element",ref:s},[a("div",{class:"fixed left-0 top-0 items-center w-full h-full z-10",onClick:o}),a("div",{class:d(["p-1 rounded-md overflow-hidden shadow-[1px_1px_3px_0px_rgb(0,0,0,0.1)] z-20","bg-"+e.bgColor+" bg-opacity-"+e.bgOpacity+" border-"+e.borderThickness+" border-"+e.borderColor]),style:Y({top:p(G)+"px",left:p(J)+"px",position:"fixed"}),onClick:r},[a("div",{class:"flex flex-col",ref_key:"content",ref:c},[A(x.$slots,"modal")],512)],6)],2)],2))}}),pe={class:"flex flex-col z-20 items-center justify-center h-full w-full"},ge={class:"flex flex-col w-full"},ve={class:"flex justify-end w-full"},he={class:"relative flex flex-col items-center justify-center pb-5 px-5 md:px-5 transition-all duration-300"},Fe=E({__name:"modal-window",props:{bgColor:{type:String,default:"white"},bgOpacity:{type:String,default:"100"},buttonColor:{type:String,default:"red-500"},borderThickness:{type:String,default:null},borderColor:{type:String,default:null}},setup(e,{expose:t}){const i=f(!1),s=()=>{i.value=!i.value};return t({changeVisibility:s}),(c,l)=>{const n=L("font-awesome-icon");return y(),S(_,null,[a("div",{onClick:s},[A(c.$slots,"button")]),(y(),h(q,{to:"body"},[a("div",{class:d([p(i)?"":"opacity-0 pointer-events-none","fixed left-0 top-0 w-full h-full transition-all duration-300 z-50"])},[a("div",{class:"absolute left-0 top-0 items-center w-full h-full bg-gray-500 bg-opacity-50 transition-all duration-300",onClick:s}),a("div",pe,[a("div",{class:d(["bg-"+e.bgColor+" bg-opacity-"+e.bgOpacity+" border-"+e.borderThickness+" border-"+e.borderColor,"flex flex-col items-center justify-center drop-shadow-lg rounded-lg md:max-h-screen transition-all duration-300 overflow-auto"])},[a("div",ge,[a("div",ve,[b(n,{class:d(["m-2 hover:opacity-50 transition-all duration-300 cursor-pointer","text-"+e.buttonColor]),icon:["fas","xmark"],onClick:s},null,8,["class"])]),a("div",he,[A(c.$slots,"modal")])])],2)])],2)]))],64)}}});export{se as _,ke as a,Te as b,Ce as c,ye as d,Ee as e,Fe as f,le as g,w as u};
